<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ä–µƒß–∞ 2024 - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f8f9fa, #e9ecef); min-height: 100vh; padding: 20px; color: #212529; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); overflow: hidden; border: 2px solid #dee2e6; }
        .header { background: linear-gradient(135deg, #212529, #343a40); color: white; padding: 30px; display: flex; align-items: center; gap: 20px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; font-weight: 700; }
        .header p { opacity: 0.9; font-size: 16px; }
        .logo { width: 80px; height: 80px; background: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: #212529; }
        .nav-tabs { display: flex; background: #f8f9fa; border-bottom: 3px solid #dee2e6; }
        .nav-tab { flex: 1; padding: 20px; text-align: center; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: 600; color: #495057; transition: all 0.3s ease; }
        .nav-tab.active { background: white; color: #212529; border-bottom: 3px solid #212529; }
        .nav-tab:hover:not(.active) { background: #e9ecef; }
        .tab-content { display: none; padding: 30px; min-height: 600px; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #212529; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #212529; box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1); }
        .btn { padding: 12px 24px; border: 2px solid transparent; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-right: 10px; margin-bottom: 10px; text-transform: uppercase; }
        .btn-primary { background: #212529; color: white; border-color: #212529; }
        .btn-primary:hover { background: #343a40; }
        .btn-success { background: #6c757d; color: white; border-color: #6c757d; }
        .btn-success:hover { background: #5a6268; }
        .btn-danger { background: white; color: #212529; border-color: #212529; }
        .btn-danger:hover { background: #212529; color: white; }
        .btn-secondary { background: white; color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background: #6c757d; color: white; }
        .table-container { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        .table th { background: #212529; color: white; padding: 15px 10px; text-align: left; font-weight: 600; }
        .table td { padding: 12px 10px; border-bottom: 1px solid #dee2e6; }
        .table tr:hover { background: #f8f9fa; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #212529, #343a40); color: white; padding: 25px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; margin-bottom: 8px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .chart-container { background: white; border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .chart-title { font-size: 20px; font-weight: bold; color: #212529; margin-bottom: 20px; text-align: center; }
        .filter-section { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .invoice-list { background: white; border-radius: 12px; padding: 20px; margin-top: 20px; border: 2px solid #e9ecef; }
        .invoice-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #e9ecef; transition: background 0.3s ease; }
        .invoice-item:hover { background: #f8f9fa; }
        .invoice-item:last-child { border-bottom: none; }
        .invoice-info { flex: 1; }
        .invoice-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .invoice-status { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #212529; color: white; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid; position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; }
        .alert-success { background: #f8f9fa; color: #212529; border-color: #6c757d; }
        .alert-danger { background: #f8f9fa; color: #212529; border-color: #212529; }
        .section-card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; border: 2px solid #e9ecef; }
        .company-info { background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 2px solid #e9ecef; }
        .invoice-items { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto auto; gap: 15px; align-items: end; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; }
        .delivery-items { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; }
        .totals { margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 8px; border: 2px solid #dee2e6; }
        .totals-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 16px; }
        .totals-final { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; color: #212529; margin-top: 15px; padding-top: 15px; border-top: 2px solid #212529; }
        .preview { background: white; border: 2px solid #dee2e6; border-radius: 12px; padding: 30px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .searchable-select {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .searchable-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        .searchable-input:focus {
            outline: none;
            border-color: #212529;
            box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
        }
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item.selected {
            background: #212529;
            color: white;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            border: 2px solid #dee2e6;
        }
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .login-header .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #212529, #343a40);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        .login-form h2 {
            text-align: center;
            color: #212529;
            margin-bottom: 25px;
        }
        .login-error {
            color: #dc3545;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞ */
        .client-profile-modal {
            max-width: 1100px !important;
            max-height: 85vh !important;
            margin: 2% auto !important;
            padding: 0 !important;
        }

        .client-card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .client-avatar {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .client-title-info h2 {
            margin: 0 0 5px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .client-title-info p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .profile-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 25px;
        }

        .profile-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            height: fit-content;
        }

        .profile-section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .profile-field-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 13px;
            min-width: 100px;
        }

        .profile-field-value {
            color: #495057;
            font-size: 14px;
            text-align: right;
            flex: 1;
            max-width: 200px;
            word-wrap: break-word;
        }

        .profile-address {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .address-text {
            flex: 1;
            font-size: 14px;
            color: #495057;
        }

        .maps-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
            min-width: 40px;
        }

        .maps-btn:hover {
            background: #218838;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .contact-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .contact-icon.phone { background: #f5f5f5; color: #333; }
        .contact-icon.email { background: #f0f0f0; color: #555; }
        .contact-icon.telegram { background: #e8e8e8; color: #444; }
        .contact-icon.instagram { background: #f8f8f8; color: #666; }

        .contact-value {
            font-size: 12px;
            color: #495057;
            word-break: break-all;
        }

        .collaboration-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .collab-tag {
            background: #f5f5f5;
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #ddd;
        }

        .collab-tag.installment { background: #e8e8e8; color: #333; border-color: #ccc; }
        .collab-tag.showcase { background: #f0f0f0; color: #444; border-color: #bbb; }
        .collab-tag.bar { background: #f8f8f8; color: #555; border-color: #ddd; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            grid-column: 1 / -1;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #dee2e6;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 18px;
            font-weight: 700;
            color: #495057;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            color: #6c757d;
            font-weight: 500;
        }

        .profile-notes {
            grid-column: 1 / -1;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
            font-size: 13px;
            line-height: 1.5;
            color: #495057;
            max-height: 80px;
            overflow-y: auto;
        }

        .period-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            grid-column: 1 / -1;
        }

        .period-selector select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 13px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–π —Ñ–æ—Ä–º—ã */
        .collapsible-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        .section-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px 20px;
        }

        .section-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .client-form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 25px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .form-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            padding: 20px 25px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0;
        }

        .history-tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            color: #666;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .history-tab:hover {
            background: #f8f9fa;
            color: #333;
        }

        .history-tab.active {
            background: #333;
            color: white;
            font-weight: 600;
        }

        .history-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #333;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #333;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .user-details h5 {
            margin: 0 0 5px 0;
            color: #333;
            font-weight: 600;
        }

        .user-details p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-actions button {
            padding: 6px 12px;
            font-size: 12px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ 1366x768 */
        @media screen and (max-width: 1400px) {
            .client-profile-modal {
                max-width: 95% !important;
                margin: 1% auto !important;
            }
            
            .modal-content {
                margin: 2% auto;
                max-height: 95vh;
                padding: 20px;
            }
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media screen and (max-height: 800px) {
            .modal-content {
                margin: 1% auto;
                max-height: 98vh;
                padding: 15px;
            }
            
            #clientDataPreview {
                padding: 10px;
                margin-top: 10px;
                max-height: 150px;
            }
            
            #clientDataPreview h4 {
                font-size: 14px;
                margin-bottom: 10px;
            }
        }
        
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–æ–≥–æ–≤ –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ 1366x768 */
        @media screen and (max-width: 1400px) {
            #logsModal .modal-content {
                max-width: 85vw !important;
                width: 700px !important;
                max-height: 80vh !important;
                margin: 3vh auto !important;
            }
        }
        
        @media (max-width: 1366px) {
            .profile-sections {
                padding: 20px;
                gap: 15px;
            }
            
            .profile-section {
                padding: 15px;
            }
            
            .client-card-header {
                padding: 15px 25px;
            }
            
            .client-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .client-title-info h2 {
                font-size: 20px;
            }
            
            .contact-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .client-form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }

            .form-section {
                padding: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
            margin: 0;
        }
        .close {
            background: none;
            border: none;
            font-size: 30px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .close:hover {
            background: #f8f9fa;
            color: #212529;
        }
        .reservation-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .reservation-checkbox input[type="checkbox"] {
            transform: scale(1.2);
            margin: 0;
        }
        
        .reservation-checkbox label {
            font-size: 12px;
            color: #666;
            margin: 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .nav-tabs { flex-direction: column; }
            .nav-tab { min-width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .invoice-items { grid-template-columns: 1fr; }
            .delivery-items { grid-template-columns: 1fr; }
            
            /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–æ–≥–æ–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            #logsModal .modal-content {
                max-width: 95vw !important;
                width: 95vw !important;
                max-height: 90vh !important;
                margin: 2vh auto !important;
            }
            
            #logsModal .modal-footer {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            #logsModal .modal-footer button {
                width: 100% !important;
                min-width: auto !important;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞ */
        .warehouse-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .product-group {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .group-header {
            padding: 15px 20px;
            background: #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }

        .group-header:hover {
            background: #dee2e6;
        }

        .group-header h4 {
            margin: 0;
            color: #333;
        }

        .group-info {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .group-expand-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .group-expanded .group-expand-icon {
            transform: rotate(90deg);
        }

        .group-content {
            padding: 20px;
            display: none;
            border-top: 1px solid #dee2e6;
        }

        .group-expanded .group-content {
            display: block;
        }

        .group-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .remaining-percentage {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }

        .remaining-percentage.low {
            color: #dc3545;
        }

        .remaining-percentage.medium {
            color: #ffc107;
        }

        .add-products-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .products-in-group {
            margin-top: 15px;
        }

        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .quantity-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .group-info {
                flex-direction: column;
                gap: 5px;
            }
            
            .group-stats {
                grid-template-columns: 1fr;
            }
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π */
        .required-field {
            background-color: #F4E285 !important;
            border-color: #F4E285 !important;
        }

        .required-field-error {
            background-color: #F4A259 !important;
            border-color: #F4A259 !important;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–µ–π–±–ª–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π */
        .required-label::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .user-type-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 25px;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        
        .user-type-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .user-type-tab:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .user-type-tab.active {
            background: white;
            color: #212529;
            border-bottom-color: #212529;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-form-section {
            transition: opacity 0.3s ease;
            padding: 20px;
            background: white;
            border-radius: 0 0 8px 8px;
            border: 1px solid #dee2e6;
            border-top: none;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        #addUserModal .modal-content {
            max-width: 600px;
            width: 90%;
            margin: 8% auto;
        }

        #addUserModal .form-group {
            margin-bottom: 20px;
        }

        #addUserModal .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
            display: block;
        }

        #addUserModal .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fff;
        }

        #addUserModal .form-group input:focus {
            outline: none;
            border-color: #212529;
            box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ */
        #clientDataPreview {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            animation: fadeIn 0.3s ease-in;
            max-height: 200px;
            overflow-y: auto;
        }

        #clientDataPreview h4 {
            color: #28a745;
            font-size: 16px;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #clientPreviewData {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 14px;
        }

        #clientPreviewData > div {
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        #clientPreviewData strong {
            color: #495057;
            font-weight: 600;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ 1366x768 */
        @media (max-width: 1366px) {
            #addUserModal .modal-content {
                max-width: 550px;
                margin: 5% auto;
            }

            .user-type-tab {
                padding: 12px 16px;
                font-size: 14px;
            }

            .user-form-section {
                padding: 18px;
            }

            #clientPreviewData {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            #addUserModal .modal-content {
                width: 95%;
                margin: 3% auto;
            }

            .user-type-tabs {
                flex-direction: column;
            }

            .user-type-tab {
                border-bottom: none;
                border-right: 3px solid transparent;
            }

            .user-type-tab.active {
                border-right-color: #212529;
                border-bottom-color: transparent;
            }

            .form-row {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            #addUserModal .modal-footer {
                flex-direction: column;
                gap: 8px;
            }

            #addUserModal .modal-footer button {
                width: 100%;
            }
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è UX */
        .user-type-tab span {
            margin-right: 8px;
            font-size: 16px;
        }

        .form-row .form-group:last-child {
            margin-bottom: 0;
        }

        #addUserModal .modal-body {
            padding: 0;
        }

        #addUserModal .user-form-section {
            margin: 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-accepted {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="loginForm" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">–°–†</div>
                <h1>–°—Ä–µƒß–∞ 2024</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏</p>
            </div>
            <div class="login-form">
                <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                <div class="form-group">
                    <label>–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="loginUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="form-group">
                    <label>–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn btn-primary" onclick="authenticate()">–í–æ–π—Ç–∏</button>
                <div id="loginError" class="login-error" style="display: none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å</div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContent" style="display: none;">
        <div class="header">
            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 80px; height: auto; border-radius: 12px;">
            <div>
                <h1>–°—Ä–µƒß–∞ 2024 –î–û–û</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞–º–∏ –∏ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞–º–∏</p>
                <p style="font-size: 14px; opacity: 0.8;">–ë–µ–æ–≥—Ä–∞–¥, –°—Ç–∞—Ä–∏ –ì—Ä–∞–¥, –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35 | –ú–ë: 22019309 | –ü–ò–ë: 114407658</p>
            </div>
            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="openLogsModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">üìã</span>
                    –õ–æ–≥–∏
                </button>
                <button class="btn btn-secondary" onclick="openAddUserModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">üë§</span>
                    –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </button>
                <button class="btn btn-secondary" onclick="openEditUsersModal()" style="background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3);">
                    <span style="font-size: 16px; margin-right: 5px;">‚öôÔ∏è</span>
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </button>
                <button class="btn btn-danger" onclick="logout()" style="background: rgba(220,53,69,0.8); color: white; border-color: rgba(220,53,69,0.8);">
                    <span style="font-size: 16px; margin-right: 5px;">üö™</span>
                    –í—ã—Ö–æ–¥
                </button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('clients')">–ö–ª–∏–µ–Ω—Ç—ã</button>
            <button class="nav-tab" onclick="showTab('products')">–¢–æ–≤–∞—Ä—ã</button>
            <button class="nav-tab" onclick="showTab('warehouse')">–°–∫–ª–∞–¥</button>
            <button class="nav-tab" onclick="showTab('invoice')">–°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å</button>
            <button class="nav-tab" onclick="showTab('delivery')">–°–æ–∑–¥–∞—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É</button>
            <button class="nav-tab" onclick="showTab('orders')" id="ordersTabBtn" style="display: none;">–ó–∞–∫–∞–∑—ã</button>
            <button class="nav-tab" onclick="showTab('statistics')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</button>
        </div>

        <!-- –ö–ª–∏–µ–Ω—Ç—ã -->
        <div id="clients" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h2>
                <button class="btn btn-primary" onclick="toggleClientForm()" id="toggleFormBtn">
                    <span id="toggleIcon">‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                </button>
            </div>
            
            <!-- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ -->
            <div id="clientFormSection" class="collapsible-section" style="display: none;">
                <div class="section-header">
                    <h3>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</h3>
                </div>
                
                <div class="client-form-grid">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="form-section">
                        <h4>üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ *</label>
                            <input type="text" id="clientName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
                        </div>
                        <div class="form-group">
                            <label>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" id="clientLegalName" placeholder="–ü–æ–ª–Ω–æ–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò *</label>
                                <input type="text" id="clientMB" placeholder="–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò">
                            </div>
                            <div class="form-group">
                                <label>–ü–ò–ë *</label>
                                <input type="text" id="clientPIB" placeholder="–ü–ò–ë">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                                <input type="text" id="clientContactPerson" placeholder="–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ –ª–∏—Ü–∞">
                            </div>
                            <div class="form-group">
                                <label>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á–µ—Ç</label>
                                <input type="text" id="clientBank" placeholder="–ù–æ–º–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞">
                            </div>
                        </div>
                    </div>

                    <!-- –ê–¥—Ä–µ—Å -->
                    <div class="form-section">
                        <h4>üìç –ê–¥—Ä–µ—Å</h4>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="manualAddressInput" style="width: auto;">
                                –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞
                            </label>
                        </div>
                        
                        <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞ -->
                        <div id="autoAddressSection">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>–ì–æ—Ä–æ–¥ *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientCity" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞..." autocomplete="off">
                                        <div class="dropdown-menu" id="clientCityDropdown"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>–û–±—â–∏–Ω–∞ *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientMunicipality" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –≥–æ—Ä–æ–¥..." autocomplete="off" disabled>
                                        <div class="dropdown-menu" id="clientMunicipalityDropdown"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>–£–ª–∏—Ü–∞ *</label>
                                    <div class="searchable-select">
                                        <input type="text" class="searchable-input" id="clientStreet" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –æ–±—â–∏–Ω—É..." autocomplete="off" disabled>
                                        <div class="dropdown-menu" id="clientStreetDropdown"></div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>–ù–æ–º–µ—Ä –¥–æ–º–∞</label>
                                    <input type="text" id="clientHouseNumber" placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞">
                                </div>
                            </div>
                        </div>
                        
                        <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞ -->
                        <div id="manualAddressSection" style="display: none;">
                            <div class="form-group">
                                <label>–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å *</label>
                                <textarea id="clientManualAddress" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: Beograd, Stari grad, Knez Mihailova 5)" rows="3" style="resize: vertical;"></textarea>
                                <small style="color: #666; font-size: 12px;">–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>–°—Å—ã–ª–∫–∞ –Ω–∞ Google Maps</label>
                            <input type="text" id="clientGoogleMaps" placeholder="https://maps.google.com/...">
                        </div>
                    </div>

                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                    <div class="form-section">
                        <h4>üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="text" id="clientPhone" placeholder="+381 XX XXX XXXX">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="clientEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telegram</label>
                                <input type="text" id="clientTelegram" placeholder="@username">
                            </div>
                            <div class="form-group">
                                <label>Instagram</label>
                                <input type="text" id="clientInstagram" placeholder="@username">
                            </div>
                        </div>
                    </div>

                    <!-- –£—Å–ª–æ–≤–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ -->
                    <div class="form-section">
                        <h4>ü§ù –£—Å–ª–æ–≤–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="clientInstallment" style="transform: scale(1.2);">
                                    <span>–†–∞—Å—Å—Ä–æ—á–∫–∞ –æ–ø–ª–∞—Ç—ã</span>
                                </label>
                                <input type="text" id="clientInstallmentTerm" placeholder="–°—Ä–æ–∫ (–¥–Ω–∏)" style="margin-top: 5px;">
                            </div>
                            <div class="form-group">
                                <div style="display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="clientShowcase" style="transform: scale(1.2);">
                                        <span>–í–∏—Ç—Ä–∏–Ω–∞</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="clientBar" style="transform: scale(1.2);">
                                        <span>–ë–∞—Ä</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                            <textarea id="clientNotes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ" rows="3" style="resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="addClient()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
                    <button class="btn btn-secondary" onclick="clearClientForm()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
                    <button class="btn btn-secondary" onclick="toggleClientForm()">‚ùå –°–≤–µ—Ä–Ω—É—Ç—å</button>
                </div>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ú–ë</th><th>–ü–ò–ë</th><th>–ê–¥—Ä–µ—Å</th><th>–ö–æ–Ω—Ç–∞–∫—Ç</th><th>–ë–∞–Ω–∫</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                    </thead>
                    <tbody id="clientsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- –¢–æ–≤–∞—Ä—ã -->
        <div id="products" class="tab-content">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h2>
            <div class="form-grid">
                <div>
                    <div class="form-group">
                        <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥ *</label>
                        <input type="text" id="productInternalCode" placeholder="INT-001">
                    </div>
                    <div class="form-group">
                        <label>–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ *</label>
                        <input type="text" id="productCode" placeholder="GF-B-TG210">
                    </div>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                        <input type="text" id="productName" placeholder="Tieguanyin/Zeleni ƒåaj 210g">
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –±–µ–∑ –ù–î–° (RSD) *</label>
                        <input type="number" id="productPrice" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="productCategory">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <option value="Zeleni ƒåaj">–ó–µ–ª–µ–Ω—ã–π —á–∞–π</option>
                            <option value="Crni ƒåaj">–ß–µ—Ä–Ω—ã–π —á–∞–π</option>
                            <option value="Printing">–ü–æ–ª–∏–≥—Ä–∞—Ñ–∏—è</option>
                            <option value="Other">–î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–í–µ—Å (–≥)</label>
                        <input type="number" id="productWeight" placeholder="210" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>–î–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="productClientSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞..." autocomplete="off">
                            <input type="hidden" id="productClient" value="">
                            <div class="dropdown-menu" id="productClientDropdown"></div>
                        </div>
                        <small style="color: #666;">–ï—Å–ª–∏ –≤—ã–±—Ä–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞, —Ç–æ–≤–∞—Ä –ø–æ—è–≤–∏—Ç—Å—è —É –Ω–µ–≥–æ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–ü—Ä–æ–¥—É–∫—Ç—ã¬ª</small>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="addProduct()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            <button class="btn btn-secondary" onclick="clearProductForm()">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
            <button class="btn btn-success" onclick="showAllProductsForAdmin()" id="showAllProductsBtn" style="margin-left: 10px; display: none;">üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
            
            <div style="margin: 20px 0;">
                <label for="productUserFilter" style="margin-right: 10px; font-weight: bold;">–§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</label>
                <select id="productUserFilter" onchange="renderProductsTable()" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                    <option value="company">–ö–æ–º–ø–∞–Ω–∏—è –ø—Ä–æ–¥–∞–≤–µ—Ü</option>
                </select>
            </div>
            
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr><th>–ö–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞ (RSD)</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–í–µ—Å (–≥)</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- –°–∫–ª–∞–¥ -->
        <div id="warehouse" class="tab-content">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º</h2>
            
            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ -->
            <div class="warehouse-section" id="groupCreationForm">
                <h3>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —Ç–æ–≤–∞—Ä–æ–≤</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã *</label>
                        <input type="text" id="groupName" placeholder="–ó–µ–ª–µ–Ω—ã–π —á–∞–π –ø—Ä–µ–º–∏—É–º">
                    </div>
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏</label>
                        <input type="date" id="groupShipmentDate">
                    </div>
                </div>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="groupQuantityType" style="flex: 0 0 80px;">
                                <option value="weight">–í–µ—Å</option>
                                <option value="pieces">–ï–¥.</option>
                            </select>
                            <input type="number" id="groupQuantity" placeholder="1000" style="flex: 1;">
                            <span id="quantityUnit" style="align-self: center; color: #666;">–≥</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–∞ –º–µ—Å—è—Ü</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="groupReservationType" style="flex: 0 0 80px;">
                                <option value="weight">–í–µ—Å</option>
                                <option value="pieces">–ï–¥.</option>
                            </select>
                            <input type="number" id="groupReservation" placeholder="100" style="flex: 1;">
                            <span id="reservationUnit" style="align-self: center; color: #666;">–≥</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="createProductGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                    <button class="btn btn-secondary" onclick="clearGroupForm()">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø —Ç–æ–≤–∞—Ä–æ–≤ -->
            <div class="warehouse-section" style="margin-top: 30px;">
                <h3>–ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤</h3>
                <div id="productGroupsList">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ -->
                </div>
            </div>
        </div>

        <!-- –°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å -->
        <div id="invoice" class="tab-content">
            <h2>–°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å</h2>
            
            <div class="company-info">
                <h3>–ü–æ—Å—Ç–∞–≤—â–∏–∫</h3>
                <p><strong>–°—Ä–µƒß–∞ 2024 –î–û–û –ë–µ–æ–≥—Ä–∞–¥ (–°—Ç–∞—Ä–∏ –ì—Ä–∞–¥)</strong></p>
                <p>–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò: 22019309 | –ü–ò–ë: 114407658</p>
                <p>–°–µ–¥–∏—à—Ç–µ: –ë–µ–æ–≥—Ä–∞–¥, –°—Ç–∞—Ä–∏ –ì—Ä–∞–¥, –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35</p>
                <p>–†–∞—á—É–Ω: 190-0000000085540-29 (Alta Banka)</p>
            </div>

            <div class="section-card">
                <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ *</label>
                        <input type="text" id="invoiceNumber" placeholder="1-DDMMYYYY">
                    </div>
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ *</label>
                        <input type="date" id="invoiceDate">
                    </div>
                    <div class="form-group">
                        <label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã *</label>
                        <input type="date" id="invoiceDueDate">
                    </div>
                    <div class="form-group">
                        <label>–ö–ª–∏–µ–Ω—Ç *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="invoiceClientSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞..." autocomplete="off">
                            <input type="hidden" id="invoiceClient" value="">
                            <div class="dropdown-menu" id="invoiceClientDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <select id="invoiceDelivery">
                            <option value="—Å–æ–ø—Å—Ç–≤–µ–Ω–∏ –ø—Ä–µ–≤–æ–∑">–°–æ–ø—Å—Ç–≤–µ–Ω–∏ –ø—Ä–µ–≤–æ–∑</option>
                            <option value="–∫—É—Ä–∏—Ä—Å–∫–∞ —Å–ª—É–∂–±–∞">–ö—É—Ä–∏—Ä—Å–∫–∞—è —Å–ª—É–∂–±–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ù–î–° (%)</label>
                        <select id="invoiceVAT">
                            <option value="0">0%</option>
                            <option value="20">20%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–∑–∏–≤ –Ω–∞ –±—Ä–æ—ò</label>
                        <input type="text" id="invoiceReference" placeholder="97-12345678" maxlength="20">
                        <small style="color: #666; font-size: 12px;">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ. –ù–∞–ø—Ä–∏–º–µ—Ä: 97-12345678</small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="differentDeliveryAddress" style="width: auto;">
                            –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∞–¥—Ä–µ—Å–∞ —Å–µ–¥–∏—à—Ç–∞
                        </label>
                    </div>
                </div>
            </div>

            <!-- –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
            <div id="deliveryAddressSection" class="section-card" style="display: none;">
                <h3>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>–ì–æ—Ä–æ–¥ *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryCity" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞..." autocomplete="off">
                            <div class="dropdown-menu" id="deliveryCityDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–û–±—â–∏–Ω–∞ *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryMunicipality" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –≥–æ—Ä–æ–¥..." autocomplete="off" disabled>
                            <div class="dropdown-menu" id="deliveryMunicipalityDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–£–ª–∏—Ü–∞ *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryStreet" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –æ–±—â–∏–Ω—É..." autocomplete="off" disabled>
                            <div class="dropdown-menu" id="deliveryStreetDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä –¥–æ–º–∞</label>
                        <input type="text" id="deliveryHouseNumber" placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞">
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3>–¢–æ–≤–∞—Ä—ã</h3>
                <div id="invoiceItems">
                    <div class="invoice-items">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–¢–æ–≤–∞—Ä *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input invoice-product-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." autocomplete="off">
                                <input type="hidden" class="invoice-product" value="">
                                <div class="dropdown-menu invoice-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" class="invoice-quantity" value="1" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–¶–µ–Ω–∞ (RSD)</label>
                            <input type="number" class="invoice-price" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–°—É–º–º–∞ (RSD)</label>
                            <input type="number" class="invoice-amount" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <div class="reservation-checkbox">
                            <input type="checkbox" class="invoice-reservation" id="reservation-0">
                            <label for="reservation-0">–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è</label>
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeInvoiceItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addInvoiceItem()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                
                <div class="totals">
                    <div class="totals-row">
                        <span>–ü–æ–¥—Ç–æ—Ç–∞–ª:</span>
                        <span id="invoiceSubtotal">0.00 RSD</span>
                    </div>
                    <div class="totals-row">
                        <span>–ù–î–°:</span>
                        <span id="invoiceVATAmount">0.00 RSD</span>
                    </div>
                    <div class="totals-final">
                        <span>–ò–¢–û–ì–û:</span>
                        <span id="invoiceTotal">0.00 RSD</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="generateInvoice()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–≤–æ–π—Å</button>
                <button class="btn btn-success" onclick="confirmInvoice()">–£—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–Ω–≤–æ–π—Å</button>
                <button class="btn btn-secondary" onclick="generateDeliveryFromInvoice()">–°–æ–∑–¥–∞—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É</button>
            </div>
            
            <div id="invoicePreview" class="preview" style="display: none;">
                <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–≤–æ–π—Å–∞</h3>
                <div id="invoiceContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="exportInvoiceToPDF()">–≠–∫—Å–ø–æ—Ä—Ç PDF</button>
                    <button class="btn btn-secondary" onclick="downloadInvoiceAsHTML()">–°–∫–∞—á–∞—Ç—å HTML</button>
                    <button class="btn btn-secondary" onclick="copyInvoiceToClipboard()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div id="invoiceConfirmMessage" style="display: none; margin-top: 15px;" class="alert alert-success">
                    –ò–Ω–≤–æ–π—Å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–¥–∞–∂!
                </div>
            </div>
        </div>

        <!-- –°–æ–∑–¥–∞—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É -->
        <div id="delivery" class="tab-content">
            <h2>–°–æ–∑–¥–∞—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É</h2>
            
            <div class="company-info">
                <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</h3>
                <p><strong>–°—Ä–µƒß–∞ 2024 –î–û–û –ë–µ–æ–≥—Ä–∞–¥ (–°—Ç–∞—Ä–∏ –ì—Ä–∞–¥)</strong></p>
                <p>–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò: 22019309 | –ü–ò–ë: 114407658</p>
                <p>–°–µ–¥–∏—à—Ç–µ: –ë–µ–æ–≥—Ä–∞–¥, –°—Ç–∞—Ä–∏ –ì—Ä–∞–¥, –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35</p>
            </div>

            <div class="section-card">
                <h3>–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã *</label>
                        <input type="text" id="deliveryNumber" placeholder="1-DDMMYYYY">
                    </div>
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ *</label>
                        <input type="date" id="deliveryDate">
                    </div>
                    <div class="form-group">
                        <label>–°—Ä–æ–∫ –ø–æ—Å—Ç–∞–≤–∫–∏ *</label>
                        <input type="date" id="deliveryDueDate">
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–ª—É—á–∞—Ç–µ–ª—å *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input" id="deliveryClientSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è..." autocomplete="off">
                            <input type="hidden" id="deliveryClient" value="">
                            <div class="dropdown-menu" id="deliveryClientDropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                        <select id="deliveryMethod">
                            <option value="—Å–æ–ø—Å—Ç–≤–µ–Ω–∏ –ø—Ä–µ–≤–æ–∑">–°–æ–ø—Å—Ç–≤–µ–Ω–∏ –ø—Ä–µ–≤–æ–∑</option>
                            <option value="–∫—É—Ä–∏—Ä—Å–∫–∞ —Å–ª—É–∂–±–∞">–ö—É—Ä–∏—Ä—Å–∫–∞—è —Å–ª—É–∂–±–∞</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3>–¢–æ–≤–∞—Ä—ã</h3>
                <div id="deliveryItems">
                    <div class="delivery-items">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–¢–æ–≤–∞—Ä *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input delivery-product-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." autocomplete="off">
                                <input type="hidden" class="delivery-product" value="">
                                <div class="dropdown-menu delivery-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" class="delivery-quantity" value="1" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–ï–¥–∏–Ω–∏—Ü–∞</label>
                            <input type="text" class="delivery-unit" value="–∫–æ–º" readonly>
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeDeliveryItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="addDeliveryItem()">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="generateDelivery()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É</button>
                <button class="btn btn-success" onclick="confirmDelivery()">–£—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É</button>
            </div>
            
            <div id="deliveryPreview" class="preview" style="display: none;">
                <h3>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã</h3>
                <div id="deliveryContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="printDelivery()">–≠–∫—Å–ø–æ—Ä—Ç PDF</button>
                </div>
            </div>

            <div class="invoice-list" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã</h3>
                    <div class="form-group" style="margin: 0; width: 300px;">
                        <select id="deliveryClientFilter" style="margin: 0;" onchange="filterDeliveriesByClient()">
                            <option value="">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                        </select>
                    </div>
                </div>
                <div id="confirmedDeliveriesList">
                    <p style="text-align: center; color: #666;">–ù–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü</p>
                </div>
            </div>
        </div>

        <!-- –ó–∞–∫–∞–∑—ã -->
        <div id="orders" class="tab-content">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h2>
            
            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="section-card">
                <h3>–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:</label>
                        <select id="orderStatusFilter">
                            <option value="">–í—Å–µ –∑–∞–∫–∞–∑—ã</option>
                            <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                            <option value="accepted">–ü—Ä–∏–Ω—è—Ç—ã–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ö–ª–∏–µ–Ω—Ç:</label>
                        <input type="text" id="orderClientFilter" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–ª–∏–µ–Ω—Ç–∞">
                    </div>
                    <div class="form-group">
                        <label>–ü–µ—Ä–∏–æ–¥ —Å:</label>
                        <input type="date" id="orderFromDate">
                    </div>
                    <div class="form-group">
                        <label>–ü–µ—Ä–∏–æ–¥ –ø–æ:</label>
                        <input type="date" id="orderToDate">
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="filterOrders()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    <button class="btn btn-secondary" onclick="clearOrderFilters()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <button class="btn btn-success" onclick="refreshOrders()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
            <div class="section-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                    <div>
                        <span id="ordersCount" style="color: #666; margin-right: 20px;">–ù–∞–π–¥–µ–Ω–æ: 0 –∑–∞–∫–∞–∑–æ–≤</span>
                        <button class="btn btn-success" onclick="acceptAllPendingOrders()" title="–ü—Ä–∏–Ω—è—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã –≤ –æ–∂–∏–¥–∞–Ω–∏–∏">
                            ‚úÖ –ü—Ä–∏–Ω—è—Ç—å –≤—Å–µ
                        </button>
                    </div>
                </div>
                
                <div id="ordersList" class="table-container">
                    <table class="table" id="ordersTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllOrders" onchange="toggleAllOrders(this)">
                                </th>
                                <th>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–¢–æ–≤–∞—Ä—ã</th>
                                <th>–°—É–º–º–∞ —Å –ù–î–°</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: #666;">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrdersCount">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingOrdersCount">0</div>
                    <div class="stat-label">–í –æ–∂–∏–¥–∞–Ω–∏–∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="acceptedOrdersCount">0</div>
                    <div class="stat-label">–ü—Ä–∏–Ω—è—Ç—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalOrdersValue">0 –†–°–î</div>
                    <div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ -->
        <div id="statistics" class="tab-content">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h2>
            <div class="filter-section">
                <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>–ü–µ—Ä–∏–æ–¥ —Å:</label>
                        <input type="date" id="statsFromDate">
                    </div>
                    <div class="form-group">
                        <label>–ü–µ—Ä–∏–æ–¥ –ø–æ:</label>
                        <input type="date" id="statsToDate">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div>
                            <button class="btn btn-primary" onclick="updateStatistics()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                            <button class="btn btn-success" onclick="exportStatisticsToPDF()">–°–∫–∞—á–∞—Ç—å PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">0 RSD</div>
                    <div class="stat-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalInvoices">0</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∏–Ω–≤–æ–π—Å–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClients">0</div>
                    <div class="stat-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageOrder">0 RSD</div>
                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">–í—ã—Ä—É—á–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
                <div id="revenueChart">–ì—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –∑–¥–µ—Å—å</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">–¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</div>
                <div id="productsChart">–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂ —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –∑–¥–µ—Å—å</div>
            </div>

            <div class="chart-container">
                <div class="chart-title">–¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ</div>
                <div id="clientsChart">–ì—Ä–∞—Ñ–∏–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –∑–¥–µ—Å—å</div>
            </div>

            <div class="invoice-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã</h3>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="btn btn-info" onclick="syncInvoiceStatuses()" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏–Ω—è—Ç–∏—è –∏–Ω–≤–æ–π—Å–æ–≤ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
                        </button>
                        <div class="form-group" style="margin: 0; width: 300px;">
                            <input type="text" id="invoiceSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∏–Ω–≤–æ–π—Å–∞..." style="margin: 0;" oninput="filterInvoicesBySearch()">
                        </div>
                    </div>
                </div>
                <div id="confirmedInvoicesList">
                    <p style="text-align: center; color: #666;">–ù–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>
                </div>
            </div>
        </div>


    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
    <div id="editProductModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <button class="close" onclick="closeEditProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥ *</label>
                        <input type="text" id="editProductInternalCode" placeholder="INT-001">
                    </div>
                    <div class="form-group">
                        <label>–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ *</label>
                        <input type="text" id="editProductCode" placeholder="GF-B-TG210">
                    </div>
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                        <input type="text" id="editProductName" placeholder="Tieguanyin/Zeleni ƒåaj 210g">
                    </div>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –±–µ–∑ –ù–î–° (RSD) *</label>
                        <input type="number" id="editProductPrice" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>–í–µ—Å (–≥)</label>
                        <input type="number" id="editProductWeight" placeholder="210" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="editProductCategory">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        <option value="Zeleni ƒåaj">–ó–µ–ª–µ–Ω—ã–π —á–∞–π</option>
                        <option value="Crni ƒåaj">–ß–µ—Ä–Ω—ã–π —á–∞–π</option>
                        <option value="Printing">–ü–æ–ª–∏–≥—Ä–∞—Ñ–∏—è</option>
                        <option value="Other">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveProductChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button class="btn btn-secondary" onclick="closeEditProductModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–æ–≥–æ–≤ -->
    <div id="logsModal" class="modal">
        <div class="modal-content" style="
            max-width: 90vw; 
            width: 800px; 
            max-height: 85vh; 
            margin: 5vh auto; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        ">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="modal-title">–õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π</h2>
                <button class="close" onclick="closeLogsModal()">&times;</button>
            </div>
            <div class="modal-body" style="
                flex: 1; 
                overflow: hidden; 
                padding: 20px; 
                display: flex; 
                flex-direction: column;
            ">
                <div id="logsContainer" style="
                    background: #f8f9fa; 
                    border-radius: 12px; 
                    padding: 20px; 
                    flex: 1; 
                    overflow-y: auto; 
                    border: 2px solid #e9ecef;
                    min-height: 200px;
                ">
                    <ul id="logsList" style="list-style:none; padding:0; margin:0;"></ul>
                </div>
            </div>
            <div class="modal-footer" style="
                text-align: center; 
                padding: 20px; 
                border-top: 1px solid #e9ecef; 
                flex-shrink: 0;
                display: flex;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            ">
                <button class="btn btn-success" onclick="exportLogsToExcel()" style="min-width: 150px;">
                    <span style="font-size: 14px; margin-right: 5px;">üìä</span>
                    –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
                <button class="btn btn-secondary" onclick="clearLogs()" style="min-width: 120px;">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
                <button class="btn btn-secondary" onclick="closeLogsModal()" style="min-width: 100px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <button class="close" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tabs for user type selection -->
                <div class="user-type-tabs">
                    <button class="user-type-tab active" onclick="switchUserType('regular')" id="regularUserTab">
                        <span>üë§</span> –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    </button>
                    <button class="user-type-tab" onclick="switchUserType('client')" id="clientUserTab">
                        <span>üè¢</span> –ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞
                    </button>
                </div>

                <!-- Regular user form -->
                <div id="regularUserForm" class="user-form-section">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>–õ–æ–≥–∏–Ω <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="newUserLogin" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" autocomplete="off" required>
                        </div>
                        <div class="form-group">
                            <label>–ü–∞—Ä–æ–ª—å <span style="color: #dc3545;">*</span></label>
                            <input type="password" id="newUserPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å <span style="color: #dc3545;">*</span></label>
                        <input type="password" id="confirmUserPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password" required>
                    </div>
                </div>

                <!-- Client profile form -->
                <div id="clientUserForm" class="user-form-section" style="display: none;">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>–õ–æ–≥–∏–Ω <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="newClientUserLogin" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" autocomplete="off" oninput="checkClientMB()" required>
                        </div>
                        <div class="form-group">
                            <label>–ü–∞—Ä–æ–ª—å <span style="color: #dc3545;">*</span></label>
                            <input type="password" id="newClientUserPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password" oninput="checkClientMB()" required>
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å <span style="color: #dc3545;">*</span></label>
                            <input type="password" id="confirmClientUserPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="new-password" oninput="checkClientMB()" required>
                        </div>
                        <div class="form-group">
                            <label>–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="newClientUserMB" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò" autocomplete="off" oninput="checkClientMB()" required>
                        </div>
                    </div>
                    
                    <!-- Client data preview -->
                    <div id="clientDataPreview" style="display: none;">
                        <h4>‚úì –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç</h4>
                        <div id="clientPreviewData"></div>
                    </div>
                </div>

                <div id="addUserError" class="login-error" style="display: none;"></div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 0 0 0; border-top: 1px solid #dee2e6; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" id="addUserButton" onclick="addNewUser()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="editUsersModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                <button class="close" onclick="closeEditUsersModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="usersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeEditUsersModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º -->
    <div id="userPermissionsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="permissionsTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º</h2>
                <button class="close" onclick="closeUserPermissionsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <h4>–î–æ—Å—Ç—É–ø –∫ –≤–∫–ª–∞–¥–∫–∞–º:</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_clients" style="transform: scale(1.2);">
                            <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_products" style="transform: scale(1.2);">
                            <span>–¢–æ–≤–∞—Ä—ã</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_warehouse" style="transform: scale(1.2);">
                            <span>–°–∫–ª–∞–¥</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_invoice" style="transform: scale(1.2);">
                            <span>–ò–Ω–≤–æ–π—Å</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_delivery" style="transform: scale(1.2);">
                            <span>–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_statistics" style="transform: scale(1.2);">
                            <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="perm_logs" style="transform: scale(1.2);">
                            <span>–õ–æ–≥–∏</span>
                        </label>
                        <hr style="margin: 15px 0;">
                        <label style="display: flex; align-items: center; gap: 10px;" id="editUserPermLabel">
                            <input type="checkbox" id="perm_editUsers" style="transform: scale(1.2);">
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="saveUserPermissions()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="closeUserPermissionsModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ -->
    <div id="clientHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="clientHistoryTitle">–ò—Å—Ç–æ—Ä–∏—è –∏–Ω–≤–æ–π—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞</h2>
                <button class="close" onclick="closeClientHistoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="clientHistoryContent" style="max-height: 500px; overflow-y: auto;">
                    <p style="text-align: center; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-secondary" onclick="closeClientHistoryModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞ -->
    <div id="clientProfileModal" class="modal">
        <div class="modal-content client-profile-modal">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="client-card-header">
                <div class="client-avatar" id="clientAvatar">–ö–õ</div>
                <div class="client-title-info">
                    <h2 id="clientProfileTitle">–ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞</h2>
                    <p id="clientProfileSubtitle">–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
                </div>
                <button class="close" onclick="closeClientProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
            </div>

            <!-- –°–µ–∫—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è (—Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞) -->
            <div id="profile-sections" class="profile-sections">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="profile-section">
                    <h3>üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <div class="profile-field">
                        <span class="profile-field-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
                        <span class="profile-field-value" id="profileClientName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ:</span>
                        <span class="profile-field-value" id="profileClientLegalName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">–ú–ë:</span>
                        <span class="profile-field-value" id="profileClientMB">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">–ü–ò–ë:</span>
                        <span class="profile-field-value" id="profileClientPIB">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">–ö–æ–Ω—Ç–∞–∫—Ç. –ª–∏—Ü–æ:</span>
                        <span class="profile-field-value" id="profileClientContactPerson">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">–ë–∞–Ω–∫:</span>
                        <span class="profile-field-value" id="profileClientBank">-</span>
                    </div>
                </div>

                <!-- –ê–¥—Ä–µ—Å -->
                <div class="profile-section">
                    <h3>üìç –ê–¥—Ä–µ—Å</h3>
                    <div class="profile-address">
                        <span class="address-text" id="profileClientAddress">-</span>
                        <button id="profileGoogleMapsBtn" class="maps-btn" style="display: none;" onclick="openGoogleMaps()" title="–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps">üó∫Ô∏è</button>
                    </div>
                </div>

                <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                <div class="profile-section">
                    <h3>üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                    <div class="contact-grid">
                        <div class="contact-item" id="contactPhone" style="display: none;">
                            <div class="contact-icon phone">üìû</div>
                            <div class="contact-value" id="profileClientPhone">-</div>
                        </div>
                        <div class="contact-item" id="contactEmail" style="display: none;">
                            <div class="contact-icon email">‚úâÔ∏è</div>
                            <div class="contact-value" id="profileClientEmail">-</div>
                        </div>
                        <div class="contact-item" id="contactTelegram" style="display: none;">
                            <div class="contact-icon telegram">‚úàÔ∏è</div>
                            <div class="contact-value" id="profileClientTelegram">-</div>
                        </div>
                        <div class="contact-item" id="contactInstagram" style="display: none;">
                            <div class="contact-icon instagram">üì∑</div>
                            <div class="contact-value" id="profileClientInstagram">-</div>
                        </div>
                    </div>
                </div>

                <!-- –£—Å–ª–æ–≤–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ -->
                <div class="profile-section">
                    <h3>ü§ù –£—Å–ª–æ–≤–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞</h3>
                    <div class="collaboration-tags" id="collaborationTags">
                        <!-- –¢–µ–≥–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="profile-notes" id="profileClientNotes" style="display: none;">
                        <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏—è -->
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="profile-section" style="grid-column: 1 / -1;">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞</h3>
                    <div class="period-selector">
                        <label>–ü–µ—Ä–∏–æ–¥:</label>
                        <select id="statisticsPeriod" onchange="updateClientStatistics()">
                            <option value="all">–í—Å—ë –≤—Ä–µ–º—è</option>
                            <option value="year">–¢–µ–∫—É—â–∏–π –≥–æ–¥</option>
                            <option value="quarter">–¢–µ–∫—É—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª</option>
                            <option value="month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                        </select>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="clientAvgOrderValue">0 RSD</div>
                            <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientInvoiceCount">0</div>
                            <div class="stat-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–≤–æ–π—Å–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientTopProduct">-</div>
                            <div class="stat-label">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="clientYearlyConsumption">0 RSD</div>
                            <div class="stat-label">–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –≤ –≥–æ–¥</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
            <div id="edit-sections" class="profile-sections" style="display: none;">
                <div class="client-form-grid">
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="form-section">
                        <h4>üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ *</label>
                            <input type="text" id="editClientName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
                        </div>
                        <div class="form-group">
                            <label>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *</label>
                            <input type="text" id="editClientLegalName" placeholder="–ü–æ–ª–Ω–æ–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò *</label>
                                <input type="text" id="editClientMB" placeholder="–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò">
                            </div>
                            <div class="form-group">
                                <label>–ü–ò–ë *</label>
                                <input type="text" id="editClientPIB" placeholder="–ü–ò–ë">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                                <input type="text" id="editClientContactPerson" placeholder="–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–≥–æ –ª–∏—Ü–∞">
                            </div>
                            <div class="form-group">
                                <label>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á–µ—Ç</label>
                                <input type="text" id="editClientBank" placeholder="–ù–æ–º–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞">
                            </div>
                        </div>
                    </div>

                    <!-- –ê–¥—Ä–µ—Å -->
                    <div class="form-section">
                        <h4>üìç –ê–¥—Ä–µ—Å</h4>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editManualAddressInput" style="width: auto;">
                                –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞
                            </label>
                        </div>
                        
                        <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞ -->
                        <div id="editAutoAddressSection">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>–ì–æ—Ä–æ–¥ *</label>
                                    <input type="text" id="editClientCity" placeholder="–ì–æ—Ä–æ–¥">
                                </div>
                                <div class="form-group">
                                    <label>–û–±—â–∏–Ω–∞ *</label>
                                    <input type="text" id="editClientMunicipality" placeholder="–û–±—â–∏–Ω–∞">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>–£–ª–∏—Ü–∞ *</label>
                                    <input type="text" id="editClientStreet" placeholder="–£–ª–∏—Ü–∞">
                                </div>
                                <div class="form-group">
                                    <label>–ù–æ–º–µ—Ä –¥–æ–º–∞</label>
                                    <input type="text" id="editClientHouseNumber" placeholder="–ù–æ–º–µ—Ä –¥–æ–º–∞">
                                </div>
                            </div>
                        </div>
                        
                        <!-- –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞ -->
                        <div id="editManualAddressSection" style="display: none;">
                            <div class="form-group">
                                <label>–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å *</label>
                                <textarea id="editClientManualAddress" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å" rows="3" style="resize: vertical;"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>–°—Å—ã–ª–∫–∞ –Ω–∞ Google Maps</label>
                            <input type="text" id="editClientGoogleMaps" placeholder="https://maps.google.com/...">
                        </div>
                    </div>

                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                    <div class="form-section">
                        <h4>üìû –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="text" id="editClientPhone" placeholder="+381 XX XXX XXXX">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="editClientEmail" placeholder="email@example.com">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telegram</label>
                                <input type="text" id="editClientTelegram" placeholder="@username">
                            </div>
                            <div class="form-group">
                                <label>Instagram</label>
                                <input type="text" id="editClientInstagram" placeholder="@username">
                            </div>
                        </div>
                    </div>

                    <!-- –£—Å–ª–æ–≤–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ -->
                    <div class="form-section">
                        <h4>ü§ù –£—Å–ª–æ–≤–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="editClientInstallment" style="transform: scale(1.2);">
                                    <span>–†–∞—Å—Å—Ä–æ—á–∫–∞ –æ–ø–ª–∞—Ç—ã</span>
                                </label>
                                <input type="text" id="editClientInstallmentTerm" placeholder="–°—Ä–æ–∫ (–¥–Ω–∏)" style="margin-top: 5px;">
                            </div>
                            <div class="form-group">
                                <div style="display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editClientShowcase" style="transform: scale(1.2);">
                                        <span>–í–∏—Ç—Ä–∏–Ω–∞</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" id="editClientBar" style="transform: scale(1.2);">
                                        <span>–ë–∞—Ä</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                            <textarea id="editClientNotes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ" rows="3" style="resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
            <div id="viewModeFooter" class="modal-footer" style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef;">
                <button class="btn btn-primary" onclick="switchToEditMode()" style="margin-right: 10px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-primary" onclick="switchToClientHistory()" style="margin-right: 10px;">üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</button>
                <button class="btn btn-secondary" onclick="closeClientProfileModal()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div id="editModeFooter" class="modal-footer" style="text-align: center; padding: 20px; border-top: 1px solid #e9ecef; display: none;">
                <button class="btn btn-primary" onclick="saveClientChanges()" style="margin-right: 10px;">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button class="btn btn-secondary" onclick="switchToViewMode()" style="margin-right: 10px;">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ -->
            <div id="clientHistorySection" style="display: none;">
                <div class="client-card-header">
                    <div class="client-avatar" id="historyClientAvatar">–ö–õ</div>
                    <div class="client-title-info">
                        <h2 id="historyClientTitle">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
                        <p id="historyClientSubtitle">–ò–Ω–≤–æ–π—Å—ã –∏ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã –∫–ª–∏–µ–Ω—Ç–∞</p>
                    </div>
                    <button class="close" onclick="closeClientProfileModal()" style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; border-radius: 50%; width: 35px; height: 35px;">&times;</button>
                </div>
                
                <div style="padding: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="switchToClientProfile()">‚Üê –û–±—Ä–∞—Ç–Ω–æ –∫ –ø—Ä–æ—Ñ–∏–ª—é</button>
                        <button class="btn btn-primary" onclick="exportClientHistoryToPDF()">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
                    </div>
                    
                    <!-- –í–∫–ª–∞–¥–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ -->
                    <div class="history-tabs" style="margin-bottom: 20px;">
                        <button class="history-tab active" onclick="switchHistoryTab('invoices')" id="invoicesTab">
                            üìã –ò–Ω–≤–æ–π—Å—ã (<span id="invoicesCount">0</span>)
                        </button>
                        <button class="history-tab" onclick="switchHistoryTab('deliveries')" id="deliveriesTab">
                            üì¶ –û—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã (<span id="deliveriesCount">0</span>)
                        </button>
                    </div>
                    
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–Ω–≤–æ–π—Å–æ–≤ -->
                    <div id="clientInvoicesContent" style="max-height: 60vh; overflow-y: auto;">
                        <p style="text-align: center; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                    
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü -->
                    <div id="clientDeliveriesContent" style="max-height: 60vh; overflow-y: auto; display: none;">
                        <p style="text-align: center; color: #666;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ -->
    <div id="clientEditProductModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <button class="close" onclick="closeClientEditProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                    <input type="text" id="clientEditProductName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                </div>
                <div class="form-group">
                    <label>–í–µ—Å (–≥) *</label>
                    <input type="number" id="clientEditProductWeight" placeholder="210" step="0.1" min="0.1">
                </div>
                <input type="hidden" id="clientEditProductInternalCode">
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 25px;">
                <button class="btn btn-primary" onclick="saveClientProductChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="closeClientEditProductModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>



    <script>
        let clients = [], products = [], confirmedInvoices = [], confirmedDeliveries = [], currentInvoiceData = null;

        // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—â–∏–Ω –°–µ—Ä–±–∏–∏ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≥–æ—Ä–æ–¥–∞)
        const allMunicipalities = [
            // –ë–µ–æ–≥—Ä–∞–¥ - –≥—Ä–∞–¥—Å–∫–µ –æ–ø—à—Ç–∏–Ω–µ
            "Barajevo", "Vo≈ædovac", "Vraƒçar", "Grocka", "Zvezdara", "Zemun", "Lazarevac", 
            "Mladenovac", "Novi Beograd", "Obrenovac", "Palilula", "Rakovica", "Savski venac", 
            "Sopot", "Stari grad", "Surƒçin", "ƒåukarica",
            
            // –ì—Ä–∞–¥–æ–≤–∏
            "Novi Sad", "Ni≈°", "Kragujevac", "Subotica", "Panƒçevo", "ƒåaƒçak", "Novi Pazar", 
            "Zrenjanin", "Leskovac", "Bor", "Valjevo", "Vranje", "Vr≈°ac", "Zajeƒçar", 
            "Jagodina", "Kikinda", "Kraljevo", "Kru≈°evac", "Loznica", "Pirot", "Po≈æarevac", 
            "Pri≈°tina", "Prokuplje", "Smederevo", "Sombor", "Sremska Mitrovica", "U≈æice", "≈†abac",
            
            // –ú–µ–¥–∏—ò–∞–Ω–∞, –ü–∞–ª–∏–ª—É–ª–∞ (–ù–∏—à)
            "Medijana", "Pantelej", "Crveni Krst", "Ni≈°ka Banja",
            
            // –í—Ä–∞—ö–µ
            "Vranje grad", "Vranje selo",
            
            // –ü–æ–∂–∞—Ä–µ–≤–∞—Ü
            "Po≈æarevac grad", "Kostolac",
            
            // –£–∂–∏—Ü–µ
            "U≈æice grad", "Sevojno",
            
            // –û–ø—à—Ç–∏–Ω–µ
            "Aleksandrovac", "Aleksinac", "Aranƒëelovac", "Arilje", "Babu≈°nica", "Baƒç", 
            "Baƒçka Palanka", "Baƒçka Topola", "Baƒçko Gradi≈°te", "Bajina Ba≈°ta", "Bela Crkva", 
            "Bela Palanka", "Beoƒçin", "Blace", "Bogatiƒá", "Bojnik", "Boljevac", "Bosilegrad", 
            "Brus", "Bujanovac", "ƒåajetina", "ƒåoka", "ƒÜiƒáevac", "ƒÜuprija", "Despotovac", 
            "Dimitrovgrad", "Doljevac", "Gad≈æin Han", "Golubac", "Gornji Milanovac", "Ivanjica", 
            "Irig", "Kanji≈æa", "Kladovo", "Knja≈æevac", "Kniƒá", "Koceljeva", "Kosjeriƒá", "Kovin", 
            "Krupanj", "Kuƒçevo", "Kur≈°umlija", "Lajkovac", "Lapovo", "Lebane", "Ljig", "Ljubovija", 
            "Luƒçani", "Majdanpek", "Malo Crniƒáe", "Medveƒëa", "Mero≈°ina", "Mionica", "Negotin", 
            "Nova Crnja", "Nova Varo≈°", "Novi Beƒçej", "Novi Kne≈æevac", "Od≈æaci", "Opovo", 
            "Oseƒçina", "Paraƒáin", "Peƒáinci", "Petrovac na Mlavi", "Plandi≈°te", "Po≈æega", 
            "Pre≈°evo", "Priboj", "Prijepolje", "Raƒça", "Ra≈°ka", "Ra≈æanj", "Rekovac", "Ruma", 
            "Seƒçanj", "Senta", "≈†id", "Sjenica", "Sokobanja", "Srbobran", "Sremski Karlovci", 
            "Stara Pazova", "Surdulica", "Svilajnac", "Temerin", "Titel", "Topola", "Trstenik", 
            "Tutin", "Ub", "Varvarin", "Velika Plana", "Vladiƒçin Han", "Vladimirci", "Vlasotince", 
            "Vojnik", "Vrbas", "Vrnjaƒçka Banja", "≈Ωabalj", "≈Ωabari", "≈Ωagubica", "≈Ωiti≈°te", "≈Ωitoraƒëa",
            
            // –ë–∞—á–∫–∏ –ü–µ—Ç—Ä–æ–≤–∞—Ü
            "Baƒçki Petrovac", "Kulpin", "Magliƒá", "Glo≈æan",
            
            // –ê–¥–∞
            "Ada", "Mol", "Obornjaƒça",
            
            // –ê–ª–∏–±—É–Ω–∞—Ä
            "Alibunar", "Banatski Karlovci", "Vladimirovac",
            
            // –ê–ø–∞—Ç–∏–Ω
            "Apatin", "Prigrevica", "Kupusina",
            
            // –ò–Ω—í–∏—ò–∞
            "Inƒëija", "Be≈°ka", "Ljukovo", "Maradik",
            
            // –ú–∞–ª–∏ –ò—í–æ—à
            "Mali Iƒëo≈°", "Lovƒáenac", "Feketiƒá"
        ];

        // –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª–∏—Ü—ã (–æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—Å–µ—Ö –æ–±—â–∏–Ω)
        const commonStreets = [
            "–ì–ª–∞–≤–Ω–∞", "–ö–∞—Ä–∞—í–æ—Ä—í–µ–≤–∞", "–ö—Ä–∞—ô–∞ –ü–µ—Ç—Ä–∞", "–°–≤–µ—Ç–æ–≥ –°–∞–≤–µ", "–ù–µ–º–∞—ö–∏–Ω–∞", 
            "–ö–Ω–µ–∑–∞ –ú–∏–ª–æ—à–∞", "–ñ–µ–ª–µ–∑–Ω–∏—á–∫–∞", "–ü–∞—Ä—Ç–∏–∑–∞–Ω—Å–∫–∞", "–û–º–ª–∞–¥–∏–Ω—Å–∫–∞", "–®–∫–æ–ª—Å–∫–∞",
            "–¢—Ä–≥ –æ—Å–ª–æ–±–æ—í–µ—ö–∞", "Bulevar osloboƒëenja", "–î—É–Ω–∞–≤—Å–∫–∞", "–ú–æ—Ä–∞–≤—Å–∫–∞", 
            "–ü—Ä–≤–æ–º–∞—ò—Å–∫–∞", "–ù–∏–∫–æ–ª–µ –ü–∞—à–∏—õ–∞", "–°–≤–µ—Ç–æ–∑–∞—Ä–∞ –ú–∞—Ä–∫–æ–≤–∏—õ–∞", "–î–∏–º–∏—Ç—Ä–∏—ò–∞ –¢—É—Ü–æ–≤–∏—õ–∞",
            "–à–æ–≤–∞–Ω–∞ –à–æ–≤–∞–Ω–æ–≤–∏—õ–∞ –ó–º–∞—ò–∞", "–í—É–∫–∞ –ö–∞—Ä–∞—ü–∏—õ–∞", "–î–æ—Å–∏—Ç–µ—ò–µ–≤–∞", "–ë—Ä–∞—õ–µ –à—É–≥–æ–≤–∏—õ–∞",
            "–ö–Ω–µ–∑ –ú–∏—Ö–∞–∏–ª–æ–≤–∞", "–¢–µ—Ä–∞–∑–∏—ò–µ", "–°—Ç—É–¥–µ–Ω—Ç—Å–∫–∏ —Ç—Ä–≥", "–°–∫–∞–¥–∞—Ä—Å–∫–∞", "–î—É—à–∞–Ω–æ–≤–∞",
            "–ú–∞—Å–∞—Ä–∏–∫–æ–≤–∞", "–ú–∏–ª–µ—Ç–∏—õ–µ–≤–∞", "–§—Ä—É—à–∫–æ–≥–æ—Ä—Å–∫–∞", "–ë–∞–Ω–∞—Ç—Å–∫–∞", "–í–æ—ò–≤–æ—í–∞–Ω—Å–∫–∞",
            "–°—Ä–µ–º—Å–∫–∞", "–ë–∞—á–∫–∞", "–ó–ª–∞—Ç–∏–±–æ—Ä—Å–∫–∞", "–ö–æ–ø–∞–æ–Ω–∏—á–∫–∞", "–†—É–¥–Ω–∏—á–∫–∞", "–®—É–º–∞–¥–∏—ò—Å–∫–∞",
            "Po≈°tanska", "Maksima Gorkog", "Majke Jevrosime", "Kneza Vi≈°eslava",
            "Bulevar kralja Aleksandra", "Bulevar Nemanjiƒáa", "Bulevar despota Stefana"
        ];

        // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –∏ –æ–±—â–∏–Ω –°–µ—Ä–±–∏–∏
        const addressData = {
            cities: {
                // –ì–†–ê–î–û–í–ò (28 + –ë–µ–æ–≥—Ä–∞–¥)
                "Beograd": {
                    municipalities: ["Barajevo", "Vo≈ædovac", "Vraƒçar", "Grocka", "Zvezdara", "Zemun", "Lazarevac", "Mladenovac", "Novi Beograd", "Obrenovac", "Palilula", "Rakovica", "Savski venac", "Sopot", "Stari grad", "Surƒçin", "ƒåukarica"],
                    streets: {
                        "Stari grad": ["Studentski trg", "Knez Mihailova", "Terazije", "Kralja Petra", "Vasa ƒåarapiƒáa", "Makedonska", "Zeleni venac", "Du≈°anova", "Skadarska", "Kosanƒçiƒáev venac", "Cara Du≈°ana", "Kralja Milana", "Nemanjina", "Resavska", "Balkanska", "Vasina", "Francuska", "U≈æiƒçka", "Pop Lukina", "Dobraƒçina", "Jevremova", "Gospodar Jevremova", "Admirala Geprata", "Gavrila Principa", "Pariska", "Strahinjiƒáa Bana", "Rajiƒáeva", "Tadeu≈°a Ko≈°ƒáu≈°ka", "ƒåika Ljubina", "Bulevar despota Stefana", "Hilandarska", "Simina", "Braƒáe Jugoviƒáa", "Svetogorska", "Dzordza Va≈°ingtona", "Vi≈°egradska", "Prizrenska", "Cara Nikolaja II", "Zmaj Jovina", "Braƒáe Baruh", "Kolarƒçeva", "Venizelosova", "Majke Jevrosime", "ƒåumiƒáeva", "Dimitrija Tucoviƒáa", "Dunavska", "Obilicev venac", "Strahiniƒáa Bana"],
                        "Novi Beograd": ["Bulevar Zorana ƒêinƒëiƒáa", "Bulevar Mihajla Pupina", "Jurija Gagarina", "Gandijeva", "Milentija Popoviƒáa", "Antifa≈°istiƒçke borbe", "Bulevar Arsenija ƒåarnojeviƒáa", "Dr Ivana Ribara", "Omladinskih brigada", "Narodnih heroja", "To≈°in bunar", "Bulevar Nikole Tesle", "Vladimira Popoviƒáa", "ƒêorƒëa Stanojeviƒáa", "Nehruova", "Save Kovaƒçeviƒáa", "Kornelija Stankoviƒáa", "Partizanske avijacije"],
                        "Vo≈ædovac": ["Bulevar osloboƒëenja", "Ustaniƒçka", "Veljka Dugo≈°eviƒáa", "Autoput za Ni≈°", "Kumodra≈°ka", "Crnotravska", "Tre≈°njinog cveta", "Patrijarha Dimitrija", "Ju≈æni bulevar", "Medakoviƒáeva", "Braƒáe Jerkoviƒá", "Vojvode Stepe", "Humska", "Banjiƒçka"],
                        "Vraƒçar": ["Bulevar kralja Aleksandra", "Krunska", "Kneginje Zorke", "Svetosavska", "Njego≈°eva", "ƒåarlija ƒåaplina", "Maksima Gorkog", "Karaƒëorƒëeva", "Beogradska", "Neimarska", "Despota Stefana", "Kataniƒáeva", "Kralja Milana", "Deƒçanska"],
                        "Zvezdara": ["Bulevar kralja Aleksandra", "Dimitrija Tucoviƒáa", "Milana Rakiƒáa", "Cvijiƒáeva", "Veljka Vlahoviƒáa", "Dragoslava Srejoviƒáa", "Alekse Nenadoviƒáa", "Ruzveltova", "Uƒçiteljska", "Bulevar Mihajla Pupina", "Djure Jak≈°iƒáa"],
                        "Zemun": ["Glavna", "Cara Du≈°ana", "Zemunski kej", "Magistratski trg", "Karamatina", "Dubrovaƒçka", "Gorkoga", "To≈°in bunar", "Batajniƒçki drum", "Ugrinovaƒçka", "Beƒçkereƒçka", "Prvomajska"],
                        "ƒåukarica": ["Po≈æe≈°ka", "Patrijarha Dimitrija", "Kneza Vi≈°eslava", "Ibarska magistrala", "Radniƒçka", "Banovo brdo", "ƒåukariƒçka", "Banjica", "Sremƒçica", "≈Ωelezniƒçka"],
                        "Palilula": ["Dunavska", "Francuska", "Visokog Stevana", "Uƒçiteljska", "Dalmatinska", "Cara Nikolaja II", "Bulevar despota Stefana", "Ruzveltova", "Vi≈°njiƒáeva", "Tadeu≈°a Ko≈°ƒáu≈°ka"],
                        "Savski venac": ["Nemanjina", "Karaƒëorƒëeva", "Bulevar vojvode Mi≈°iƒáa", "Kneza Milo≈°a", "Sarajevska", "Hajduk Veljkova", "Gavrila Principa", "Resavska", "Prizrenska", "Svetog Save"],
                        "Rakovica": ["Borska", "Patrijarha Dimitrija", "Rakoviƒçka", "Ibarska magistrala", "Kneza Vi≈°eslava", "Trgovaƒçka", "Milo≈°a Obrenoviƒá", "Crnotravska"],
                        "Grocka": ["Smederevski put", "Boljevaƒçka", "Grocka", "Pukovnika Milenka Pavloviƒáa", "Viniƒçka", "Boleƒç", "Begaljica"],
                        "Lazarevac": ["Kralja Petra", "Svetog Save", "Trg osloboƒëenja", "Nemanjina", "Bulevar osloboƒëenja", "Ibarska magistrala", "Stevan Mokranjac"],
                        "Mladenovac": ["Kralja Aleksandra", "Svetog Save", "Nemanjina", "Trg osloboƒëenja", "Karaƒëorƒëeva", "Kosmajska", "Jagodinska"],
                        "Obrenovac": ["Kralja Petra", "Milo≈°a Obrenoviƒáa", "Vuka Karad≈æiƒáa", "Cara Lazara", "Trg osloboƒëenja", "Obiliƒáeva", "Zmaj Jovina"],
                        "Sopot": ["Sopot", "Kosmajska", "Nemenikuƒáe", "Duƒçina", "Parcani", "Rogaƒça"],
                        "Surƒçin": ["Surƒçin", "Beƒçkereƒçka", "Dobanovci", "Petrovƒçiƒá", "Boljevci", "Jakovo"],
                        "Barajevo": ["Barajevo", "Arnajevo", "Bo≈ædarevac", "Guncati", "Maniƒá", "≈†iljakovac"]
                    }
                },
                "Novi Sad": {
                    municipalities: ["Novi Sad"],
                    streets: {
                        "Novi Sad": ["Bulevar osloboƒëenja", "Zmaj Jovina", "Dunavska", "Kralja Aleksandra", "Miletiƒáeva", "Futo≈°ka", "Bulevar cara Lazara", "Narodnog fronta", "Stra≈æe Novosadske", "Jevrejska", "Katoliƒçka porta", "Grƒçka", "Masarikova", "Jovana ƒêorƒëeviƒáa", "Modene", "Ilije Ognjanoviƒáa", "Svetozara Miletiƒáa", "Vladimira Nazora", "Kisaƒçka", "Bulevar Evrope"]
                    }
                },
                "Ni≈°": {
                    municipalities: ["Medijana", "Palilula", "Pantelej", "Crveni Krst", "Ni≈°ka Banja"],
                    streets: {
                        "Medijana": ["Bulevar Nemanjiƒáa", "Obrenoviƒáeva", "Vozda Karaƒëorƒëa", "Dr Zoran ƒêinƒëiƒá", "Bulevar 12. februar", "Du≈°anova", "Kneginje Ljubice"],
                        "Palilula": ["Cara Du≈°ana", "Bulevar Evrope", "Ja≈°e Prodanoviƒáa", "Stevana Mokranjca", "Vojvode Tankosiƒáa", "Had≈æi Milentijeva"],
                        "Pantelej": ["Bulevar Nemanjiƒáa", "Partizanska", "ƒÜirila i Metodija", "Stevana Sremca", "Kneginje Milice"],
                        "Crveni Krst": ["Bulevar Evrope", "Partizanska", "Vojvode Tankosiƒáa", "Stevana Mokranjca"],
                        "Ni≈°ka Banja": ["Sinƒëeliƒáeva", "Dr Milutina Ivkoviƒáa", "≈Ωelezniƒçka", "Knjeginje Milice"]
                    }
                },
                "Kragujevac": {
                    municipalities: ["Kragujevac"],
                    streets: {
                        "Kragujevac": ["Kralja Aleksandra", "Svetozara Markoviƒáa", "Dositejeva", "Bulevar kraljice Marije", "Jovana Cvijiƒáa", "Kneza Mihaila", "Nikole Pa≈°iƒáa", "Cara Lazara", "ƒêure ƒêakoviƒáa", "Kralja Petra"]
                    }
                },
                "Subotica": {
                    municipalities: ["Subotica"],
                    streets: {
                        "Subotica": ["Trg slobode", "Korzo", "Matice srpske", "Segedinski put", "Cara Lazara", "Maksima Gorkog", "ƒêure ƒêakoviƒáa", "Ra≈°e Konƒçara", "Somborska", "Banatska"]
                    }
                },
                "Panƒçevo": {
                    municipalities: ["Panƒçevo"],
                    streets: {
                        "Panƒçevo": ["Trg kralja Petra", "≈Ωelezniƒçka", "Svetog Save", "Cara Lazara", "Dimitrija Tucoviƒáa", "Vojvodine", "Milo≈°a Trebinjca", "Braƒáe Jovanoviƒá", "ƒêure ƒêakoviƒáa"]
                    }
                },
                "ƒåaƒçak": {
                    municipalities: ["ƒåaƒçak"],
                    streets: {
                        "ƒåaƒçak": ["Bulevar oslobodilaca", "Kneza Mihaila", "≈Ωiƒçka", "Cara Du≈°ana", "Svetog Save", "Nikole Pa≈°iƒáa", "Prvomajska", "Dimitrija Tucoviƒáa"]
                    }
                },
                "Novi Pazar": {
                    municipalities: ["Novi Pazar"],
                    streets: {
                        "Novi Pazar": ["28. novembar", "Stevana Nemanje", "Rifata Burd≈æoviƒáa", "Alije Izetbegoviƒáa", "Generala ≈Ωivkoviƒáa", "Vuka Karad≈æiƒáa", "Sutjeska"]
                    }
                },
                "Zrenjanin": {
                    municipalities: ["Zrenjanin"],
                    streets: {
                        "Zrenjanin": ["Trg slobode", "Kralja Aleksandra", "ƒêure ƒêakoviƒáa", "Bulevar ƒêorƒëa Vajferta", "Seƒçanj", "Dimitrija Tucoviƒáa", "Maksima Gorkog"]
                    }
                },
                "Leskovac": {
                    municipalities: ["Leskovac"],
                    streets: {
                        "Leskovac": ["Bulevar osloboƒëenja", "Stevana Mokranjca", "Cara Du≈°ana", "Nikole Pa≈°iƒáa", "Bulevar heroes", "≈Ωitni trg", "Svetozara Markoviƒáa"]
                    }
                },
                "Bor": {
                    municipalities: ["Bor"],
                    streets: {
                        "Bor": ["Mo≈°e Pijade", "7. jula", "ƒêorƒëa Vajferta", "Trg osloboƒëenja", "Kralja Petra"]
                    }
                },
                "Valjevo": {
                    municipalities: ["Valjevo"],
                    streets: {
                        "Valjevo": ["Karaƒëorƒëeva", "Vladike Nikolaja", "Birƒçaninova", "Vojvode Mi≈°iƒáa", "Kneza Milo≈°a"]
                    }
                },
                "Vranje": {
                    municipalities: ["Vranje grad", "Vranje selo"],
                    streets: {
                        "Vranje grad": ["Kralja Stefana Prvovenƒçanog", "Svetozara Markoviƒáa", "Prvomajska", "Kralja Aleksandra", "Titova"],
                        "Vranje selo": ["Seoska ulica", "Glavna", "Centralna"]
                    }
                },
                "Vr≈°ac": {
                    municipalities: ["Vr≈°ac"],
                    streets: {
                        "Vr≈°ac": ["Svetosavska", "Trg pobede", "Heroja Pinkija", "Abrahama Linkolna", "Vojvoƒëanska"]
                    }
                },
                "Zajeƒçar": {
                    municipalities: ["Zajeƒçar"],
                    streets: {
                        "Zajeƒçar": ["Kralja Aleksandra", "Svetozara Markoviƒáa", "Hajduk Veljkova", "Nikole Pa≈°iƒáa", "Kneginje Ljubice"]
                    }
                },
                "Jagodina": {
                    municipalities: ["Jagodina"],
                    streets: {
                        "Jagodina": ["Kneginje Milice", "Svetozara Markoviƒáa", "Karadjordjeva", "Kralja Petra", "Nikole Pa≈°iƒáa"]
                    }
                },
                "Kikinda": {
                    municipalities: ["Kikinda"],
                    streets: {
                        "Kikinda": ["Trg srpskih dobrovoljaca", "Svetosavska", "Gospodara Vuƒçiƒáa", "Seƒçeranska", "≈Ωarka Zrenjanina"]
                    }
                },
                "Kraljevo": {
                    municipalities: ["Kraljevo"],
                    streets: {
                        "Kraljevo": ["Kraljice Marije", "Karaƒëorƒëeva", "Omladinska", "Trg srpskih ratnika", "Nemanjina"]
                    }
                },
                "Kru≈°evac": {
                    municipalities: ["Kru≈°evac"],
                    streets: {
                        "Kru≈°evac": ["Kneza Milo≈°a", "Gazimestanska", "Vidovdanska", "ƒÜele kule", "Majke Jugoviƒáa"]
                    }
                },
                "Loznica": {
                    municipalities: ["Loznica"],
                    streets: {
                        "Loznica": ["Kneza Milo≈°a", "Karaƒëorƒëeva", "Vuka Karad≈æiƒáa", "Pasiƒáeva", "Jovan Cvijiƒá"]
                    }
                },
                "Pirot": {
                    municipalities: ["Pirot"],
                    streets: {
                        "Pirot": ["Srpskih vladara", "Kralja Petra", "Nikole Pa≈°iƒáa", "Trg pobede", "Beogradska"]
                    }
                },
                "Po≈æarevac": {
                    municipalities: ["Po≈æarevac grad", "Kostolac"],
                    streets: {
                        "Po≈æarevac grad": ["Dunavska", "Karaƒëorƒëeva", "Svetozara Markoviƒáa", "Kneza Milo≈°a", "Drinƒçiƒáeva"],
                        "Kostolac": ["Glavna", "Termoelektrane", "Rudarska", "Drinƒçiƒáeva"]
                    }
                },
                "Pri≈°tina": {
                    municipalities: ["Pri≈°tina"],
                    streets: {
                        "Pri≈°tina": ["Kralja Petra", "Lole Ribara", "Omladinska", "Deƒçanska", "Vidovdanska"]
                    }
                },
                "Prokuplje": {
                    municipalities: ["Prokuplje"],
                    streets: {
                        "Prokuplje": ["Topliƒçina", "Karaƒëorƒëeva", "Vojvode Stepe", "Svetog Save", "Nikole Pa≈°iƒáa"]
                    }
                },
                "Smederevo": {
                    municipalities: ["Smederevo"],
                    streets: {
                        "Smederevo": ["Kralja Petra", "Dunavska", "Omladinska", "ƒêuri≈°ka", "Svetog ƒêorƒëa"]
                    }
                },
                "Sombor": {
                    municipalities: ["Sombor"],
                    streets: {
                        "Sombor": ["Trg cara Uro≈°a", "–ê–ø–∞—Ç–∏–Ω—Å–∫–∏ –ø—É—Ç", "–í–µ–Ω–∞—Ü –≤–æ—ò–≤–æ–¥–µ –°—Ç–µ–ø–µ", "–í–æ—ò–≤–æ–¥–µ –ü—É—Ç–Ω–∏–∫–∞", "–ö–Ω–µ–∑–∞ –ú–∏—Ö–∞–∏–ª–∞"]
                    }
                },
                "Sremska Mitrovica": {
                    municipalities: ["Sremska Mitrovica"],
                    streets: {
                        "Sremska Mitrovica": ["–°–≤–µ—Ç–æ–≥ –î–∏–º–∏—Ç—Ä–∏—ò–∞", "–ö—Ä–∞—ô–∞ –ü–µ—Ç—Ä–∞", "–ñ–µ–ª–µ–∑–Ω–∏—á–∫–∞", "–§—Ä—É—à–∫–æ–≥–æ—Ä—Å–∫–∞", "–í–æ—ò–≤–æ—í–∞–Ω—Å–∫–∞"]
                    }
                },
                "U≈æice": {
                    municipalities: ["U≈æice grad", "Sevojno"],
                    streets: {
                        "U≈æice grad": ["–ü–∞—Ä—Ç–∏–∑–∞–Ω—Å–∫–∞", "–î–∏–º–∏—Ç—Ä–∏—ò–∞ –¢—É—Ü–æ–≤–∏—õ–∞", "–ú–∏–ª–æ—à–∞ –û–±–∏–ª–∏—õ–∞", "–¢—Ä–≥ –ø–∞—Ä—Ç–∏–∑–∞–Ω–∞", "–ù–µ–º–∞—ö–∏–Ω–∞"],
                        "Sevojno": ["–ó–ª–∞—Ç–∏–±–æ—Ä—Å–∫–∞", "–ú–∏–ª–∞–Ω–∞ –†–∞–∫–∏—õ–∞", "–°–≤–µ—Ç–æ–≥ –°–∞–≤–µ", "–ñ–µ–ª–µ–∑–Ω–∏—á–∫–∞"]
                    }
                },
                "≈†abac": {
                    municipalities: ["≈†abac"],
                    streets: {
                        "≈†abac": ["–ö–∞—Ä–∞—í–æ—Ä—í–µ–≤–∞", "–ú–∞—Å–∞—Ä–∏–∫–æ–≤–∞", "–•–∞—ò–¥—É–∫ –í–µ—ô–∫–æ–≤–∞", "–¢—Ä–≥ –æ—Å–ª–æ–±–æ—í–µ—ö–∞", "–í–æ—ò–≤–æ–¥–µ –ú–∏—à–∏—õ–∞"]
                    }
                },
                // –í–ï–ã–ò –û–ü–®–¢–ò–ù–°–ö–ò –¶–ï–ù–¢–†–ò
                "Aleksandrovac": {
                    municipalities: ["Aleksandrovac"],
                    streets: {
                        "Aleksandrovac": ["–ö–∞—Ä–∞—í–æ—Ä—í–µ–≤–∞", "–ì–ª–∞–≤–Ω–∞", "–ñ—É–ø—Å–∫–∞", "–ù–µ–º–∞—ö–∏–Ω–∞", "–¢–æ–ø–ª–∏—á–∫–∞"]
                    }
                },
                "Aleksinac": {
                    municipalities: ["Aleksinac"],
                    streets: {
                        "Aleksinac": ["–ö–∞—Ä–∞—í–æ—Ä—í–µ–≤–∞", "–ú–æ—Ä–∞–≤—Å–∫–∞", "–ö—Ä–∞—ô–µ–≤—Å–∫–∞", "–ù–µ–º–∞—ö–∏–Ω–∞", "–°–≤–µ—Ç–æ–≥ –°–∞–≤–µ"]
                    }
                },
                "Aranƒëelovac": {
                    municipalities: ["Aranƒëelovac"],
                    streets: {
                        "Aranƒëelovac": ["–ö–∞—Ä–∞—í–æ—Ä—í–µ–≤–∞", "–ö—Ä–∞—ô–∞ –ü–µ—Ç—Ä–∞", "–ë–∞—ö—Å–∫–∞", "–ö–Ω–µ–∑–∞ –ú–∏–ª–æ—à–∞", "–û–º–ª–∞–¥–∏–Ω—Å–∫–∞"]
                    }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            setCurrentDate();
            generateDocumentNumbers();
            initializeStatistics();
            updateSelectOptions();
            initializeAddressSearch();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–ª–∞–¥—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            renderProductGroups();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–∞ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
            document.getElementById('differentDeliveryAddress').addEventListener('change', function() {
                const section = document.getElementById('deliveryAddressSection');
                if (this.checked) {
                    section.style.display = 'block';
                    initializeDeliveryAddressSearch();
                } else {
                    section.style.display = 'none';
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∏–Ω–≤–æ–π—Å–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
            const invoiceClientSelect = document.getElementById('invoiceClient');
            if (invoiceClientSelect) {
                invoiceClientSelect.addEventListener('change', function() {
                    // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
                    document.querySelectorAll('.invoice-product-search').forEach(input => {
                        input.value = '';
                        const hidden = input.closest('.searchable-select').querySelector('.invoice-product');
                        if (hidden) hidden.value = '';
                        const dropdown = input.closest('.searchable-select').querySelector('.invoice-product-dropdown');
                        if (dropdown) dropdown.style.display = 'none';
                    });
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
            const deliveryClientSelect = document.getElementById('deliveryClient');
            if (deliveryClientSelect) {
                deliveryClientSelect.addEventListener('change', function() {
                    // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
                    document.querySelectorAll('.delivery-product-search').forEach(input => {
                        input.value = '';
                        const hidden = input.closest('.searchable-select').querySelector('.delivery-product');
                        if (hidden) hidden.value = '';
                        const dropdown = input.closest('.searchable-select').querySelector('.delivery-product-dropdown');
                        if (dropdown) dropdown.style.display = 'none';
                    });
                });
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–∞ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞
            document.getElementById('manualAddressInput').addEventListener('change', function() {
                const automaticSection = document.getElementById('automaticAddressSection');
                const manualSection = document.getElementById('manualAddressSection');
                
                if (this.checked) {
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
                    automaticSection.style.display = 'none';
                    manualSection.style.display = 'block';
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
                    document.getElementById('clientCity').value = '';
                    document.getElementById('clientMunicipality').value = '';
                    document.getElementById('clientStreet').value = '';
                    document.getElementById('clientHouseNumber').value = '';
                } else {
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–≤–æ–¥
                    automaticSection.style.display = 'block';
                    manualSection.style.display = 'none';
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
                    document.getElementById('clientManualAddress').value = '';
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
                    const municipalityInput = document.getElementById('clientMunicipality');
                    const streetInput = document.getElementById('clientStreet');
                    if (municipalityInput) {
                        municipalityInput.disabled = true;
                        municipalityInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –≥–æ—Ä–æ–¥...';
                    }
                    if (streetInput) {
                        streetInput.disabled = true;
                        streetInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –æ–±—â–∏–Ω—É...';
                    }
                }
            });

            // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('invoiceViewModal');
                if (modal && e.target === modal) {
                    closeInvoiceViewModal();
                }
            });

            // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('invoiceViewModal');
                    if (modal) {
                        closeInvoiceViewModal();
                    }
                }
            });
        });

        function initializeAddressSearch() {
            setupCitySearch('clientCity', 'clientCityDropdown', 'clientMunicipality', 'clientMunicipalityDropdown', 'clientStreet', 'clientStreetDropdown');
        }

        function initializeDeliveryAddressSearch() {
            setupCitySearch('deliveryCity', 'deliveryCityDropdown', 'deliveryMunicipality', 'deliveryMunicipalityDropdown', 'deliveryStreet', 'deliveryStreetDropdown');
        }

        function setupCitySearch(cityInputId, cityDropdownId, municipalityInputId, municipalityDropdownId, streetInputId, streetDropdownId) {
            const cityInput = document.getElementById(cityInputId);
            const cityDropdown = document.getElementById(cityDropdownId);
            const municipalityInput = document.getElementById(municipalityInputId);
            const municipalityDropdown = document.getElementById(municipalityDropdownId);
            const streetInput = document.getElementById(streetInputId);
            const streetDropdown = document.getElementById(streetDropdownId);

            if (!cityInput || !cityDropdown) return;

            // –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–æ–≤ - –ë–ï–ó–û–ü–ê–°–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
            const cityInputHandler = function() {
                const query = this.value.toLowerCase();
                
                if (query.length === 0) {
                    cityDropdown.style.display = 'none';
                    enableMunicipalityInput();
                    return;
                }

                const filteredCities = Object.keys(addressData.cities).filter(city => 
                    city.toLowerCase().includes(query)
                );

                if (filteredCities.length === 0) {
                    cityDropdown.style.display = 'none';
                    return;
                }

                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ dropdown
                Array.from(cityDropdown.children).forEach(child => {
                    EventManager.removeAllForElement(child);
                });

                cityDropdown.innerHTML = '';
                filteredCities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.textContent = city;
                    
                    const clickHandler = function() {
                        cityInput.value = city;
                        cityDropdown.style.display = 'none';
                        enableMunicipalityInput();
                    };
                    
                    EventManager.add(item, 'click', clickHandler);
                    cityDropdown.appendChild(item);
                });

                cityDropdown.style.display = 'block';
            };
            
            const cityBlurHandler = function() {
                setTimeout(() => {
                    cityDropdown.style.display = 'none';
                }, 200);
            };

            EventManager.add(cityInput, 'input', cityInputHandler);
            EventManager.add(cityInput, 'blur', cityBlurHandler);

            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª–µ –æ–±—â–∏–Ω –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞
            function enableMunicipalityInput() {
                if (!municipalityInput || !municipalityDropdown) return;
                
                municipalityInput.disabled = false;
                municipalityInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—â–∏–Ω—ã...';
                municipalityInput.value = '';
                
                setupMunicipalitySearch();
            }

            function setupMunicipalitySearch() {
                if (!municipalityInput || !municipalityDropdown) return;

                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                const newMunicipalityInput = municipalityInput.cloneNode(true);
                municipalityInput.parentNode.replaceChild(newMunicipalityInput, municipalityInput);
                const updatedMunicipalityInput = document.getElementById(municipalityInputId);
                const updatedMunicipalityDropdown = document.getElementById(municipalityDropdownId);

                updatedMunicipalityInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    
                    if (query.length === 0) {
                        updatedMunicipalityDropdown.style.display = 'none';
                        resetStreet();
                        return;
                    }

                    const filteredMunicipalities = allMunicipalities.filter(municipality => 
                        municipality.toLowerCase().includes(query)
                    );

                    if (filteredMunicipalities.length === 0) {
                        updatedMunicipalityDropdown.style.display = 'none';
                        return;
                    }

                    updatedMunicipalityDropdown.innerHTML = '';
                    filteredMunicipalities.forEach(municipality => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = municipality;
                        item.addEventListener('click', function() {
                            updatedMunicipalityInput.value = municipality;
                            updatedMunicipalityDropdown.style.display = 'none';
                            enableStreetInput();
                        });
                        updatedMunicipalityDropdown.appendChild(item);
                    });

                    updatedMunicipalityDropdown.style.display = 'block';
                });

                updatedMunicipalityInput.addEventListener('focus', function() {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –æ–±—â–∏–Ω—ã –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
                    updatedMunicipalityDropdown.innerHTML = '';
                    allMunicipalities.forEach(municipality => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = municipality;
                        item.addEventListener('click', function() {
                            updatedMunicipalityInput.value = municipality;
                            updatedMunicipalityDropdown.style.display = 'none';
                            enableStreetInput();
                        });
                        updatedMunicipalityDropdown.appendChild(item);
                    });
                    updatedMunicipalityDropdown.style.display = 'block';
                });

                updatedMunicipalityInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        updatedMunicipalityDropdown.style.display = 'none';
                    }, 200);
                });
            }

            function enableStreetInput() {
                if (!streetInput || !streetDropdown) return;
                
                streetInput.disabled = false;
                streetInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã...';
                streetInput.value = '';
                
                setupStreetSearch();
            }

            function setupStreetSearch() {
                if (!streetInput || !streetDropdown) return;

                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                const newStreetInput = streetInput.cloneNode(true);
                streetInput.parentNode.replaceChild(newStreetInput, streetInput);
                const updatedStreetInput = document.getElementById(streetInputId);
                const updatedStreetDropdown = document.getElementById(streetDropdownId);

                updatedStreetInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    
                    if (query.length === 0) {
                        updatedStreetDropdown.style.display = 'none';
                        return;
                    }

                    const filteredStreets = commonStreets.filter(street => 
                        street.toLowerCase().includes(query)
                    );

                    if (filteredStreets.length === 0) {
                        updatedStreetDropdown.style.display = 'none';
                        return;
                    }

                    updatedStreetDropdown.innerHTML = '';
                    filteredStreets.forEach(street => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = street;
                        item.addEventListener('click', function() {
                            updatedStreetInput.value = street;
                            updatedStreetDropdown.style.display = 'none';
                        });
                        updatedStreetDropdown.appendChild(item);
                    });

                    updatedStreetDropdown.style.display = 'block';
                });

                updatedStreetInput.addEventListener('focus', function() {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —É–ª–∏—Ü—ã –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
                    updatedStreetDropdown.innerHTML = '';
                    commonStreets.forEach(street => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.textContent = street;
                        item.addEventListener('click', function() {
                            updatedStreetInput.value = street;
                            updatedStreetDropdown.style.display = 'none';
                        });
                        updatedStreetDropdown.appendChild(item);
                    });
                    updatedStreetDropdown.style.display = 'block';
                });

                updatedStreetInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        updatedStreetDropdown.style.display = 'none';
                    }, 200);
                });
            }

            function resetStreet() {
                if (streetInput) {
                    streetInput.value = '';
                    streetInput.disabled = true;
                    streetInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –æ–±—â–∏–Ω—É...';
                }
            }
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
        function safeLocalStorage(operation, key, data = null) {
            try {
                switch (operation) {
                    case 'get':
                        const item = localStorage.getItem(key);
                        return item ? JSON.parse(item) : null;
                    case 'set':
                        localStorage.setItem(key, JSON.stringify(data));
                        return true;
                    case 'remove':
                        localStorage.removeItem(key);
                        return true;
                    default:
                        console.error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è localStorage:', operation);
                        return null;
                }
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ localStorage (${operation}, ${key}):`, error);
                
                // –ï—Å–ª–∏ localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (error.name === 'QuotaExceededError') {
                    console.warn('localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ...');
                    try {
                        // –£–¥–∞–ª—è–µ–º –ª–æ–≥–∏ (–æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –±–æ–ª—å—à–∏–º–∏)
                        localStorage.removeItem('logs');
                        localStorage.removeItem('actionLogs');
                        // –ü—ã—Ç–∞–µ–º—Å—è —Å–Ω–æ–≤–∞
                        if (operation === 'set') {
                            localStorage.setItem(key, JSON.stringify(data));
                            return true;
                        }
                    } catch (retryError) {
                        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:', retryError);
                        showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞.', 'danger');
                    }
                }
                return null;
            }
        }

        function loadInitialData() {
            // –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–• –î–ê–ù–ù–´–•
            console.log('=== –ü–û–õ–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –í–°–ï–• –î–ê–ù–ù–´–• ===');
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
            localStorage.removeItem('confirmedInvoices');
            localStorage.removeItem('confirmedDeliveries');
            localStorage.removeItem('clientProductGroups');
            localStorage.removeItem('clientProducts');
            localStorage.removeItem('clientSalesHistory');
            localStorage.removeItem('actionLogs');
            
            // –û—á–∏—â–∞–µ–º –∫–ª–∏–µ–Ω—Ç-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–∫–ª–∞–¥—ã
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('clientProductGroups_')) {
                    localStorage.removeItem(key);
                    i--; // –£–º–µ–Ω—å—à–∞–µ–º –∏–Ω–¥–µ–∫—Å, —Ç–∞–∫ –∫–∞–∫ –¥–ª–∏–Ω–∞ localStorage –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
                }
            }
            localStorage.removeItem('users');
            localStorage.removeItem('builtInPermissions');
            localStorage.removeItem('productGroups');
            
            console.log('–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã –∏–∑ localStorage');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã
            confirmedInvoices = [];
            confirmedDeliveries = [];
            window.confirmedInvoices = confirmedInvoices;
            window.confirmedDeliveries = confirmedDeliveries;
            
            clients = [
                { name: "SVDA DOO", mb: "22058282", pib: "114703885", address: "Beograd, Stari grad, Majke Jevrosime 19", contact: "", bank: "", city: "Beograd", municipality: "Stari grad", street: "Majke Jevrosime", houseNumber: "19" },
                { name: "AUDITORIA DOO BEOGRAD", mb: "22043277", pib: "114586673", address: "Beograd, Vo≈ædovac, Vojvode Dobrnca 48", contact: "", bank: "190-0000000097100 (–ê–ª—Ç–∞ –±–∞–Ω–∫–∞ –ê.–î.)", city: "Beograd", municipality: "Vo≈ædovac", street: "Vojvode Dobrnca", houseNumber: "48" },
                { name: "Aleksandra Tarasenko PR", mb: "67249208", pib: "114000935", address: "Novi Sad, Novi Sad, Masarikova 18", contact: "Ugostiteljska radnja Seal & Tea", bank: "", city: "Novi Sad", municipality: "Novi Sad", street: "Masarikova", houseNumber: "18" },
                { name: "Vera Organic Coffee and Tea doo", mb: "21886866", pib: "113543561", address: "Beograd, Stari grad, Nikole Spasiƒáa 4", contact: "avmofficebg@gmail.com, 063/773-6698", bank: "", city: "Beograd", municipality: "Stari grad", street: "Nikole Spasiƒáa", houseNumber: "4" },
                { name: "ƒåETIRI COFFEE DOO", mb: "22057146", pib: "114695557", address: "Beograd, Stari grad, Terazije 36", contact: "", bank: "", city: "Beograd", municipality: "Stari grad", street: "Terazije", houseNumber: "36" }
            ];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage (–µ—Å–ª–∏ –µ—Å—Ç—å)
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–æ–π—Å—ã
            const savedInvoices = localStorage.getItem('confirmedInvoices');
            if (savedInvoices) {
                try {
                    confirmedInvoices = JSON.parse(savedInvoices);
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–Ω–≤–æ–π—Å–æ–≤:', confirmedInvoices.length);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–æ–π—Å–æ–≤:', e);
                    confirmedInvoices = [];
                }
            }
            window.confirmedInvoices = confirmedInvoices;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã
            const savedDeliveries = localStorage.getItem('confirmedDeliveries');
            if (savedDeliveries) {
                try {
                    confirmedDeliveries = JSON.parse(savedDeliveries);
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü:', confirmedDeliveries.length);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü:', e);
                    confirmedDeliveries = [];
                }
            }
            window.confirmedDeliveries = confirmedDeliveries;

            products = [
                { code: "GF-B-TG210", name: "Tieguanyin/Zeleni ƒåaj 210g", price: 2297, category: "Zeleni ƒåaj" },
                { code: "GF-B-EG210", name: "Earl Grey/Crni ƒåaj 210g", price: 1850, category: "Crni ƒåaj" },
                { code: "GF-G-JG210", name: "Jasmine Green Beverage/Zeleni ƒåaj 210g", price: 1837, category: "Zeleni ƒåaj" },
                { code: "GF-G-SN210", name: "Sencha/Zeleni ƒåaj 210g", price: 1575, category: "Zeleni ƒåaj" },
                { code: "GF-B-MO210", name: "Milky Oolong/Zeleni ƒåaj 210g", price: 2167, category: "Zeleni ƒåaj" },
                { code: "FJN-B-DHP210", name: "Da Hong Pao/Crni ƒåaj 210g", price: 2691, category: "Crni ƒåaj" },
                { code: "FJN-B-GAB210", name: "Gaba Oolong –ê–ê/Crni ƒåaj 210g", price: 4854, category: "Crni ƒåaj" },
                { code: "FJN-B-DHP28", name: "Da Hong Pao/Crni ƒåaj 28g", price: 359, category: "Crni ƒåaj" },
                { code: "GF-W-BMD28", name: "Bai mu dan/Zeleni ƒåaj 28g", price: 332, category: "Zeleni ƒåaj" },
                { code: "FJN-B-TG28", name: "Tieguanyin/Zeleni ƒåaj 28g", price: 307, category: "Zeleni ƒåaj" },
                { code: "CHC-B-LS28", name: "Lapsang Souchong Black Tea/Crni ƒåaj 28g", price: 315, category: "Crni ƒåaj" },
                { code: "CHC-G-MPC25-5", name: "Golden tocha round Pu Erh/Crni ƒåaj 5g", price: 62, category: "Crni ƒåaj" },
                { code: "CHC-PU-RS10", name: "Puer Chagao Resin Round/Crni ƒåaj 1g", price: 32, category: "Crni ƒåaj" },
                { code: "FJN-B-GAB28", name: "Gaba Oolong –ê–ê/Crni ƒåaj 28g", price: 648, category: "Crni ƒåaj" },
                { code: "FJN-B-MO28", name: "Milky Oolong/Zeleni ƒåaj 28g", price: 289, category: "Zeleni ƒåaj" },
                { code: "GF-B-EG28", name: "Earl Grey/Crni ƒåaj 28g", price: 307, category: "Crni ƒåaj" },
                { code: "GF-G-SN28", name: "Sencha/Zeleni ƒåaj 28g", price: 210, category: "Zeleni ƒåaj" },
                { code: "GF-G-JG28", name: "Jasmine Green Beverage/Zeleni ƒåaj 28g", price: 245, category: "Zeleni ƒåaj" },
                { code: "CHC-B-LS210", name: "Lapsang Souchong Black Tea/Crni ƒåaj 210g", price: 2100, category: "Crni ƒåaj" },
                { code: "GF-B-KM210", name: "Keemum/Crni ƒåaj 210g", price: 1950, category: "Crni ƒåaj" }
            ];
            renderClientsTable();
            renderProductsTable();
            updateDeliveryClientFilter();
            updateDeliveriesList();
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const nextWeekStr = nextWeek.toISOString().split('T')[0];

            document.getElementById('invoiceDate').value = today;
            document.getElementById('invoiceDueDate').value = nextWeekStr;
            document.getElementById('deliveryDate').value = today;
            document.getElementById('deliveryDueDate').value = nextWeekStr;
        }

        function generateUniqueDocumentNumber(existingNumbers, prefix = '') {
            const today = new Date();
            const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear()}`;
            
            let counter = 1;
            let number = `${counter}-${dateStr}`;
            if (prefix) {
                number = `${prefix}-${counter}-${dateStr}`;
            }
            
            while (existingNumbers.includes(number)) {
                counter++;
                number = prefix ? `${prefix}-${counter}-${dateStr}` : `${counter}-${dateStr}`;
            }
            
            return number;
        }

        function generateDocumentNumbers() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
            const existingInvoiceNumbers = confirmedInvoices.map(inv => inv.number);
            const invoiceNumber = generateUniqueDocumentNumber(existingInvoiceNumbers);
            document.getElementById('invoiceNumber').value = invoiceNumber;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü
            const existingDeliveryNumbers = confirmedDeliveries.map(del => del.number);
            const deliveryNumber = generateUniqueDocumentNumber(existingDeliveryNumbers);
            document.getElementById('deliveryNumber').value = deliveryNumber;
        }

        function updateSelectOptions() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
            initializeClientSearch('invoiceClientSearch', 'invoiceClient', 'invoiceClientDropdown');
            initializeClientSearch('deliveryClientSearch', 'deliveryClient', 'deliveryClientDropdown');
            initializeClientSearch('productClientSearch', 'productClient', 'productClientDropdown');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
            initializeProductSearch();
        }

        function initializeClientSearch(inputId, hiddenId, dropdownId) {
            const input = document.getElementById(inputId);
            const hidden = document.getElementById(hiddenId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !hidden || !dropdown) return;

            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                hidden.value = '';
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                const filteredClients = clients.filter(client => 
                    client.name.toLowerCase().includes(query) ||
                    client.mb.includes(query) ||
                    client.pib.includes(query)
                );

                if (filteredClients.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = '';
                filteredClients.forEach((client, index) => {
                    const originalIndex = clients.findIndex(c => c.name === client.name && c.mb === client.mb);
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `
                        <div style="font-weight: bold;">${client.name}</div>
                        <div style="font-size: 12px; color: #666;">–ú–ë: ${client.mb} | –ü–ò–ë: ${client.pib}</div>
                        <div style="font-size: 12px; color: #888;">${client.address}</div>
                    `;
                    item.addEventListener('click', function() {
                        input.value = client.name;
                        hidden.value = originalIndex;
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(item);
                });

                dropdown.style.display = 'block';
            });

            input.addEventListener('focus', function() {
                if (this.value && dropdown.children.length > 0) {
                    dropdown.style.display = 'block';
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            });
        }

        function initializeProductSearch() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π —Ç–æ–≤–∞—Ä–æ–≤
            document.querySelectorAll('.invoice-product-search').forEach(input => {
                setupProductSearch(input);
            });
            
            document.querySelectorAll('.delivery-product-search').forEach(input => {
                setupProductSearch(input);
            });
        }

        function setupProductSearch(input) {
            const container = input.closest('.searchable-select');
            const hidden = container.querySelector('.invoice-product, .delivery-product');
            const dropdown = container.querySelector('.invoice-product-dropdown, .delivery-product-dropdown');
            
            if (!hidden || !dropdown) return;

            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                hidden.value = '';
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–∏–Ω–≤–æ–π—Å –∏–ª–∏ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞)
                const invoiceClientIndex = document.getElementById('invoiceClient')?.value || '';
                const deliveryClientIndex = document.getElementById('deliveryClient')?.value || '';
                const selectedClientIndex = invoiceClientIndex || deliveryClientIndex;
                const selectedClient = selectedClientIndex !== '' ? clients[parseInt(selectedClientIndex)] : null;

                let filteredProducts = products.filter(product => 
                    (product.internalCode && product.internalCode.toLowerCase().includes(query)) ||
                    (product.code && product.code.toLowerCase().includes(query)) ||
                    (product.name && product.name.toLowerCase().includes(query)) ||
                    (product.category && product.category.toLowerCase().includes(query))
                );

                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ —Ç–æ–≤–∞—Ä—ã
                if (selectedClient) {
                    filteredProducts = filteredProducts.filter(product => {
                        const productUser = getProductUser(product.internalCode);
                        // –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∫—Ä—ã–≤–∞–µ–º –æ–±—â–∏–µ —Ç–æ–≤–∞—Ä—ã
                        const isClientUser = window.currentUser && window.currentUser.userType === 'client';
                        if (isClientUser) {
                            return productUser === selectedClient.name;
                        } else {
                            return productUser === selectedClient.name || productUser === '–û–±—â–∏–π';
                        }
                    });
                }

                if (filteredProducts.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                dropdown.innerHTML = '';
                filteredProducts.forEach(product => {
                    const originalIndex = products.findIndex(p => p.internalCode === product.internalCode);
                    const productUser = getProductUser(product.internalCode);
                    const weight = product.weight ? `${product.weight}–≥` : 'N/A';
                    
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `
                        <div style="font-weight: bold;">${product.code} - ${product.name}</div>
                        <div style="font-size: 12px; color: #666;">
                            –¶–µ–Ω–∞: ${product.price.toFixed(2)} RSD | –í–µ—Å: ${weight} | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span style="color: #007bff; font-weight: bold;">${productUser}</span>
                        </div>
                    `;
                    item.addEventListener('click', function() {
                        input.value = `${product.code} - ${product.name}`;
                        hidden.value = originalIndex;
                        dropdown.style.display = 'none';
                        
                        // –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –¥–ª—è –∏–Ω–≤–æ–π—Å–æ–≤
                        if (hidden.classList.contains('invoice-product')) {
                            updateInvoiceItemPriceFromSearch(hidden);
                        }
                    });
                    dropdown.appendChild(item);
                });

                dropdown.style.display = 'block';
            });

            input.addEventListener('focus', function() {
                if (this.value && dropdown.children.length > 0) {
                    dropdown.style.display = 'block';
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            });
        }

        function updateInvoiceItemPriceFromSearch(hiddenInput) {
            const row = hiddenInput.closest('.invoice-items');
            if (!row) return;
            
            const productIndex = hiddenInput.value;
            
            if (productIndex !== '') {
                const product = products[productIndex];
                const priceInput = row.querySelector('.invoice-price');
                const quantityInput = row.querySelector('.invoice-quantity');
                const amountInput = row.querySelector('.invoice-amount');
                
                priceInput.value = product.price.toFixed(2);
                const quantity = parseInt(quantityInput.value) || 1;
                amountInput.value = (product.price * quantity).toFixed(2);
                calculateInvoiceTotals();
            }
        }

        function showTab(tabName, event) {
            const isClientUser = window.currentUser && window.currentUser.userType === 'client';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ –±–ª–æ–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                if (isClientUser) {
                    tab.style.display = 'none';
                } else {
                    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–æ–∂–µ —Å–∫—Ä—ã–≤–∞–µ–º
                    tab.style.display = 'none';
                }
            });
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                targetTab.style.display = 'block';
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ, –Ω–∞–π–¥–µ–º –≤–∫–ª–∞–¥–∫—É –ø–æ target
                const tabButton = isClientUser ? 
                    document.querySelector(`[onclick*="${tabName}"]`) : 
                    document.querySelector(`.nav-tab[onclick*="${tabName}"]`);
                if (tabButton) {
                    tabButton.classList.add('active');
                }
            }
            
            // –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø –Ω–∞ —Å–∫–ª–∞–¥–µ
            if (tabName === 'warehouse' && isClientUser) {
                const groupCreationForm = document.getElementById('groupCreationForm');
                if (groupCreationForm) {
                    groupCreationForm.style.display = 'none';
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                const clientMB = window.currentUser?.clientMB;
                if (!clientMB) {
                    console.error('–ù–µ –Ω–∞–π–¥–µ–Ω matiƒçni broj –∫–ª–∏–µ–Ω—Ç–∞');
                    return;
                }
                
                if (!window.clientProductGroups) {
                    window.clientProductGroups = {};
                }
                
                if (!window.clientProductGroups[clientMB]) {
                    const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                    window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                }
                
                console.log('–û—Ç–∫—Ä—ã—Ç —Å–∫–ª–∞–¥ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', {
                    clientMB: clientMB,
                    groupsLoaded: window.clientProductGroups[clientMB]?.length || 0
                });
                
                renderProductGroups();
            } else if (tabName === 'warehouse') {
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø
                const groupCreationForm = document.getElementById('groupCreationForm');
                if (groupCreationForm) {
                    groupCreationForm.style.display = 'block';
                }
                renderProductGroups();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤–∫–ª–∞–¥–æ–∫
            if (tabName === 'incomingDocuments') {
                loadIncomingDocuments();
            } else if (tabName === 'clientSales' && isClientUser) {
                loadSalesProducts();
                loadSalesHistory();
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => document.body.removeChild(alertDiv), 3000);
        }

        // –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê–ú–ò –°–û–ë–´–¢–ò–ô (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏)
        const EventManager = {
            listeners: [],
            
            // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º
            add: function(element, event, handler, options = {}) {
                if (!element) {
                    console.warn('EventManager: —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞');
                    return;
                }
                
                element.addEventListener(event, handler, options);
                this.listeners.push({
                    element: element,
                    event: event,
                    handler: handler,
                    options: options
                });
                
                console.log(`EventManager: –¥–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ${event} –¥–ª—è`, element);
            },
            
            // –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            remove: function(element, event, handler) {
                if (!element) return;
                
                element.removeEventListener(event, handler);
                this.listeners = this.listeners.filter(listener => 
                    !(listener.element === element && listener.event === event && listener.handler === handler)
                );
                
                console.log(`EventManager: —É–¥–∞–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ${event} –¥–ª—è`, element);
            },
            
            // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞
            removeAllForElement: function(element) {
                if (!element) return;
                
                const toRemove = this.listeners.filter(listener => listener.element === element);
                toRemove.forEach(listener => {
                    listener.element.removeEventListener(listener.event, listener.handler);
                });
                
                this.listeners = this.listeners.filter(listener => listener.element !== element);
                console.log(`EventManager: —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è`, element);
            },
            
            // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            removeAll: function() {
                this.listeners.forEach(listener => {
                    if (listener.element) {
                        listener.element.removeEventListener(listener.event, listener.handler);
                    }
                });
                this.listeners = [];
                console.log('EventManager: –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—á–∏—â–µ–Ω—ã');
            },
            
            // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            getStats: function() {
                const stats = {
                    total: this.listeners.length,
                    byEvent: {},
                    byElement: {}
                };
                
                this.listeners.forEach(listener => {
                    // –ü–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π
                    stats.byEvent[listener.event] = (stats.byEvent[listener.event] || 0) + 1;
                    
                    // –ü–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º
                    const elementTag = listener.element.tagName || 'unknown';
                    stats.byElement[elementTag] = (stats.byElement[elementTag] || 0) + 1;
                });
                
                return stats;
            }
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        function addSafeEventListener(elementId, event, handler, options = {}) {
            const element = document.getElementById(elementId);
            if (element) {
                EventManager.add(element, event, handler, options);
                return true;
            } else {
                console.warn(`–≠–ª–µ–º–µ–Ω—Ç —Å ID "${elementId}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                return false;
            }
        }

        // –ö–û–ú–ü–õ–ï–ö–°–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø –§–û–†–ú
        function validateField(fieldId, fieldName, validationType = 'required') {
            const field = document.getElementById(fieldId);
            if (!field) {
                console.warn(`–ü–æ–ª–µ ${fieldId} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`);
                return { valid: true, message: '' }; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
            }
            
            const value = field.value.trim();
            
            switch (validationType) {
                case 'required':
                    if (!value) {
                        return { valid: false, message: `${fieldName} –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è` };
                    }
                    break;
                    
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (value && !emailRegex.test(value)) {
                        return { valid: false, message: `${fieldName} –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º email –∞–¥—Ä–µ—Å–æ–º` };
                    }
                    break;
                    
                case 'number':
                    if (value && (isNaN(value) || parseFloat(value) < 0)) {
                        return { valid: false, message: `${fieldName} –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º` };
                    }
                    break;
                    
                case 'positive_number':
                    if (!value || isNaN(value) || parseFloat(value) <= 0) {
                        return { valid: false, message: `${fieldName} –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º –±–æ–ª—å—à–µ 0` };
                    }
                    break;
                    
                case 'mb': // –ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò (8 —Ü–∏—Ñ—Ä)
                    const mbRegex = /^\d{8}$/;
                    if (value && !mbRegex.test(value)) {
                        return { valid: false, message: `${fieldName} –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 8 —Ü–∏—Ñ—Ä` };
                    }
                    break;
                    
                case 'pib': // –ü–ò–ë (9 —Ü–∏—Ñ—Ä)
                    const pibRegex = /^\d{9}$/;
                    if (value && !pibRegex.test(value)) {
                        return { valid: false, message: `${fieldName} –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 9 —Ü–∏—Ñ—Ä` };
                    }
                    break;
                    
                case 'date':
                    if (value && isNaN(Date.parse(value))) {
                        return { valid: false, message: `${fieldName} –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –¥–∞—Ç–æ–π` };
                    }
                    break;
            }
            
            return { valid: true, message: '' };
        }
        
        function validateForm(fields) {
            const errors = [];
            
            fields.forEach(field => {
                const validation = validateField(field.id, field.name, field.type);
                if (!validation.valid) {
                    errors.push(validation.message);
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–æ–ª–µ —Å –æ—à–∏–±–∫–æ–π
                    const fieldElement = document.getElementById(field.id);
                    if (fieldElement) {
                        fieldElement.style.borderColor = '#dc3545';
                        fieldElement.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
                    }
                } else {
                    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –æ—à–∏–±–∫–∏
                    const fieldElement = document.getElementById(field.id);
                    if (fieldElement) {
                        fieldElement.style.borderColor = '';
                        fieldElement.style.boxShadow = '';
                    }
                }
            });
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        // –ö–ª–∏–µ–Ω—Ç—ã
        function addClient() {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –∫–ª–∏–µ–Ω—Ç–∞ —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
            const clientFields = [
                { id: 'clientName', name: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏', type: 'required' },
                { id: 'clientMB', name: '–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò', type: 'mb' },
                { id: 'clientPIB', name: '–ü–ò–ë', type: 'pib' },
                { id: 'clientAddress', name: '–ê–¥—Ä–µ—Å', type: 'required' }
            ];
            
            const validation = validateForm(clientFields);
            if (!validation.valid) {
                showAlert('–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n' + validation.errors.join('\n'), 'danger');
                return;
            }

            const name = document.getElementById('clientName').value.trim();
            const legalName = document.getElementById('clientLegalName').value.trim();
            const mb = document.getElementById('clientMB').value.trim();
            const pib = document.getElementById('clientPIB').value.trim();
            const bank = document.getElementById('clientBank').value.trim();
            const isManualInput = document.getElementById('manualAddressInput').checked;
            
            // –ù–æ–≤—ã–µ –ø–æ–ª—è
            const googleMaps = document.getElementById('clientGoogleMaps').value.trim();
            const contactPerson = document.getElementById('clientContactPerson').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const telegram = document.getElementById('clientTelegram').value.trim();
            const instagram = document.getElementById('clientInstagram').value.trim();
            const installment = document.getElementById('clientInstallment').checked;
            const installmentTerm = document.getElementById('clientInstallmentTerm').value.trim();
            const showcase = document.getElementById('clientShowcase').checked;
            const bar = document.getElementById('clientBar').checked;
            const notes = document.getElementById('clientNotes').value.trim();
            
            let address, city, municipality, street, houseNumber;
            
            if (isManualInput) {
                // –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞
                address = document.getElementById('clientManualAddress').value.trim();
                
                if (!name || !legalName || !mb || !pib || !address) { 
                    showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'danger'); 
                    return; 
                }
                
                // –ü–∞—Ä—Å–∏–º –∞–¥—Ä–µ—Å –¥–ª—è –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                const addressParts = address.split(',').map(part => part.trim());
                city = addressParts[0] || '';
                municipality = addressParts[1] || '';
                street = addressParts[2] || '';
                houseNumber = addressParts[3] || '';
                
            } else {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞
                city = document.getElementById('clientCity').value.trim();
                municipality = document.getElementById('clientMunicipality').value.trim();
                street = document.getElementById('clientStreet').value.trim();
                houseNumber = document.getElementById('clientHouseNumber').value.trim();
                
                if (!name || !legalName || !mb || !pib || !city || !municipality || !street) { 
                    showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'danger'); 
                    return; 
                }

                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å
                address = `${city}, ${municipality}, ${street}`;
                if (houseNumber) {
                    address += ` ${houseNumber}`;
                }
            }
            
            const newClient = { 
                name, 
                legalName,
                mb, 
                pib, 
                address, 
                bank, 
                city, 
                municipality, 
                street, 
                houseNumber,
                isManualAddress: isManualInput,
                googleMaps,
                contactPerson,
                phone,
                email,
                telegram,
                instagram,
                installment,
                installmentTerm,
                showcase,
                bar,
                notes,
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ contact –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                contact: contactPerson || phone || email || ''
            };
            
            clients.push(newClient);
            addLog(`–î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç: ${name}`);
            clearClientForm(); 
            renderClientsTable();
            updateSelectOptions();
            showAlert('–ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
        }

        function clearClientForm() {
            ['clientName', 'clientLegalName', 'clientMB', 'clientPIB', 'clientCity', 'clientMunicipality', 'clientStreet', 'clientHouseNumber', 'clientBank', 'clientManualAddress', 'clientGoogleMaps', 'clientContactPerson', 'clientPhone', 'clientEmail', 'clientTelegram', 'clientInstagram', 'clientInstallmentTerm', 'clientNotes'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å—ã
            ['clientInstallment', 'clientShowcase', 'clientBar'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.checked = false;
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
            const manualCheckbox = document.getElementById('manualAddressInput');
            if (manualCheckbox) {
                manualCheckbox.checked = false;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–≤–æ–¥, —Å–∫—Ä—ã–≤–∞–µ–º —Ä—É—á–Ω–æ–π
                document.getElementById('automaticAddressSection').style.display = 'block';
                document.getElementById('manualAddressSection').style.display = 'none';
            }
            
            // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–µ–π –∞–¥—Ä–µ—Å–∞
            const municipalityInput = document.getElementById('clientMunicipality');
            const streetInput = document.getElementById('clientStreet');
            if (municipalityInput) {
                municipalityInput.disabled = true;
                municipalityInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –≥–æ—Ä–æ–¥...';
            }
            if (streetInput) {
                streetInput.disabled = true;
                streetInput.placeholder = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –æ–±—â–∏–Ω—É...';
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–ª–µ–π
            resetFieldHighlighting(document.getElementById('clients'));
        }

        function deleteClient(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?')) {
                clients.splice(index, 1); 
                renderClientsTable();
                updateSelectOptions();
                showAlert('–ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω!', 'success');
            }
        }

        function renderClientsTable() {
            const tbody = document.getElementById('clientsTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            clients.forEach((client, index) => {
                const row = tbody.insertRow();
                const addressDisplay = client.isManualAddress ? 
                    `<span style="color: #007bff;">üìù</span> ${client.address}` : 
                    client.address;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä pointer –∏ hover —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è —Å—Ç—Ä–æ–∫–∏
                row.style.cursor = 'pointer';
                row.style.transition = 'background-color 0.2s ease';
                
                row.innerHTML = `
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;"><strong>${client.name}</strong></td>
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;">${client.mb}</td>
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;">${client.pib}</td>
                    <td onclick="openClientProfile(${index})" style="max-width: 200px; word-wrap: break-word; padding: 15px 10px;">${addressDisplay}</td>
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;">${client.contactPerson || client.contact || '-'}</td>
                    <td onclick="openClientProfile(${index})" style="padding: 15px 10px;">${client.bank || '-'}</td>
                    <td style="padding: 15px 10px;">
                        <button class="btn btn-primary" onclick="editClient(${index})" style="margin-right: 5px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-secondary" onclick="showClientHistory('${client.name.replace(/'/g, "\\'")}')" style="margin-right: 5px;">–ò—Å—Ç–æ—Ä–∏—è</button>
                        <button class="btn btn-danger" onclick="deleteClient(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                row.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        }

        function editClient(index) {
            if (index < 0 || index >= clients.length) {
                showAlert('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
                return;
            }
            
            const client = clients[index];
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            window.editingClientIndex = index;
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            openClientProfile(index);
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            setTimeout(() => {
                switchToEditMode();
            }, 100);
        }

        // –¢–æ–≤–∞—Ä—ã
        function addProduct() {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π —Ç–æ–≤–∞—Ä–∞ —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
            const productFields = [
                { id: 'productInternalCode', name: '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥', type: 'required' },
                { id: 'productCode', name: '–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞', type: 'required' },
                { id: 'productName', name: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', type: 'required' },
                { id: 'productPrice', name: '–¶–µ–Ω–∞', type: 'positive_number' },
                { id: 'productCategory', name: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', type: 'required' }
            ];
            
            const validation = validateForm(productFields);
            if (!validation.valid) {
                showAlert('–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n' + validation.errors.join('\n'), 'danger');
                return;
            }

            const internalCode = document.getElementById('productInternalCode').value.trim();
            const code = document.getElementById('productCode').value.trim();
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;
            const weight = parseFloat(document.getElementById('productWeight').value) || 0;
            let productClientIndex = document.getElementById('productClient').value;
            
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∫–ª–∏–µ–Ω—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä –∫ –Ω–µ–º—É
            if (window.currentUser && window.currentUser.userType === 'client') {
                const currentClientMB = window.currentUser.clientMB;
                const currentClient = clients.find(c => c.mb === currentClientMB);
                if (currentClient) {
                    productClientIndex = clients.indexOf(currentClient).toString();
                    console.log(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä –∫ –∫–ª–∏–µ–Ω—Ç—É: ${currentClient.name} (MB: ${currentClientMB})`);
                }
            }
            
            if (!internalCode || !code || !name || !price || price <= 0) { 
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!', 'danger'); 
                return; 
            }
            if (products.find(p => p.internalCode === internalCode)) { 
                showAlert('–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'danger'); 
                return; 
            }
            
            const newProduct = { internalCode, code, name, price, category, weight };
            products.push(newProduct);
            addLog(`–î–æ–±–∞–≤–ª–µ–Ω —Ç–æ–≤–∞—Ä: ${name} (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥: ${internalCode}, –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞: ${code}, –≤–µ—Å: ${weight}–≥)`);

            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∫–ª–∏–µ–Ω—Ç ‚Äî —Å–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ–¥—É–∫—Ç
            if (productClientIndex !== '') {
                const client = clients[parseInt(productClientIndex, 10)];
                if (client) {
                    const clientMB = client.mb;
                    let clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
                    const existing = clientProducts.find(p => p.clientMB === clientMB && p.internalCode === internalCode);
                    const clientProductName = name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–µ–∑ –¥–æ–±–∞–≤–æ–∫
                    const defaultWeight = weight > 0 ? weight : 1;

                    if (existing) {
                        existing.name = clientProductName;
                        existing.weight = defaultWeight;
                        existing.price = price; // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
                        existing.availableForSale = true;
                        existing.updatedAt = new Date().toISOString();
                    } else {
                        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞, –∫–∞–∫ –≤ –∏–Ω–≤–æ–π—Å–µ
                        
                        clientProducts.push({
                            internalCode: internalCode, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞
                            code: code, // –ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            name: clientProductName,
                            weight: defaultWeight,
                            price: price, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞
                            warehouseLink: internalCode,
                            warehouseProduct: null,
                            createdAt: new Date().toISOString(),
                            clientMB: clientMB,
                            availableForSale: true,
                            maxQuantity: 0,
                            type: 'clientProduct'
                        });
                    }
                    localStorage.setItem('clientProducts', JSON.stringify(clientProducts));
                    addLog(`–¢–æ–≤–∞—Ä ${code} –Ω–∞–∑–Ω–∞—á–µ–Ω –∫–ª–∏–µ–Ω—Ç—É ${client.name} (MB ${clientMB})`);
                }
            }

            clearProductForm(); 
            renderProductsTable();
            updateSelectOptions();
            showAlert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
        }

        function clearProductForm() {
            ['productInternalCode', 'productCode', 'productName', 'productPrice', 'productCategory', 'productWeight'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–ª–µ–π
            resetFieldHighlighting(document.getElementById('products'));
        }

        function deleteProduct(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) {
                products.splice(index, 1); 
                renderProductsTable();
                updateSelectOptions();
                showAlert('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω!', 'success');
            }
        }

        let currentEditingProductIndex = null;

        function editProduct(index) {
            const product = products[index];
            if (!product) return;

            currentEditingProductIndex = index;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞
            document.getElementById('editProductInternalCode').value = product.internalCode || '';
            document.getElementById('editProductCode').value = product.code || '';
            document.getElementById('editProductName').value = product.name || '';
            document.getElementById('editProductPrice').value = product.price || '';
            document.getElementById('editProductCategory').value = product.category || '';
            document.getElementById('editProductWeight').value = product.weight || '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('editProductModal').style.display = 'block';
            addLog(`–û—Ç–∫—Ä—ã—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: ${product.name}`);
        }

        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
            currentEditingProductIndex = null;
        }

        function saveProductChanges() {
            if (currentEditingProductIndex === null) return;

            // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const editProductModal = document.getElementById('editProductModal');
            if (!validateRequiredFields(editProductModal)) {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'danger');
                return;
            }

            const internalCode = document.getElementById('editProductInternalCode').value.trim();
            const code = document.getElementById('editProductCode').value.trim();
            const name = document.getElementById('editProductName').value.trim();
            const price = parseFloat(document.getElementById('editProductPrice').value);
            const category = document.getElementById('editProductCategory').value;
            const weight = parseFloat(document.getElementById('editProductWeight').value) || 0;

            if (!internalCode || !code || !name || !price || price <= 0) {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!', 'danger');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥ –¥—Ä—É–≥–∏–º —Ç–æ–≤–∞—Ä–æ–º
            const existingProduct = products.find((p, idx) => p.internalCode === internalCode && idx !== currentEditingProductIndex);
            if (existingProduct) {
                showAlert('–¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'danger');
                return;
            }

            const oldProduct = products[currentEditingProductIndex];
            const oldCode = oldProduct.code;
            const oldName = oldProduct.name;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä
            products[currentEditingProductIndex] = {
                internalCode,
                code,
                name,
                price,
                category,
                weight
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('products', JSON.stringify(products));

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderProductsTable();
            updateSelectOptions();
            closeEditProductModal();

            addLog(`–û–±–Ω–æ–≤–ª–µ–Ω —Ç–æ–≤–∞—Ä: ${oldName} (${oldCode}) ‚Üí ${name} (${code})`);
            showAlert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫ –∫–∞–∫–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏–≤—è–∑–∞–Ω —Ç–æ–≤–∞—Ä
        function getProductUser(productInternalCode) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã
            const clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            
            // –ò—â–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ç–æ–≤–∞—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–≤—è–∑–∞–Ω —Å –¥–∞–Ω–Ω—ã–º —Å–∏—Å—Ç–µ–º–Ω—ã–º —Ç–æ–≤–∞—Ä–æ–º —á–µ—Ä–µ–∑ warehouseLink (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥)
            const linkedClientProduct = clientProducts.find(cp => cp.warehouseLink === productInternalCode);
            
            if (linkedClientProduct) {
                // –ù–∞—Ö–æ–¥–∏–º –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ MB
                const client = clients.find(c => c.mb === linkedClientProduct.clientMB);
                if (client) {
                    return client.name;
                }
            }
            
            return '–û–±—â–∏–π';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
        function openEditProductModal(productInternalCode) {
            console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–æ–≤–∞—Ä–∞:', productInternalCode);
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –≤ clientProducts
            const clientProduct = window.clientProducts?.find(p => p.internalCode === productInternalCode);
            if (!clientProduct) {
                showAlert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.', 'danger');
                return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('clientEditProductName').value = clientProduct.name || '';
            document.getElementById('clientEditProductWeight').value = clientProduct.weight || '';
            document.getElementById('clientEditProductInternalCode').value = productInternalCode;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('clientEditProductModal').style.display = 'block';
        }

        function closeClientEditProductModal() {
            document.getElementById('clientEditProductModal').style.display = 'none';
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
            document.getElementById('clientEditProductName').value = '';
            document.getElementById('clientEditProductWeight').value = '';
            document.getElementById('clientEditProductInternalCode').value = '';
        }

        function saveClientProductChanges() {
            console.log('=== –ù–ê–ß–ê–õ–û –°–û–•–†–ê–ù–ï–ù–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô –¢–û–í–ê–†–ê ===');
            
            const internalCode = document.getElementById('clientEditProductInternalCode').value;
            const newName = document.getElementById('clientEditProductName').value.trim();
            const newWeight = parseFloat(document.getElementById('clientEditProductWeight').value);
            
            console.log('–î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã:', {internalCode, newName, newWeight});
            console.log('–¢–µ–∫—É—â–∏–µ clientProducts:', window.clientProducts);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!newName) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: –ø—É—Å—Ç–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
                showAlert('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.', 'danger');
                return;
            }
            
            if (!newWeight || newWeight <= 0) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π –≤–µ—Å');
                showAlert('–í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.', 'danger');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const clientProductIndex = window.clientProducts?.findIndex(p => p.internalCode === internalCode);
            console.log('–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞:', {internalCode, clientProductIndex, clientProductsLength: window.clientProducts?.length});
            
            if (clientProductIndex === -1) {
                console.log('‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                showAlert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.', 'danger');
                return;
            }
            
            const oldProduct = window.clientProducts[clientProductIndex];
            const oldWeight = oldProduct.weight;
            const oldName = oldProduct.name;
            
            console.log('–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞:', {oldName, oldWeight});
            console.log('–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞:', {newName, newWeight});
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ clientProducts
            window.clientProducts[clientProductIndex].name = newName;
            window.clientProducts[clientProductIndex].weight = newWeight;
            
            console.log('‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –ø–∞–º—è—Ç–∏:', window.clientProducts[clientProductIndex]);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage...');
            safeLocalStorage('set', 'clientProducts', window.clientProducts);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å
            const savedData = localStorage.getItem('clientProducts');
            const parsedSaved = JSON.parse(savedData);
            const savedProduct = parsedSaved.find(p => p.internalCode === internalCode);
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', savedProduct);
            
            // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–∞—Å—Å–∏–≤–µ products –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —Ç–∞–º –µ—Å—Ç—å
            const mainProductIndex = products.findIndex(p => p.internalCode === internalCode);
            console.log('–ü–æ–∏—Å–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–∞—Å—Å–∏–≤–µ products:', {mainProductIndex, productsLength: products?.length});
            if (mainProductIndex !== -1) {
                console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–∞—Å—Å–∏–≤–µ products');
                products[mainProductIndex].name = newName;
                products[mainProductIndex].weight = newWeight;
                localStorage.setItem('products', JSON.stringify(products));
                console.log('‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–∞—Å—Å–∏–≤–µ products');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç—ã —Å–∫–ª–∞–¥–∞ –µ—Å–ª–∏ –≤–µ—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
            if (oldWeight !== newWeight) {
                console.log('–í–µ—Å –∏–∑–º–µ–Ω–∏–ª—Å—è, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–∫–ª–∞–¥—Å–∫–∏–µ —Ä–∞—Å—á–µ—Ç—ã...');
                updateWarehouseCalculationsForWeightChange(internalCode, oldWeight, newWeight);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            console.log('–û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å...');
            loadSalesProducts();
            closeClientEditProductModal();
            
            console.log(`‚úÖ –¢–û–í–ê–† –£–°–ü–ï–®–ù–û –û–ë–ù–û–í–õ–ï–ù: ${oldName} (${oldWeight}–≥) ‚Üí ${newName} (${newWeight}–≥)`);
            console.log('=== –ö–û–ù–ï–¶ –°–û–•–†–ê–ù–ï–ù–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô –¢–û–í–ê–†–ê ===');
            showAlert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥—Å–∫–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Å–∞
        function updateWarehouseCalculationsForWeightChange(internalCode, oldWeight, newWeight) {
            console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–ª–∞–¥—Å–∫–∏–µ —Ä–∞—Å—á–µ—Ç—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞:', {internalCode, oldWeight, newWeight});
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) return;
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–∫–ª–∞–¥—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProductGroups[currentClientMB]) {
                console.log('–°–∫–ª–∞–¥—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            
            const groups = window.clientProductGroups[currentClientMB];
            
            // –ù–∞—Ö–æ–¥–∏–º –≥—Ä—É–ø–ø—ã, –≥–¥–µ –µ—Å—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä
            groups.forEach(group => {
                const productInGroup = group.products?.find(p => 
                    (p.product?.internalCode === internalCode) || 
                    (p.internalCode === internalCode)
                );
                
                if (productInGroup) {
                    console.log('–ù–∞–π–¥–µ–Ω–∞ –≥—Ä—É–ø–ø–∞ —Å —Ç–æ–≤–∞—Ä–æ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Å–∞:', group.groupName);
                    
                    // –ï—Å–ª–∏ –≤–µ—Å –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü
                    // –õ–æ–≥–∏–∫–∞: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–∏–π –≤–µ—Å –≤ –≥—Ä—É–ø–ø–µ, –Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü
                    if (oldWeight && newWeight && oldWeight !== newWeight) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–∏–π –≤–µ—Å –ø—Ä–æ–¥—É–∫—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ
                        const totalWeight = (group.quantity || 0) * oldWeight;
                        
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü –ø–æ –Ω–æ–≤–æ–º—É –≤–µ—Å—É
                        const newQuantity = Math.floor(totalWeight / newWeight);
                        
                        console.log(`–ü–µ—Ä–µ—Å—á–µ—Ç: —Å—Ç–∞—Ä—ã–π –≤–µ—Å ${oldWeight}–≥ x ${group.quantity} = ${totalWeight}–≥ –æ–±—â–∏–π –≤–µ—Å`);
                        console.log(`–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${totalWeight}–≥ / ${newWeight}–≥ = ${newQuantity} –µ–¥–∏–Ω–∏—Ü`);
                        
                        group.quantity = newQuantity;
                        
                        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—é –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
                        if (group.reservation) {
                            const reservationWeight = (group.reservation || 0) * oldWeight;
                            const newReservation = Math.floor(reservationWeight / newWeight);
                            group.reservation = newReservation;
                        }
                    }
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã
            localStorage.setItem(`clientProductGroups_${currentClientMB}`, JSON.stringify(groups));
            window.clientProductGroups[currentClientMB] = groups;
            
            console.log('–°–∫–ª–∞–¥—Å–∫–∏–µ —Ä–∞—Å—á–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–ø–∏—Å–∫–µ —Ç–æ–≤–∞—Ä–æ–≤
        function updateProductUserFilter() {
            const filterSelect = document.getElementById('productUserFilter');
            if (!filterSelect) return;
            
            const currentValue = filterSelect.value;
            
            // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ç–æ–≤–∞—Ä–æ–≤
            const uniqueUsers = new Set();
            uniqueUsers.add('–ö–æ–º–ø–∞–Ω–∏—è –ø—Ä–æ–¥–∞–≤–µ—Ü'); // –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–ø–∞–Ω–∏—é
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
            const clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            products.forEach(product => {
                const user = getProductUser(product.internalCode);
                if (user !== '–ö–æ–º–ø–∞–Ω–∏—è –ø—Ä–æ–¥–∞–≤–µ—Ü') {
                    uniqueUsers.add(user);
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
            const existingOptions = Array.from(filterSelect.options).map(opt => ({
                value: opt.value,
                text: opt.text
            }));
            
            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–Ω–æ–≤–æ –∑–∞–ø–æ–ª–Ω—è–µ–º select
            filterSelect.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –æ–ø—Ü–∏–∏
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = '–í—Å–µ —Ç–æ–≤–∞—Ä—ã';
            filterSelect.appendChild(allOption);
            
            const companyOption = document.createElement('option');
            companyOption.value = 'company';
            companyOption.textContent = '–ö–æ–º–ø–∞–Ω–∏—è –ø—Ä–æ–¥–∞–≤–µ—Ü';
            filterSelect.appendChild(companyOption);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
            Array.from(uniqueUsers).sort().forEach(user => {
                if (user !== '–ö–æ–º–ø–∞–Ω–∏—è –ø—Ä–æ–¥–∞–≤–µ—Ü') {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    filterSelect.appendChild(option);
                }
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            filterSelect.value = currentValue;
        }

        function renderProductsTable() {
            console.log('=== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ –¢–û–í–ê–†–û–í ===');
            
            const tbody = document.getElementById('productsTableBody');
            if(!tbody) return;
            
            const isClientUser = window.currentUser && window.currentUser.userType === 'client';
            const currentClientMB = isClientUser ? window.currentUser.clientMB : null;
            const currentClient = isClientUser && currentClientMB ? 
                clients.find(c => c.mb === currentClientMB) : null;
            const currentClientName = currentClient?.name || null;
            
            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const filterContainer = document.getElementById('productUserFilter')?.parentElement;
            if (filterContainer) {
                if (isClientUser) {
                    filterContainer.style.display = 'none';
                } else {
                    filterContainer.style.display = 'block';
                }
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            const filterSelect = document.getElementById('productUserFilter');
            const selectedFilter = !isClientUser && filterSelect ? filterSelect.value : '';
            console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä:', selectedFilter);
            console.log('–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', isClientUser ? '–∫–ª–∏–µ–Ω—Ç' : '–æ–±—ã—á–Ω—ã–π');
            if (isClientUser) {
                console.log('–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:', { MB: currentClientMB, name: currentClientName });
            }
            
            tbody.innerHTML = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            if (!isClientUser) {
                updateProductUserFilter();
            }
            
            // –î–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤: –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
            if (isClientUser && (!currentClientMB || !currentClient || !currentClientName)) {
                console.log('‚ùå –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–ø–æ–ª–Ω—ã–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫');
                console.log('–¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–ø—É—Å—Ç–∞—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö)');
                return;
            }
            
            products.forEach((product, index) => {
                const productUser = getProductUser(product.internalCode);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
                let shouldShow = true;
                
                if (isClientUser) {
                    // –î–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏—Ö —Ç–æ–≤–∞—Ä—ã (—Å—Ç—Ä–æ–≥–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ)
                    shouldShow = (productUser === currentClientName);
                    if (shouldShow) {
                        console.log(`‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä ${product.code} –∫–ª–∏–µ–Ω—Ç—É ${currentClientName}`);
                    }
                } else {
                    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
                    if (selectedFilter) {
                        if (selectedFilter === 'company') {
                            shouldShow = (productUser === '–ö–æ–º–ø–∞–Ω–∏—è –ø—Ä–æ–¥–∞–≤–µ—Ü');
                        } else {
                            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É
                            shouldShow = (productUser === selectedFilter);
                        }
                    }
                }
                
                if (!shouldShow) {
                    console.log(`–¢–æ–≤–∞—Ä ${product.code} —Å–∫—Ä—ã—Ç`);
                    return;
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>
                        ${isClientUser ? 
                            `<strong>${product.code}</strong>` : 
                            `<strong>${product.code}</strong><br><small style="color: #666;">–í–Ω—É—Ç—Ä.: ${product.internalCode || 'N/A'}</small>`
                        }
                    </td>
                    <td>${product.name}</td>
                    <td>${product.price.toFixed(2)} RSD</td>
                    <td>${product.category}</td>
                    <td>${product.weight || 0} –≥</td>
                    <td><strong>${productUser}</strong></td>
                    <td>
                        <button class="btn btn-primary" onclick="editProduct(${index})" style="margin-right: 5px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-danger" onclick="deleteProduct(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
            });
            
            const visibleRowsCount = tbody.children.length;
            console.log(`–¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${visibleRowsCount}`);
            
            if (isClientUser && visibleRowsCount === 0) {
                console.log('üîç –ö–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –µ—Å–ª–∏ —É –Ω–µ–≥–æ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
        function showAllProductsForAdmin() {
            console.log('=== –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –í–°–ï–• –¢–û–í–ê–†–û–í –î–õ–Ø –ê–î–ú–ò–ù–ê ===');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
            const filterSelect = document.getElementById('productUserFilter');
            if (filterSelect) {
                filterSelect.value = '';
                filterSelect.style.display = 'block';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–ª—å—Ç—Ä–∞
            const filterContainer = filterSelect?.parentElement;
            if (filterContainer) {
                filterContainer.style.display = 'block';
            }
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const originalUser = window.currentUser;
            window.currentUser = { ...originalUser, userType: 'regular' };
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            renderProductsTable();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            window.currentUser = originalUser;
            
            console.log('‚úÖ –í—Å–µ —Ç–æ–≤–∞—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –¥–ª—è –∞–¥–º–∏–Ω–∞');
            showAlert('–û—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å–∏—Å—Ç–µ–º—ã', 'success');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∞–¥–º–∏–Ω–∞
        function fixAdminInterface() {
            console.log('=== –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê –ê–î–ú–ò–ù–ê ===');
            
            if (!window.currentUser) {
                console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                return;
            }
            
            const isAdmin = window.currentUser.isAdmin || window.currentUser.username === 'BrankoFND';
            if (!isAdmin) {
                console.log('‚ùå –ù–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
                return;
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
            restoreStandardTabs();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            restoreStandardHeader();
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∞
            setTimeout(() => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤
                const filterContainer = document.getElementById('productUserFilter')?.parentElement;
                if (filterContainer) {
                    filterContainer.style.display = 'block';
                    console.log('‚úÖ –§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
                const clientSelectionGroup = document.querySelector('#productClientSearch')?.closest('.form-group');
                if (clientSelectionGroup) {
                    clientSelectionGroup.style.display = 'block';
                    console.log('‚úÖ –ü–æ–ª–µ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã"
                const showAllProductsBtn = document.getElementById('showAllProductsBtn');
                if (showAllProductsBtn) {
                    showAllProductsBtn.style.display = 'inline-block';
                    console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã" –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                }
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ
                showTab('products');
                renderProductsTable();
                
                console.log('‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–º–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                showAlert('–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–º–∏–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
            }, 200);
        }

        // –°–∫–ª–∞–¥
        let productGroups = JSON.parse(localStorage.getItem('productGroups')) || [];

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        document.addEventListener('DOMContentLoaded', function() {
            const quantityTypeSelect = document.getElementById('groupQuantityType');
            const reservationTypeSelect = document.getElementById('groupReservationType');
            const quantityUnit = document.getElementById('quantityUnit');
            const reservationUnit = document.getElementById('reservationUnit');
            
            if (quantityTypeSelect) {
                quantityTypeSelect.addEventListener('change', function() {
                    quantityUnit.textContent = this.value === 'weight' ? '–≥' : '–µ–¥.';
                });
            }
            
            if (reservationTypeSelect) {
                reservationTypeSelect.addEventListener('change', function() {
                    reservationUnit.textContent = this.value === 'weight' ? '–≥' : '–µ–¥.';
                });
            }
        });

        function createProductGroup() {
            // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            const warehouseSection = document.getElementById('warehouse');
            if (!validateRequiredFields(warehouseSection)) {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'danger');
                return;
            }

            const name = document.getElementById('groupName').value.trim();
            const quantityType = document.getElementById('groupQuantityType').value;
            const quantity = parseFloat(document.getElementById('groupQuantity').value);
            const shipmentDate = document.getElementById('groupShipmentDate').value;
            const reservationType = document.getElementById('groupReservationType').value;
            const reservation = parseFloat(document.getElementById('groupReservation').value);

            if (!name || !quantity || quantity <= 0) {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!', 'danger');
                return;
            }

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ - 5% - —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
            const fivePercentDeduction = quantity * 0.05;
            const reservationAmount = reservation || 0;
            const initialStock = Math.max(0, quantity - fivePercentDeduction - reservationAmount);
            const initialPercentage = (initialStock / quantity) * 100;

            const newGroup = {
                id: Date.now(),
                name,
                quantityType,
                quantity: initialStock,
                originalQuantity: quantity,
                shipmentDate,
                reservationType,
                reservation,
                products: [],
                remainingPercentage: initialPercentage,
                createdAt: new Date().toISOString()
            };

            productGroups.push(newGroup);
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            addLog(`–°–æ–∑–¥–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–æ–≤: ${name}`);
            clearGroupForm();
            renderProductGroups();
            showAlert('–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
        }

        function clearGroupForm() {
            ['groupName', 'groupQuantity', 'groupShipmentDate', 'groupReservation'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ–ª–µ–π
            resetFieldHighlighting(document.getElementById('warehouse'));
        }

        function renderProductGroups() {
            const container = document.getElementById('productGroupsList');
            if (!container) return;

            const isClientUser = window.currentUser && window.currentUser.userType === 'client';
            
            let groupsToShow = [];
            
            if (isClientUser) {
                const clientMB = window.currentUser?.clientMB;
                if (!clientMB) {
                    console.error('–ù–µ –Ω–∞–π–¥–µ–Ω matiƒçni broj –∫–ª–∏–µ–Ω—Ç–∞');
                    container.innerHTML = '<p style="text-align: center; color: #dc3545; margin: 20px 0;">–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</p>';
                    return;
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –∫–∞–∫ –æ–±—ä–µ–∫—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (!window.clientProductGroups) {
                    window.clientProductGroups = {};
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                if (!window.clientProductGroups[clientMB]) {
                    const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                    window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è ${clientMB}:`, window.clientProductGroups[clientMB].length);
                }
                
                groupsToShow = window.clientProductGroups[clientMB] || [];
            } else {
                groupsToShow = productGroups;
            }
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            if (isClientUser) {
                console.log('–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', {
                    clientMB: window.currentUser?.clientMB,
                    groupsCount: groupsToShow.length,
                    groups: groupsToShow
                });
            }

            if (groupsToShow.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 20px 0;">–ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>';
                return;
            }

            container.innerHTML = groupsToShow.map((group, index) => {
                const percentageClass = group.remainingPercentage > 50 ? '' : 
                                      group.remainingPercentage > 20 ? 'medium' : 'low';
                
                const quantityUnit = group.quantityType === 'weight' ? '–≥' : '–µ–¥.';
                const reservationUnit = group.reservationType === 'weight' ? '–≥' : '–µ–¥.';
                const groupId = group.id || index;
                
                return `
                    <div class="product-group" id="group-${groupId}">
                        <div class="group-header" onclick="toggleGroup(${groupId})">
                            <div>
                                <h4>${group.name}</h4>
                                <div class="group-info">
                                    <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${group.originalQuantity} ${quantityUnit}</span>
                                    <span>–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ: ${(group.currentQuantity || group.quantity || 0).toFixed(1)} ${quantityUnit}</span>
                                    ${group.shipmentDate ? `<span>–û—Ç–≥—Ä—É–∑–∫–∞: ${new Date(group.shipmentDate).toLocaleDateString()}</span>` : ''}
                                    <span>–¢–æ–≤–∞—Ä–æ–≤ –≤ –≥—Ä—É–ø–ø–µ: ${(group.products || []).length}</span>
                                </div>
                            </div>
                            <span class="group-expand-icon">‚ñ∂</span>
                        </div>
                        <div class="group-content">
                            <div class="group-stats">
                                <div class="stat-item">
                                    <div class="stat-label">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
                                    <div class="stat-value">${group.originalQuantity} ${quantityUnit}</div>
                                </div>
                                ${!isClientUser ? `
                                <div class="stat-item">
                                    <div class="stat-label">–°–ø–∏—Å–∞–Ω–∏–µ 5%</div>
                                    <div class="stat-value">-${(group.originalQuantity * 0.05).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">–†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –Ω–∞ –º–µ—Å—è—Ü</div>
                                    <div class="stat-value">-${(group.reservation || 0).toFixed(1)} ${reservationUnit}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">–ü–æ—Å—Ç—É–ø–∏–ª–æ –Ω–∞ —Å–∫–ª–∞–¥</div>
                                    <div class="stat-value">${(group.originalQuantity - (group.originalQuantity * 0.05) - (group.reservation || 0)).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                ` : ''}
                                <div class="stat-item">
                                    <div class="stat-label">–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ</div>
                                    <div class="stat-value">${(group.currentQuantity || group.quantity || 0).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                ${!isClientUser ? `
                                <div class="stat-item">
                                    <div class="stat-label">–ü—Ä–æ–¥–∞–Ω–æ</div>
                                    <div class="stat-value">${((group.originalQuantity - (group.originalQuantity * 0.05) - (group.reservation || 0)) - (group.quantity || 0)).toFixed(1)} ${quantityUnit}</div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- –¢–æ–≤–∞—Ä—ã –≤ –≥—Ä—É–ø–ø–µ -->
                            <div class="add-products-section">
                                <h5>–¢–æ–≤–∞—Ä—ã –≤ –≥—Ä—É–ø–ø–µ (${(group.products || []).length})</h5>
                                <div class="products-in-group" style="margin-bottom: 20px;">
                                    ${(group.products || []).length === 0 ? 
                                        '<p style="color: #666; margin: 10px 0; text-align: center; font-style: italic;">–¢–æ–≤–∞—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≥—Ä—É–ø–ø—É</p>' :
                                        (group.products || []).map((productInGroup, productIndex) => {
                                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
                                            let product;
                                            if (isClientUser) {
                                                // –î–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤: —Ç–æ–≤–∞—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ productInGroup.product –∏–ª–∏ —Å–∞–º productInGroup –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–≤–∞—Ä–æ–º
                                                product = productInGroup.product || productInGroup;
                                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —É –Ω–∞—Å –≤—Å–µ –µ—â–µ –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                                                if (!product || !product.name) {
                                                    console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ –≤ –≥—Ä—É–ø–ø–µ:', productInGroup);
                                                    return '';
                                                }
                                            } else {
                                                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: –∏—â–µ–º –ø–æ internalCode
                                                product = products.find(p => p.internalCode === productInGroup.internalCode);
                                            }
                                            return product && product.name ? `
                                                <div class="product-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #007bff;">
                                                    <div style="flex: 1;">
                                                        <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${product.name}</div>
                                                        <div style="font-size: 12px; color: #666;">
                                                            <span style="margin-right: 15px;"><strong>–ö–æ–¥:</strong> ${product.code || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                                            <span style="margin-right: 15px;"><strong>–í–µ—Å:</strong> ${product.weight || 0}–≥</span>
                                                            <span style="margin-right: 15px;"><strong>–¶–µ–Ω–∞:</strong> ${product.price ? product.price.toFixed(2) + ' RSD' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
                                                            <span style="margin-right: 15px;"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong> ${productInGroup.quantity || 1}</span>
                                                            <span><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${product.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
                                                        </div>
                                                    </div>
                                                    ${!isClientUser ? `<button class="btn btn-danger btn-sm" onclick="removeProductFromGroup(${groupId}, ${productIndex})" style="margin-left: 10px;">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                                                </div>
                                            ` : '';
                                        }).join('')
                                    }
                                </div>
                                
                                ${!isClientUser ? `
                                <h5>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h5>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <div class="searchable-select" style="flex: 1;">
                                        <input type="text" class="searchable-input group-product-search" id="groupProductSearch-${groupId}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." autocomplete="off">
                                        <input type="hidden" class="group-product-code" id="groupProductCode-${groupId}" value="">
                                        <div class="dropdown-menu group-product-dropdown" id="groupProductDropdown-${groupId}"></div>
                                    </div>
                                    <button class="btn btn-primary" onclick="addProductToGroup(${groupId})" style="min-width: 100px;">–î–æ–±–∞–≤–∏—Ç—å</button>
                                </div>
                                ` : ''}
                            </div>
                            
                            ${!isClientUser ? `
                            <div style="margin-top: 15px; text-align: right;">
                                <button class="btn btn-danger" onclick="deleteProductGroup(${groupId})">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleGroup(groupId) {
            const groupElement = document.getElementById(`group-${groupId}`);
            if (groupElement) {
                groupElement.classList.toggle('group-expanded');
            }
        }

        function addProductToGroup(groupId) {
            const productCodeElement = document.getElementById(`groupProductCode-${groupId}`);
            const productSearchElement = document.getElementById(`groupProductSearch-${groupId}`);
            const productCode = productCodeElement.value;
            
            if (!productCode) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä!', 'warning');
                return;
            }

            const product = products.find(p => p.internalCode === productCode);
            if (!product) {
                showAlert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'danger');
                return;
            }

            if (!product.weight || product.weight <= 0) {
                showAlert('–¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤–µ—Å!', 'warning');
                return;
            }

            const group = productGroups.find(g => g.id === groupId);
            if (!group) {
                showAlert('–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'danger');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä
            if (group.products.find(p => p.internalCode === productCode)) {
                showAlert('–¢–æ–≤–∞—Ä —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É!', 'warning');
                return;
            }

            group.products.push({
                internalCode: productCode,
                addedAt: new Date().toISOString()
            });

            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            addLog(`–¢–æ–≤–∞—Ä ${product.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É ${group.name}`);
            productCodeElement.value = '';
            productSearchElement.value = '';
            renderProductGroups();
            showAlert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É!', 'success');
        }

        function removeProductFromGroup(groupId, productIndex) {
            const group = productGroups.find(g => g.id === groupId);
            if (!group) return;

            const product = products.find(p => p.internalCode === group.products[productIndex].internalCode);
            group.products.splice(productIndex, 1);
            
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            addLog(`–¢–æ–≤–∞—Ä ${product ? product.name : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'} —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã ${group.name}`);
            renderProductGroups();
            showAlert('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã!', 'success');
        }

        function deleteProductGroup(groupId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É —Ç–æ–≤–∞—Ä–æ–≤?')) return;

            const groupIndex = productGroups.findIndex(g => g.id === groupId);
            if (groupIndex === -1) return;

            const group = productGroups[groupIndex];
            productGroups.splice(groupIndex, 1);
            
            localStorage.setItem('productGroups', JSON.stringify(productGroups));
            addLog(`–£–¥–∞–ª–µ–Ω–∞ –≥—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–æ–≤: ${group.name}`);
            renderProductGroups();
            showAlert('–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–æ–≤ —É–¥–∞–ª–µ–Ω–∞!', 'success');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–≤–æ–π—Å–∞
        function updateGroupStockOnInvoice(invoiceItems) {
            let updated = false;
            
            invoiceItems.forEach(item => {
                // –¢–æ–≤–∞—Ä —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ item.product, –∞ –Ω–µ item.code
                const product = item.product;
                if (!product || !product.weight) return;
                
                // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –≥—Ä—É–ø–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä
                productGroups.forEach(group => {
                    const productInGroup = group.products.find(p => p.internalCode === product.internalCode);
                    if (productInGroup && group.quantityType === 'weight') {
                        // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –≥—Ä—É–ø–ø–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Å–∞ —Ç–æ–≤–∞—Ä–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∏–Ω–≤–æ–π—Å–µ
                        const weightUsed = product.weight * item.quantity;
                        
                        // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è, –≤—ã—á–∏—Ç–∞–µ–º –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏, –∏–Ω–∞—á–µ –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞
                        if (item.isReservation) {
                            // –í—ã—á–∏—Ç–∞–µ–º –∏–∑ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
                            const newReservation = Math.max(0, (group.reservation || 0) - weightUsed);
                            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –≥—Ä—É–ø–ø—ã "${group.name}": —Ç–æ–≤–∞—Ä ${product.code}, –≤–µ—Å ${product.weight}–≥ √ó ${item.quantity} = ${weightUsed}–≥, —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è: ${group.reservation || 0}–≥ ‚Üí ${newReservation}–≥`);
                            group.reservation = newReservation;
                        } else {
                            // –í—ã—á–∏—Ç–∞–µ–º –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞
                            const newQuantity = Math.max(0, group.quantity - weightUsed);
                            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã "${group.name}": —Ç–æ–≤–∞—Ä ${product.code}, –≤–µ—Å ${product.weight}–≥ √ó ${item.quantity} = ${weightUsed}–≥, –æ—Å—Ç–∞—Ç–æ–∫: ${group.quantity}–≥ ‚Üí ${newQuantity}–≥`);
                            group.quantity = newQuantity;
                        }
                        
                        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Å—Ç–∞—Ç–∫–∞
                        group.remainingPercentage = (group.quantity / group.originalQuantity) * 100;
                        updated = true;
                    }
                });
            });
            
            if (updated) {
                localStorage.setItem('productGroups', JSON.stringify(productGroups));
                renderProductGroups(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–ø–ø
                addLog(`–û–±–Ω–æ–≤–ª–µ–Ω—ã –æ—Å—Ç–∞—Ç–∫–∏ —Å–∫–ª–∞–¥–∞ –ø–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞`);
            }
        }

        // –ò–Ω–≤–æ–π—Å—ã
        function addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            if(!container) return;

            const itemIndex = container.children.length;
            const newItem = document.createElement('div');
            newItem.className = 'invoice-items';
            
            newItem.innerHTML = `
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–¢–æ–≤–∞—Ä *</label>
                    <div class="searchable-select">
                        <input type="text" class="searchable-input invoice-product-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." autocomplete="off">
                        <input type="hidden" class="invoice-product" value="">
                        <div class="dropdown-menu invoice-product-dropdown"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" class="invoice-quantity" value="1" min="1">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–¶–µ–Ω–∞ (RSD)</label>
                    <input type="number" class="invoice-price" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–°—É–º–º–∞ (RSD)</label>
                    <input type="number" class="invoice-amount" readonly style="background: #f8f9fa; font-weight: bold;">
                </div>
                <div class="reservation-checkbox">
                    <input type="checkbox" class="invoice-reservation" id="reservation-${itemIndex}">
                    <label for="reservation-${itemIndex}">–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è</label>
                </div>
                <div style="padding-top: 25px;">
                    <button class="btn btn-danger" onclick="removeInvoiceItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            
            container.appendChild(newItem);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
            const newSearch = newItem.querySelector('.invoice-product-search');
            setupProductSearch(newSearch);
            addLog('–î–æ–±–∞–≤–ª–µ–Ω —Ç–æ–≤–∞—Ä –≤ –∏–Ω–≤–æ–π—Å');
        }

        function removeInvoiceItem(button) {
            const container = document.getElementById('invoiceItems');
            if(!container) return;
            
            if (container.children.length > 1) {
                button.closest('.invoice-items').remove();
                calculateInvoiceTotals();
            } else {
                showAlert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä!', 'danger');
            }
        }

        function calculateInvoiceTotals() {
            const amounts = document.querySelectorAll('.invoice-amount');
            let subtotal = 0;
            amounts.forEach(input => subtotal += parseFloat(input.value) || 0);
            
            const vatRate = parseFloat(document.getElementById('invoiceVAT').value) || 0;
            const vatAmount = subtotal * (vatRate / 100);
            const total = subtotal + vatAmount;

            document.getElementById('invoiceSubtotal').textContent = subtotal.toFixed(2) + ' RSD';
            document.getElementById('invoiceVATAmount').textContent = vatAmount.toFixed(2) + ' RSD';
            document.getElementById('invoiceTotal').textContent = total.toFixed(2) + ' RSD';
        }

        function generateInvoice() {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –∏–Ω–≤–æ–π—Å–∞ —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
            const invoiceFields = [
                { id: 'invoiceNumber', name: '–ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞', type: 'required' },
                { id: 'invoiceDate', name: '–î–∞—Ç–∞ –∏–Ω–≤–æ–π—Å–∞', type: 'date' },
                { id: 'invoiceDueDate', name: '–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞', type: 'date' },
                { id: 'invoiceClient', name: '–ö–ª–∏–µ–Ω—Ç', type: 'required' },
                { id: 'invoiceVAT', name: '–ù–î–°', type: 'number' }
            ];
            
            const validation = validateForm(invoiceFields);
            if (!validation.valid) {
                showAlert('–û—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n' + validation.errors.join('\n'), 'danger');
                return;
            }

            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceDueDate = document.getElementById('invoiceDueDate').value;
            const clientIndex = document.getElementById('invoiceClient').value;
            const delivery = document.getElementById('invoiceDelivery').value;
            const vatRate = document.getElementById('invoiceVAT').value;
            const reference = document.getElementById('invoiceReference').value.trim();

            const items = [];
            const itemRows = document.querySelectorAll('.invoice-items');
            
            itemRows.forEach(row => {
                const hiddenProduct = row.querySelector('.invoice-product');
                const productIndex = hiddenProduct.value;
                const quantity = parseInt(row.querySelector('.invoice-quantity').value);
                const amount = parseFloat(row.querySelector('.invoice-amount').value) || 0;
                const isReservation = row.querySelector('.invoice-reservation')?.checked || false;

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity,
                        price: product.price,
                        amount: amount,
                        isReservation: isReservation
                    });
                }
            });

            if (items.length === 0) {
                showAlert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä!', 'danger');
                return;
            }

            const client = clients[clientIndex];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏
            let deliveryAddress = client.address;
            const isDifferentAddress = document.getElementById('differentDeliveryAddress').checked;
            
            if (isDifferentAddress) {
                const deliveryCity = document.getElementById('deliveryCity').value.trim();
                const deliveryMunicipality = document.getElementById('deliveryMunicipality').value.trim();
                const deliveryStreet = document.getElementById('deliveryStreet').value.trim();
                const deliveryHouseNumber = document.getElementById('deliveryHouseNumber').value.trim();
                
                if (!deliveryCity || !deliveryMunicipality || !deliveryStreet) {
                    showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏!', 'danger');
                    return;
                }
                
                deliveryAddress = `${deliveryCity}, ${deliveryMunicipality}, ${deliveryStreet}`;
                if (deliveryHouseNumber) {
                    deliveryAddress += ` ${deliveryHouseNumber}`;
                }
            }
            
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const vatAmount = subtotal * (parseFloat(vatRate) / 100);
            const total = subtotal + vatAmount;

            currentInvoiceData = {
                number: invoiceNumber,
                date: invoiceDate,
                dueDate: invoiceDueDate,
                client: client,
                items: items,
                delivery: delivery,
                deliveryAddress: deliveryAddress,
                isDifferentDeliveryAddress: isDifferentAddress,
                vatRate: parseFloat(vatRate),
                reference: reference,
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total
            };

            const invoiceHTML = generateInvoiceHTML(currentInvoiceData);
            document.getElementById('invoiceContent').innerHTML = invoiceHTML;
            document.getElementById('invoicePreview').style.display = 'block';
            document.getElementById('invoicePreview').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('invoiceConfirmMessage').style.display = 'none';
        }

        function generateInvoiceHTML(invoice) {
            let itemsHTML = '';
            invoice.items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px;">${item.price.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: right; font-size: 10px; font-weight: bold;">${item.amount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                    </tr>
                `;
            });

            return `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">–°—Ä–µƒß–∞ 2024 –î–û–û –ë–µ–æ–≥—Ä–∞–¥ (–°—Ç–∞—Ä–∏ –ì—Ä–∞–¥)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matiƒçni broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedi≈°te: Beograd, Stari Grad, Studentski Trg 4</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">Predraƒçun</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${invoice.number}</p>
                            <div style="margin-top: 12px;">
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 2px 0; font-size: 11px;"><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                <p style="margin: 6px 0 2px 0; font-size: 13px; font-weight: bold; color: #333;"><strong>Balance Due:</strong> ${invoice.total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                            </div>
                        </div>
                    </div>

                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ –∏ –¥–æ—Å—Ç–∞–≤–∫–µ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Poruƒçioc:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${(invoice.client.legalName || invoice.client.name).split(' ')[0]}</p>
                                <p style="margin: 0; font-weight: bold;">${(invoice.client.legalName || invoice.client.name).split(' ').slice(1).join(' ')}</p>
                                ${invoice.client.contact && invoice.client.contact.includes('Ugostiteljska') ? '<p style="margin: 0;">Ugostiteljska radnja</p>' : ''}
                                ${invoice.client.contact && invoice.client.contact.includes('Seal') ? '<p style="margin: 0;">Seal</p>' : ''}
                                ${invoice.client.contact && invoice.client.contact.includes('Tea') ? '<p style="margin: 0;">& Tea</p>' : ''}
                                <p style="margin: 0;">${invoice.client.address.split(',')[1] ? invoice.client.address.split(',')[1].trim() : 'Novi Sad'}</p>
                                <p style="margin: 0;">Matiƒçni broj: ${invoice.client.mb}</p>
                                <p style="margin: 0;">PIB: ${invoice.client.pib}</p>
                                <p style="margin: 0;">Sedi≈°te: ${invoice.client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">Isporuka na adresu::</h4>
                            <p style="margin: 0; font-size: 10px;">${invoice.deliveryAddress || invoice.client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>Naƒçin:</strong> ${invoice.delivery}</p>
                        </div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">Proizvod</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">koliƒçina</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">cena</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">iznos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <!-- –ò—Ç–æ–≥–∏ -->
                    <div style="text-align: right; margin-bottom: 15px;">
                        <div style="display: inline-block; text-align: right;">
                            <p style="margin: 2px 0; font-size: 12px;"><strong>Subtotal:</strong> ${invoice.subtotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                            <p style="margin: 2px 0; font-size: 12px;"><strong>PDV (${invoice.vatRate}%):</strong> ${invoice.vatAmount.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                            <p style="margin: 6px 0 2px 0; font-size: 14px; font-weight: bold; color: #333;"><strong>Total:</strong> ${invoice.total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                        </div>
                    </div>
                    
                    <!-- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã -->
                    <div style="margin-top: 15px;">
                        <h4 style="margin: 0 0 4px 0; font-size: 10px;">Podaci o raƒçunima za prijem naknade :</h4>
                        <p style="margin: 1px 0; font-size: 10px;">Broj raƒçuna: 190-0000000085540-29</p>
                        <p style="margin: 1px 0; font-size: 10px;">Kod: Alta Banka ad Beograd</p>
                        <p style="margin: 1px 0; font-size: 10px;">Adresa banke: Beograd, Novi Beograd, Bulevar Zorana ƒêinƒëiƒáa 121</p>
                        <p style="margin: 8px 0 1px 0; font-size: 10px;">Plaƒáanje sa pozivom na broj: ${invoice.reference || 'ATSNS' + invoice.number.replace(/-/g, '')}</p>
                    </div>
                    
                    <style>
                        @media print {
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                            }
                        }
                    </style>
                </div>
            `;
        }

        function confirmInvoice() {
            console.log('=== –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ò–ù–í–û–ô–°–ê ===');
            console.log('currentInvoiceData:', currentInvoiceData);
            
            if (!currentInvoiceData) { 
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–∞!');
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–∞!', 'danger'); 
                return; 
            }
            
            console.log('–¢–µ–∫—É—â–∏–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã:', confirmedInvoices);
            
            if (confirmedInvoices.find(inv => inv.number === currentInvoiceData.number)) { 
                console.error('–ò–Ω–≤–æ–π—Å —É–∂–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω:', currentInvoiceData.number);
                showAlert('–ò–Ω–≤–æ–π—Å —É–∂–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω!', 'danger'); 
                return; 
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –≤ –≥—Ä—É–ø–ø–∞—Ö —Ç–æ–≤–∞—Ä–æ–≤
            console.log('–û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤...');
            updateGroupStockOnInvoice(currentInvoiceData.items);
            
            const newInvoice = { 
                ...currentInvoiceData, 
                confirmedDate: new Date().toISOString(),
                status: 'confirmed',
                clientStatus: null // –û–∂–∏–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞
            };
            
            console.log('–î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∏–Ω–≤–æ–π—Å:', newInvoice);
            confirmedInvoices.push(newInvoice);
            
            console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage...');
            console.log('–í—Å–µ–≥–æ –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', confirmedInvoices.length);
            
            try {
                safeLocalStorage('set', 'confirmedInvoices', confirmedInvoices);
                console.log('–ò–Ω–≤–æ–π—Å—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
                const saved = localStorage.getItem('confirmedInvoices');
                const parsed = JSON.parse(saved);
                console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤:', parsed.length);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', error);
                showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞!', 'danger');
                return;
            }
            
            window.confirmedInvoices = confirmedInvoices; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            console.log('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            
            updateStatistics();
            document.getElementById('invoiceConfirmMessage').style.display = 'block';
            showAlert('–ò–Ω–≤–æ–π—Å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω!', 'success');
            
            console.log('=== –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û ===');
        }

        function exportInvoiceToPDF() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–ü—Ä–µ–¥—Ä–∞—á—É–Ω ${currentInvoiceData.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—á–∞—Ç—å
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–º–µ–Ω–∏–ª)
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤, –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –ø–æ–ø–∞–ø—ã
                downloadInvoiceAsHTML();
            }
            
            showAlert('–ò–Ω–≤–æ–π—Å –≥–æ—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'success');
        }

        function downloadInvoiceAsHTML() {
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–ü—Ä–µ–¥—Ä–∞—á—É–Ω ${currentInvoiceData.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            // –°–æ–∑–¥–∞–µ–º blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `Predracun_${currentInvoiceData.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
            URL.revokeObjectURL(url);
            showAlert('HTML —Ñ–∞–π–ª –∏–Ω–≤–æ–π—Å–∞ —Å–∫–∞—á–∞–Ω!', 'success');
        }

        function copyInvoiceToClipboard() {
            const invoiceContent = document.getElementById('invoiceContent');
            if (!invoiceContent) {
                showAlert('–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!', 'danger');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = invoiceContent.innerHTML;
            
            // –£–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const textContent = tempDiv.innerText || tempDiv.textContent;
            
            // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textContent).then(() => {
                    showAlert('–ò–Ω–≤–æ–π—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                    fallbackCopyTextToClipboard(textContent);
                });
            } else {
                fallbackCopyTextToClipboard(textContent);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('–ò–Ω–≤–æ–π—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                } else {
                    showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'danger');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'danger');
            }
            
            document.body.removeChild(textArea);
        }

        function generateDeliveryFromInvoice() {
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceDueDate = document.getElementById('invoiceDueDate').value;
            const clientIndex = document.getElementById('invoiceClient').value;
            const delivery = document.getElementById('invoiceDelivery').value;
            const reference = document.getElementById('invoiceReference').value.trim();

            if (!invoiceNumber || !invoiceDate || !invoiceDueDate || clientIndex === '') {
                showAlert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å–∞!', 'danger');
                return;
            }

            const items = [];
            const itemRows = document.querySelectorAll('.invoice-items');
            
            itemRows.forEach(row => {
                const productIndex = row.querySelector('.invoice-product').value;
                const quantity = parseInt(row.querySelector('.invoice-quantity').value);
                const isReservation = row.querySelector('.invoice-reservation')?.checked || false;

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity,
                        isReservation: isReservation
                    });
                }
            });

            if (items.length === 0) {
                showAlert('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∏–Ω–≤–æ–π—Å!', 'danger');
                return;
            }

            showTab('delivery');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã
            const existingDeliveryNumbers = confirmedDeliveries.map(del => del.number);
            const deliveryNumber = generateUniqueDocumentNumber(existingDeliveryNumbers);
            document.getElementById('deliveryNumber').value = deliveryNumber;
            document.getElementById('deliveryDate').value = invoiceDate;
            document.getElementById('deliveryDueDate').value = invoiceDueDate;
            document.getElementById('deliveryClient').value = clientIndex;
            document.getElementById('deliveryMethod').value = delivery;

            const container = document.getElementById('deliveryItems');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const productIndex = products.findIndex(p => p.internalCode === item.product.internalCode);
                
                const newItem = document.createElement('div');
                newItem.className = 'delivery-items';
                newItem.innerHTML = `
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>–¢–æ–≤–∞—Ä *</label>
                        <div class="searchable-select">
                            <input type="text" class="searchable-input delivery-product-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." value="${item.product.code} - ${item.product.name}" autocomplete="off">
                            <input type="hidden" class="delivery-product" value="${productIndex}">
                            <div class="dropdown-menu delivery-product-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <input type="number" class="delivery-quantity" value="${item.quantity}" min="1">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>–ï–¥–∏–Ω–∏—Ü–∞</label>
                        <input type="text" class="delivery-unit" value="–∫–æ–º" readonly>
                    </div>
                    <div style="padding-top: 25px;">
                        <button class="btn btn-danger" onclick="removeDeliveryItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                container.appendChild(newItem);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
                const newSearch = newItem.querySelector('.delivery-product-search');
                setupProductSearch(newSearch);
            });

            showAlert('–î–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É!', 'success');
        }

        // –û—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã
        function addDeliveryItem() {
            const container = document.getElementById('deliveryItems');
            if(!container) return;

            const newItem = document.createElement('div');
            newItem.className = 'delivery-items';
            
            newItem.innerHTML = `
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–¢–æ–≤–∞—Ä *</label>
                    <div class="searchable-select">
                        <input type="text" class="searchable-input delivery-product-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." autocomplete="off">
                        <input type="hidden" class="delivery-product" value="">
                        <div class="dropdown-menu delivery-product-dropdown"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" class="delivery-quantity" value="1" min="1">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>–ï–¥–∏–Ω–∏—Ü–∞</label>
                    <input type="text" class="delivery-unit" value="–∫–æ–º" readonly>
                </div>
                <div style="padding-top: 25px;">
                    <button class="btn btn-danger" onclick="removeDeliveryItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            
            container.appendChild(newItem);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
            const newSearch = newItem.querySelector('.delivery-product-search');
            setupProductSearch(newSearch);
            addLog('–î–æ–±–∞–≤–ª–µ–Ω —Ç–æ–≤–∞—Ä –≤ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É');
        }

        function removeDeliveryItem(button) {
            const container = document.getElementById('deliveryItems');
            if(!container) return;
            
            if (container.children.length > 1) {
                button.closest('.delivery-items').remove();
            } else {
                showAlert('–î–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä!', 'danger');
            }
        }

        function generateDelivery() {
            const deliveryNumber = document.getElementById('deliveryNumber').value.trim();
            const deliveryDate = document.getElementById('deliveryDate').value;
            const deliveryDueDate = document.getElementById('deliveryDueDate').value;
            const clientIndex = document.getElementById('deliveryClient').value;
            const method = document.getElementById('deliveryMethod').value;

            if (!deliveryNumber || !deliveryDate || !deliveryDueDate || clientIndex === '') {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'danger');
                return;
            }

            const items = [];
            const itemRows = document.querySelectorAll('.delivery-items');
            
            itemRows.forEach(row => {
                const hiddenProduct = row.querySelector('.delivery-product');
                const productIndex = hiddenProduct.value;
                const quantity = parseInt(row.querySelector('.delivery-quantity').value);
                const unit = row.querySelector('.delivery-unit').value;

                if (productIndex !== '' && quantity > 0) {
                    const product = products[productIndex];
                    items.push({
                        product: product,
                        quantity: quantity,
                        unit: unit
                    });
                }
            });

            if (items.length === 0) {
                showAlert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä!', 'danger');
                return;
            }

            const client = clients[clientIndex];

            let itemsHTML = '';
            items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.unit}</td>
                    </tr>
                `;
            });

            const deliveryHTML = `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">–°—Ä–µƒß–∞ 2024 –î–û–û –ë–µ–æ–≥—Ä–∞–¥ (–°—Ç–∞—Ä–∏ –ì—Ä–∞–¥)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matiƒçni broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedi≈°te: Beograd, Stari Grad, –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">–û–¢–ü–†–ï–ú–ù–ò–¶–ê</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${deliveryNumber}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">–ü–æ—Ä—É—á–∏–ª–∞—Ü:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${client.legalName || client.name}</p>
                                <p style="margin: 0;">Matiƒçni broj: ${client.mb}</p>
                                <p style="margin: 0;">PIB: ${client.pib}</p>
                                <p style="margin: 0;">Sedi≈°te: ${client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">–ò—Å–ø–æ—Ä—É–∫–∞ –Ω–∞ –∞–¥—Ä–µ—Å—É:</h4>
                            <p style="margin: 0; font-size: 10px;">${client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>–ù–∞—á–∏–Ω:</strong> ${method}</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="margin: 2px 0; font-size: 10px;"><strong>–î–∞—Ç–∞:</strong> ${new Date(deliveryDate).toLocaleDateString('sr-RS')}</p>
                        <p style="margin: 2px 0; font-size: 10px;"><strong>–†–æ–∫ –∏—Å–ø–æ—Ä—É–∫–µ:</strong> ${new Date(deliveryDueDate).toLocaleDateString('sr-RS')}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">–ù–∞–∑–∏–≤ –∞—Ä—Ç–∏–∫–ª–∞</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">–ö–æ–ª–∏—á–∏–Ω–∞</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">–à–µ–¥–∏–Ω–∏—Ü–∞ –º–µ—Ä–µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>–ò–∑–¥–∞–æ</strong></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>–ü—Ä–∏–º–∏–æ</strong></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666;">
                        –û–≤–∞—ò –¥–æ–∫—É–º–µ–Ω—Ç —ò–µ –≥–µ–Ω–µ—Ä–∏—Å–∞–Ω –µ–ª–µ–∫—Ç—Ä–æ–Ω—Å–∫–∏ –∏ –≤–∞–∂–∏ –±–µ–∑ –ø–µ—á–∞—Ç–∞ –∏ –ø–æ—Ç–ø–∏—Å–∞
                    </div>
                </div>
            `;

            document.getElementById('deliveryContent').innerHTML = deliveryHTML;
            document.getElementById('deliveryPreview').style.display = 'block';
            document.getElementById('deliveryPreview').scrollIntoView({ behavior: 'smooth' });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            window.currentDeliveryData = {
                number: deliveryNumber,
                date: deliveryDate,
                dueDate: deliveryDueDate,
                client: client,
                method: method,
                items: items,
                signed: false
            };
        }

        function confirmDelivery() {
            if (!window.currentDeliveryData) {
                showAlert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É!', 'danger');
                return;
            }
            
            confirmedDeliveries.push({ 
                ...window.currentDeliveryData,
                status: 'confirmed',
                clientStatus: null // –û–∂–∏–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –∫–ª–∏–µ–Ω—Ç–∞
            });
            localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
            
            updateDeliveriesList();
            updateDeliveryClientFilter();
            
            addLog(`–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ #${window.currentDeliveryData.number} –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ${window.currentDeliveryData.client.name}`);
            showAlert('–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫!', 'success');
            
            window.currentDeliveryData = null;
        }

        function printDelivery() {
            const deliveryContent = document.getElementById('deliveryContent').innerHTML;
            const deliveryNumber = document.getElementById('deliveryNumber').value;
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ ${deliveryNumber}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${deliveryContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback - —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ HTML —Ñ–∞–π–ª–∞
                const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Otpremnica_${deliveryNumber.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
            }
            
            showAlert('–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'success');
        }

        function exportDeliveryToPDF() {
            if (!window.currentDeliveryData) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'danger');
                return;
            }

            const delivery = window.currentDeliveryData;
            const deliveryContent = generateDeliveryHTMLForModal(delivery);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ ${delivery.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${deliveryContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback - —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ HTML —Ñ–∞–π–ª–∞
                const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Otpremnica_${delivery.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
            }
            
            showAlert('–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'success');
            addLog(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ #${delivery.number} –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ${delivery.client.name}`);
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        function initializeStatistics() {
            const today = new Date();
            const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
            
            document.getElementById('statsFromDate').value = firstDayOfYear.toISOString().split('T')[0];
            document.getElementById('statsToDate').value = today.toISOString().split('T')[0];
            
            updateStatistics();
        }

        let currentFilteredInvoices = []; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤

        function updateStatistics() {
            const fromDate = new Date(document.getElementById('statsFromDate').value);
            const toDate = new Date(document.getElementById('statsToDate').value);
            toDate.setHours(23, 59, 59, 999);
            
            const filteredInvoices = confirmedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                return invoiceDate >= fromDate && invoiceDate <= toDate;
            });

            currentFilteredInvoices = filteredInvoices; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø–æ–∏—Å–∫–∞

            const totalRevenue = filteredInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalInvoicesCount = filteredInvoices.length;
            const uniqueClients = new Set(filteredInvoices.map(inv => inv.client.name)).size;
            const averageOrder = totalInvoicesCount > 0 ? totalRevenue / totalInvoicesCount : 0;

            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + ' RSD';
            document.getElementById('totalInvoices').textContent = totalInvoicesCount;
            document.getElementById('totalClients').textContent = uniqueClients;
            document.getElementById('averageOrder').textContent = averageOrder.toFixed(2) + ' RSD';

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            document.getElementById('invoiceSearchInput').value = '';
            
            updateInvoicesList(filteredInvoices);
            updateRevenueChart(filteredInvoices);
            updateProductsChart(filteredInvoices);
            updateClientsChart(filteredInvoices);
        }

        function filterInvoicesBySearch() {
            const searchTerm = document.getElementById('invoiceSearchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                // –ï—Å–ª–∏ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –ø—É—Å—Ç–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∏–Ω–≤–æ–π—Å—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
                updateInvoicesList(currentFilteredInvoices);
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –∏–Ω–≤–æ–π—Å—ã –ø–æ –Ω–æ–º–µ—Ä—É
            const searchResults = currentFilteredInvoices.filter(invoice => 
                invoice.number.toLowerCase().includes(searchTerm)
            );

            updateInvoicesList(searchResults);
        }

        function updateRevenueChart(invoices) {
            const chartEl = document.getElementById('revenueChart');
            if(!chartEl) return;

            if (invoices.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
                return;
            }

            const monthlyData = {};
            invoices.forEach(invoice => {
                const date = new Date(invoice.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + invoice.total;
            });

            let chartHTML = '<div style="display: flex; align-items: end; height: 200px; gap: 10px; padding: 20px;">';
            const maxValue = Math.max(...Object.values(monthlyData));
            const months = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
            
            Object.entries(monthlyData).forEach(([monthKey, value]) => {
                const [year, month] = monthKey.split('-');
                const monthName = months[parseInt(month) - 1];
                const height = (value / maxValue) * 150;
                chartHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                        <div style="font-size: 12px; margin-bottom: 5px; font-weight: bold;">${value.toFixed(0)} RSD</div>
                        <div style="width: 40px; height: ${height}px; background: linear-gradient(to top, #212529, #343a40); border-radius: 4px 4px 0 0;"></div>
                        <div style="font-size: 12px; margin-top: 5px; text-align: center;">${monthName}<br>${year}</div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateProductsChart(invoices) {
            const chartEl = document.getElementById('productsChart');
            if(!chartEl) return;

            const productData = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const key = item.product.code;
                    if (!productData[key]) {
                        productData[key] = {
                            name: item.product.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productData[key].quantity += item.quantity;
                    productData[key].revenue += item.amount;
                });
            });

            const sortedProducts = Object.entries(productData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);

            if (sortedProducts.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
                return;
            }

            const maxRevenue = sortedProducts[0][1].revenue;
            let chartHTML = '<div style="padding: 20px;">';
            
            sortedProducts.forEach(([code, data]) => {
                const percentage = (data.revenue / maxRevenue) * 100;
                chartHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px;">${code}</span>
                            <span style="font-size: 14px;">${data.revenue.toFixed(2)} RSD (${data.quantity} —à—Ç)</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(to right, #28a745, #20c997); border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateClientsChart(invoices) {
            const chartEl = document.getElementById('clientsChart');
            if(!chartEl) return;

            const clientData = {};
            invoices.forEach(invoice => {
                const clientName = invoice.client.name;
                clientData[clientName] = (clientData[clientName] || 0) + invoice.total;
            });

            const sortedClients = Object.entries(clientData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (sortedClients.length === 0) {
                chartEl.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
                return;
            }

            const maxRevenue = sortedClients[0][1];
            let chartHTML = '<div style="padding: 20px;">';
            
            sortedClients.forEach(([clientName, revenue]) => {
                const percentage = (revenue / maxRevenue) * 100;
                chartHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 14px;">${clientName}</span>
                            <span style="font-size: 14px;">${revenue.toFixed(2)} RSD</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px;">
                            <div style="width: ${percentage}%; height: 100%; background: linear-gradient(to right, #212529, #343a40); border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            chartHTML += '</div>';
            chartEl.innerHTML = chartHTML;
        }

        function updateInvoicesList(invoices) {
            const container = document.getElementById('confirmedInvoicesList');
            if(!container) return;

            if (invoices.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–ù–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>';
                return;
            }

            let listHTML = '';
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => {
                const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                const originalIndex = confirmedInvoices.findIndex(inv => inv.number === invoice.number);
                const isDelivered = invoice.delivered || false;
                const isPaid = invoice.paid || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">–ò–Ω–≤–æ–π—Å #${invoice.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${invoice.client.name} ‚Ä¢ ${date} ‚Ä¢ ${invoice.total.toFixed(2)} RSD</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">–¢–æ–≤–∞—Ä–æ–≤: ${invoice.items.length} ‚Ä¢ –ù–î–°: ${invoice.vatRate}%</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isDelivered ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'delivered', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isDelivered ? '#28a745' : '#6c757d'};">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'paid', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isPaid ? '#28a745' : '#6c757d'};">–û–ø–ª–∞—á–µ–Ω</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewConfirmedInvoice(${originalIndex})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω–≤–æ–π—Å">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                            <button class="btn btn-success" onclick="copyInvoiceData(${originalIndex})" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—ã–π –∏–Ω–≤–æ–π—Å">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            <span class="invoice-status">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                            ${invoice.clientStatus ? `<span class="status-badge ${getDocumentStatusClass(invoice.clientStatus)}">${getDocumentStatusText(invoice.clientStatus)}</span>` : '<span class="status-badge status-pending">–û–∂–∏–¥–∞–µ—Ç</span>'}
                            <button class="btn btn-danger" onclick="removeInvoiceFromStats('${invoice.number}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = listHTML;
        }

        function toggleInvoiceStatus(invoiceNumber, statusType, isChecked) {
            const invoice = confirmedInvoices.find(inv => inv.number === invoiceNumber);
            if (invoice) {
                if (statusType === 'delivered') {
                    invoice.delivered = isChecked;
                    addLog(`–ò–Ω–≤–æ–π—Å #${invoiceNumber} –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ ${isChecked ? '–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π' : '–Ω–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π'}`);
                } else if (statusType === 'paid') {
                    invoice.paid = isChecked;
                    addLog(`–ò–Ω–≤–æ–π—Å #${invoiceNumber} –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ ${isChecked ? '–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π' : '–Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π'}`);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage
                safeLocalStorage('set', 'confirmedInvoices', confirmedInvoices);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
                updateStatistics();
            }
        }

        function removeInvoiceFromStats(invoiceNumber) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∏–Ω–≤–æ–π—Å –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏?')) {
                confirmedInvoices = confirmedInvoices.filter(inv => inv.number !== invoiceNumber);
                updateStatistics();
                addLog(`–ò–Ω–≤–æ–π—Å #${invoiceNumber} —É–¥–∞–ª–µ–Ω –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏`);
                showAlert('–ò–Ω–≤–æ–π—Å —É–¥–∞–ª–µ–Ω –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!', 'success');
            }
        }

        function syncInvoiceStatuses() {
            console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–Ω–≤–æ–π—Å–æ–≤...');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
            const savedInvoices = localStorage.getItem('confirmedInvoices');
            if (!savedInvoices) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'info');
                return;
            }
            
            try {
                const freshInvoices = JSON.parse(savedInvoices);
                let syncedCount = 0;
                let statusChanges = 0;
                
                console.log('–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å–æ–≤:', confirmedInvoices.length);
                console.log('–°–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage:', freshInvoices.length);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤
                confirmedInvoices.forEach((invoice, index) => {
                    const freshInvoice = freshInvoices.find(fresh => fresh.number === invoice.number);
                    if (freshInvoice) {
                        const oldStatus = invoice.clientStatus;
                        const newStatus = freshInvoice.clientStatus;
                        
                        if (oldStatus !== newStatus) {
                            confirmedInvoices[index].clientStatus = newStatus;
                            statusChanges++;
                            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –∏–Ω–≤–æ–π—Å–∞ ${invoice.number}: ${oldStatus || 'null'} ‚Üí ${newStatus || 'null'}`);
                        }
                        syncedCount++;
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                window.confirmedInvoices = confirmedInvoices;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                updateStatistics();
                
                console.log(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${syncedCount} –∏–Ω–≤–æ–π—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, ${statusChanges} —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–æ`);
                
                if (statusChanges > 0) {
                    showAlert(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç–∞—Ç—É—Å–æ–≤: ${statusChanges}`, 'success');
                    addLog(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å—Ç–∞—Ç—É—Å—ã –∏–Ω–≤–æ–π—Å–æ–≤: ${statusChanges} –∏–∑–º–µ–Ω–µ–Ω–∏–π`);
                } else {
                    showAlert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ò–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.', 'info');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö', 'danger');
            }
        }

        function viewConfirmedInvoice(invoiceIndex) {
            const invoice = confirmedInvoices[invoiceIndex];
            if (!invoice) {
                showAlert('–ò–Ω–≤–æ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'danger');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            const modalHTML = `
                <div id="invoiceViewModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 15px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;">
                        <div style="position: sticky; top: 0; background: white; padding: 20px; border-bottom: 2px solid #e9ecef; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; color: #212529;">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω–≤–æ–π—Å–∞ #${invoice.number}</h3>
                            <div>
                                <button class="btn btn-primary" onclick="exportModalInvoiceToPDF()">–≠–∫—Å–ø–æ—Ä—Ç PDF</button>
                                <button class="btn btn-success" onclick="copyInvoiceData(${invoiceIndex})">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                                <button class="btn btn-danger" onclick="closeInvoiceViewModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                            </div>
                        </div>
                        <div id="modalInvoiceContent" style="padding: 20px;">
                            ${generateInvoiceHTML(invoice)}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            window.currentModalInvoice = invoice;
        }

        function closeInvoiceViewModal() {
            const modal = document.getElementById('invoiceViewModal');
            if (modal) {
                modal.remove();
            }
            window.currentModalInvoice = null;
        }

        function exportModalInvoiceToPDF() {
            if (!window.currentModalInvoice) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'danger');
                return;
            }

            const invoice = window.currentModalInvoice;
            const invoiceContent = generateInvoiceHTML(invoice);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–ü—Ä–µ–¥—Ä–∞—á—É–Ω ${invoice.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${invoiceContent}
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            }
            
            showAlert('–ò–Ω–≤–æ–π—Å –≥–æ—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'success');
        }

        function copyInvoiceData(invoiceIndex) {
            const invoice = confirmedInvoices[invoiceIndex];
            if (!invoice) {
                showAlert('–ò–Ω–≤–æ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'danger');
                return;
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞
            showTab('invoice');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
            closeInvoiceViewModal();

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞
            const today = new Date();
            const dateStr = `${String(today.getDate()).padStart(2, '0')}${String(today.getMonth() + 1).padStart(2, '0')}${today.getFullYear()}`;
            const newInvoiceNumber = `${confirmedInvoices.length + 1}-${dateStr}`;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Å –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º –∏ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π)
            document.getElementById('invoiceNumber').value = newInvoiceNumber;
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('invoiceDueDate').value = nextWeek.toISOString().split('T')[0];

            // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –∫–ª–∏–µ–Ω—Ç–∞
            const clientIndex = clients.findIndex(c => c.name === invoice.client.name && c.mb === invoice.client.mb);
            if (clientIndex !== -1) {
                document.getElementById('invoiceClientSearch').value = invoice.client.name;
                document.getElementById('invoiceClient').value = clientIndex;
            }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏, –ù–î–° –∏ –ø–æ–∑–∏–≤ –Ω–∞ –±—Ä–æ—ò
            document.getElementById('invoiceDelivery').value = invoice.delivery;
            document.getElementById('invoiceVAT').value = invoice.vatRate;
            document.getElementById('invoiceReference').value = invoice.reference || '';

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –µ—Å–ª–∏ –æ–Ω –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
            if (invoice.isDifferentDeliveryAddress) {
                document.getElementById('differentDeliveryAddress').checked = true;
                document.getElementById('deliveryAddressSection').style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
                if (invoice.deliveryAddress) {
                    if (typeof invoice.deliveryAddress === 'string') {
                        // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å - —Å—Ç—Ä–æ–∫–∞, –∑–∞–ø–æ–ª–Ω—è–µ–º —Ä—É—á–Ω–æ–π –≤–≤–æ–¥
                        document.getElementById('deliveryManualAddressInput').checked = true;
                        document.getElementById('deliveryManualAddressSection').style.display = 'block';
                        document.getElementById('deliveryAutoAddressSection').style.display = 'none';
                        document.getElementById('deliveryClientManualAddress').value = invoice.deliveryAddress;
                    } else if (typeof invoice.deliveryAddress === 'object') {
                        // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å - –æ–±—ä–µ–∫—Ç, –∑–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è
                        if (invoice.deliveryAddress.city) document.getElementById('deliveryClientCity').value = invoice.deliveryAddress.city;
                        if (invoice.deliveryAddress.municipality) document.getElementById('deliveryClientMunicipality').value = invoice.deliveryAddress.municipality;
                        if (invoice.deliveryAddress.street) document.getElementById('deliveryClientStreet').value = invoice.deliveryAddress.street;
                        if (invoice.deliveryAddress.houseNumber) document.getElementById('deliveryClientHouseNumber').value = invoice.deliveryAddress.houseNumber;
                    }
                }
            }

            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –∏–Ω–≤–æ–π—Å–∞
            const container = document.getElementById('invoiceItems');
            container.innerHTML = '';

            invoice.items.forEach((item, index) => {
                const productIndex = products.findIndex(p => p.internalCode === item.product.internalCode);
                
                if (productIndex !== -1) {
                    const newItem = document.createElement('div');
                    newItem.className = 'invoice-items';
                    newItem.innerHTML = `
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–¢–æ–≤–∞—Ä *</label>
                            <div class="searchable-select">
                                <input type="text" class="searchable-input invoice-product-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." value="${item.product.code} - ${item.product.name}" autocomplete="off">
                                <input type="hidden" class="invoice-product" value="${productIndex}">
                                <div class="dropdown-menu invoice-product-dropdown"></div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" class="invoice-quantity" value="${item.quantity}" min="1">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–¶–µ–Ω–∞ (RSD)</label>
                            <input type="number" class="invoice-price" value="${item.price.toFixed(2)}" readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>–°—É–º–º–∞ (RSD)</label>
                            <input type="number" class="invoice-amount" value="${item.amount.toFixed(2)}" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <div class="reservation-checkbox">
                            <input type="checkbox" class="invoice-reservation" id="reservation-${index}" ${item.isReservation ? 'checked' : ''}>
                            <label for="reservation-${index}">–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è</label>
                        </div>
                        <div style="padding-top: 25px;">
                            <button class="btn btn-danger" onclick="removeInvoiceItem(this)">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `;
                    container.appendChild(newItem);
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
                    const newSearch = newItem.querySelector('.invoice-product-search');
                    setupProductSearch(newSearch);
                }
            });

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
            calculateInvoiceTotals();

            showAlert('–î–∞–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã! –û–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–æ–º–µ—Ä –∏ –¥–∞—Ç–∞.', 'success');
        }

        function exportStatisticsToPDF() {
            const fromDate = document.getElementById('statsFromDate').value;
            const toDate = document.getElementById('statsToDate').value;
            
            if (!fromDate || !toDate) { 
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥!', 'danger'); 
                return; 
            }
            
            const filteredInvoices = confirmedInvoices.filter(invoice => {
                const invoiceDate = new Date(invoice.date);
                const from = new Date(fromDate);
                const to = new Date(toDate);
                to.setHours(23, 59, 59, 999);
                return invoiceDate >= from && invoiceDate <= to;
            });

            if (filteredInvoices.length === 0) { 
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'danger'); 
                return; 
            }
            
            const reportContent = generatePDFReport(filteredInvoices, fromDate, toDate);
            
            const printWindow = window.open('', '_blank');
            if(printWindow) {
                printWindow.document.write(reportContent);
                printWindow.document.close();
                setTimeout(() => { printWindow.print(); }, 500);
            }
            
            showAlert('PDF –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—é!', 'success');
        }

        function generatePDFReport(invoices, fromDate, toDate) {
            const totalRevenue = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalInvoicesCount = invoices.length;
            const uniqueClients = new Set(invoices.map(inv => inv.client.name)).size;
            const averageOrder = totalInvoicesCount > 0 ? totalRevenue / totalInvoicesCount : 0;

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ–≤–∞—Ä–∞–º
            const productData = {};
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const key = item.product.code;
                    if (!productData[key]) {
                        productData[key] = {
                            name: item.product.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    productData[key].quantity += item.quantity;
                    productData[key].revenue += item.amount;
                });
            });

            const topProducts = Object.entries(productData)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 10);

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
            const clientData = {};
            invoices.forEach(invoice => {
                const clientName = invoice.client.name;
                clientData[clientName] = (clientData[clientName] || 0) + invoice.total;
            });

            const topClients = Object.entries(clientData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
            const monthlyData = {};
            invoices.forEach(invoice => {
                const date = new Date(invoice.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = (monthlyData[monthKey] || 0) + invoice.total;
            });

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('sr-RS');
            };

            const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã –≤—ã—Ä—É—á–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (—Ç–µ–∫—Å—Ç–æ–≤–∞—è)
            let monthlyChartHTML = '';
            if (Object.keys(monthlyData).length > 0) {
                const maxValue = Math.max(...Object.values(monthlyData));
                Object.entries(monthlyData).forEach(([monthKey, value]) => {
                    const [year, month] = monthKey.split('-');
                    const monthName = months[parseInt(month) - 1];
                    const percentage = (value / maxValue) * 100;
                    monthlyChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${monthName} ${year}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 20px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #212529, #343a40); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${((value / totalRevenue) * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                });
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã —Ç–æ–≤–∞—Ä–æ–≤
            let productsChartHTML = '';
            if (topProducts.length > 0) {
                const maxRevenue = topProducts[0][1].revenue;
                topProducts.forEach(([code, data]) => {
                    const percentage = (data.revenue / maxRevenue) * 100;
                    const revenuePercentage = ((data.revenue / totalRevenue) * 100).toFixed(1);
                    productsChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;"><strong>${code}</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${data.name}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${data.quantity}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${data.revenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 15px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #28a745, #20c997); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${revenuePercentage}%</td>
                        </tr>
                    `;
                });
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
            let clientsChartHTML = '';
            if (topClients.length > 0) {
                const maxRevenue = topClients[0][1];
                topClients.forEach(([clientName, revenue]) => {
                    const percentage = (revenue / maxRevenue) * 100;
                    const revenuePercentage = ((revenue / totalRevenue) * 100).toFixed(1);
                    const orderCount = invoices.filter(inv => inv.client.name === clientName).length;
                    clientsChartHTML += `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;"><strong>${clientName}</strong></td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${revenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${orderCount}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">
                                <div style="background: #e9ecef; height: 15px; border-radius: 3px;">
                                    <div style="background: linear-gradient(to right, #212529, #343a40); height: 100%; width: ${percentage}%; border-radius: 3px;"></div>
                                </div>
                            </td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${revenuePercentage}%</td>
                        </tr>
                    `;
                });
            }

            let invoicesListHTML = '';
            invoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(invoice => {
                const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                invoicesListHTML += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 6px; border: 1px solid #ddd;"><strong>${invoice.number}</strong></td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${date}</td>
                        <td style="padding: 6px; border: 1px solid #ddd;">${invoice.client.name}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${invoice.items.length}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${invoice.total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${invoice.vatRate}%</td>
                    </tr>
                `;
            });

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</title>
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; font-size: 11px; line-height: 1.3; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #212529; padding-bottom: 15px; }
                        .logo { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; page-break-inside: avoid; }
                        th { background: #212529; color: white; padding: 8px; text-align: left; font-size: 10px; }
                        td { border: 1px solid #ddd; padding: 6px; font-size: 10px; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
                        .stat-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; text-align: center; border-left: 3px solid #212529; }
                        .stat-number { font-size: 16px; font-weight: bold; color: #212529; margin-bottom: 3px; }
                        .stat-label { font-size: 9px; color: #666; }
                        h2 { color: #212529; border-bottom: 1px solid #212529; padding-bottom: 5px; margin: 20px 0 10px 0; font-size: 14px; }
                        h3 { color: #212529; margin: 15px 0 8px 0; font-size: 12px; }
                        .section { page-break-inside: avoid; margin-bottom: 20px; }
                        .footer { text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid #212529; color: #666; font-size: 9px; }
                    </style>
                </head>
                <body>
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º -->
                    <div class="header">
                        <div class="logo">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="–°—Ä–µƒß–∞ 2024 –î–û–û" style="width: 60px; height: auto; background: #000; border-radius: 8px; padding: 6px;">
                            <div style="text-align: left;">
                                <h1 style="margin: 0; color: #212529; font-size: 18px;">–°—Ä–µƒß–∞ 2024 –î–û–û</h1>
                                <p style="margin: 2px 0; color: #666; font-size: 10px;">–ë–µ–æ–≥—Ä–∞–¥, –°—Ç–∞—Ä–∏ –ì—Ä–∞–¥, –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35</p>
                                <p style="margin: 2px 0; color: #666; font-size: 10px;">–ú–ë: 22019309 | –ü–ò–ë: 114407658</p>
                            </div>
                        </div>
                        <h2 style="margin: 10px 0 5px 0; font-size: 16px; border: none;">–û–¢–ß–ï–¢ –ü–û –ü–†–û–î–ê–ñ–ê–ú</h2>
                        <p style="margin: 0; color: #666; font-size: 11px;">
                            –ü–µ—Ä–∏–æ–¥: ${formatDate(fromDate)} - ${formatDate(toDate)} | 
                            –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleDateString('sr-RS')} –≤ ${new Date().toLocaleTimeString('sr-RS')}
                        </p>
                    </div>

                    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="section">
                        <h2>–ö–õ–Æ–ß–ï–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò</h2>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-number">${totalRevenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</div>
                                <div class="stat-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${totalInvoicesCount}</div>
                                <div class="stat-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–≤–æ–π—Å–æ–≤</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${uniqueClients}</div>
                                <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number">${averageOrder.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</div>
                                <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑</div>
                            </div>
                        </div>
                    </div>

                    <!-- –í—ã—Ä—É—á–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º -->
                    ${Object.keys(monthlyData).length > 0 ? `
                    <div class="section">
                        <h2>–í–´–†–£–ß–ö–ê –ü–û –ú–ï–°–Ø–¶–ê–ú</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>–ú–µ—Å—è—Ü</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>–î–∏–∞–≥—Ä–∞–º–º–∞</th>
                                    <th>% –æ—Ç –æ–±—â–µ–π</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthlyChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤ -->
                    ${topProducts.length > 0 ? `
                    <div class="section">
                        <h2>–¢–û–ü –¢–û–í–ê–†–û–í –ü–û –ü–†–û–î–ê–ñ–ê–ú</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>–ö–æ–¥</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–ö–æ–ª-–≤–æ</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>–î–∏–∞–≥—Ä–∞–º–º–∞</th>
                                    <th>% –æ—Ç –æ–±—â–µ–π</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productsChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- –¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
                    ${topClients.length > 0 ? `
                    <div class="section">
                        <h2>–¢–û–ü –ö–õ–ò–ï–ù–¢–û–í –ü–û –í–´–†–£–ß–ö–ï</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                                    <th>–í—ã—Ä—É—á–∫–∞</th>
                                    <th>–ó–∞–∫–∞–∑–æ–≤</th>
                                    <th>–î–∏–∞–≥—Ä–∞–º–º–∞</th>
                                    <th>% –æ—Ç –æ–±—â–µ–π</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${clientsChartHTML}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}

                    <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–≤–æ–π—Å–æ–≤ -->
                    <div class="section">
                        <h2>–î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û –ò–ù–í–û–ô–°–ê–ú</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>‚Ññ –ò–Ω–≤–æ–π—Å–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                                    <th>–¢–æ–≤–∞—Ä–æ–≤</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–ù–î–°</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoicesListHTML}
                            </tbody>
                        </table>
                    </div>

                    <!-- –ü–æ–¥–≤–∞–ª -->
                    <div class="footer">
                        <p><strong>–°—Ä–µƒß–∞ 2024 –î–û–û</strong> | –ë–µ–æ–≥—Ä–∞–¥, –°—Ç–∞—Ä–∏ –ì—Ä–∞–¥, –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35 | –ú–ë: 22019309 | –ü–ò–ë: 114407658</p>
                        <p>–≠—Ç–æ—Ç –æ—Ç—á–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç ${totalInvoicesCount} –∏–Ω–≤–æ–π—Å–æ–≤ –Ω–∞ –æ–±—â—É—é —Å—É–º–º—É ${totalRevenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ' ')} RSD</p>
                    </div>
                </body>
                </html>
            `;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('invoice-quantity')) {
                const row = e.target.closest('.invoice-items');
                const hiddenProduct = row.querySelector('.invoice-product');
                const productIndex = hiddenProduct.value;
                
                if (productIndex !== '') {
                    const product = products[productIndex];
                    const quantity = parseInt(e.target.value) || 1;
                    const amountInput = row.querySelector('.invoice-amount');
                    amountInput.value = (product.price * quantity).toFixed(2);
                }
                calculateInvoiceTotals();
            }

            if (e.target.id === 'invoiceVAT') {
                calculateInvoiceTotals();
            }
        });

        // –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π
        function addLog(message) {
            const logsList = document.getElementById('logsList');
            const li = document.createElement('li');
            li.textContent = message;
            logsList.appendChild(li);
            logsList.scrollTop = logsList.scrollHeight;
        }

        function clearLogs() {
            if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏?')) {
                localStorage.removeItem('actionLogs');
                updateLogsList();
            }
        }

        function exportLogsToExcel() {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            
            if (logs.length === 0) {
                showAlert('–ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'danger');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º CSV –∫–æ–Ω—Ç–µ–Ω—Ç
            let csvContent = '\uFEFF'; // BOM –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤ Excel
            csvContent += '–í—Ä–µ–º—è,–î–µ–π—Å—Ç–≤–∏–µ\n';
            
            logs.forEach(log => {
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                const time = `"${log.time.replace(/"/g, '""')}"`;
                const action = `"${log.action.replace(/"/g, '""')}"`;
                csvContent += `${time},${action}\n`;
            });

            // –°–æ–∑–¥–∞–µ–º Blob —Å —Ç–∏–ø–æ–º –¥–ª—è Excel
            const blob = new Blob([csvContent], { 
                type: 'application/vnd.ms-excel;charset=utf-8;' 
            });
            
            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS
            const filename = `logs_${dateStr}_${timeStr}.csv`;
            
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM, –∫–ª–∏–∫–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL
            URL.revokeObjectURL(url);
            
            addLog(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${logs.length} –∑–∞–ø–∏—Å–µ–π –ª–æ–≥–æ–≤ –≤ —Ñ–∞–π–ª ${filename}`);
            showAlert(`–õ–æ–≥–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª ${filename}!`, 'success');
        }

        function authenticate() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if (username === 'BrankoFND' && password === 'MoskvaSlezamNeVeryt2024') {
                window.currentUser = {
                    username: 'BrankoFND',
                    isAdmin: true,
                    userType: 'regular',
                    permissions: {
                        clients: true,
                        products: true,
                        warehouse: true,
                        invoice: true,
                        delivery: true,
                        statistics: true,
                        logs: true,
                        editUsers: true
                    }
                };
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeUserInterface();
                addLog('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É');
                document.getElementById('loginError').style.display = 'none';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (username === '—Ç–µ—Å—Ç' && password === '—Ç–µ—Å—Ç') {
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                const defaultPermissions = {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: true,
                    editUsers: false
                };
                
                window.currentUser = {
                    username: '—Ç–µ—Å—Ç',
                    isAdmin: false,
                    userType: 'regular',
                    permissions: builtInPermissions['—Ç–µ—Å—Ç'] || defaultPermissions
                };
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeUserInterface();
                addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É');
                document.getElementById('loginError').style.display = 'none';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å
            if (username === 'SVDA DOO' && password === 'SVDA DOO') {
                window.currentUser = {
                    username: 'SVDA DOO',
                    isAdmin: false,
                    userType: 'client',
                    clientMB: '22058282',
                    permissions: {
                        warehouse: true,
                        incomingDocuments: true,
                        sales: true,
                        clients: false,
                        products: true,
                        invoice: false,
                        delivery: false,
                        statistics: false,
                        logs: false,
                        editUsers: false
                    }
                };
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeUserInterface();
                addLog('–ö–ª–∏–µ–Ω—Ç SVDA DOO –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É');
                document.getElementById('loginError').style.display = 'none';
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ localStorage
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const user = users.find(u => u.login === username && u.password === password);
            
            if (user) {
                window.currentUser = user;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                initializeUserInterface();
                addLog(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${username}" –≤–æ—à—ë–ª –≤ —Å–∏—Å—Ç–µ–º—É`);
                document.getElementById('loginError').style.display = 'none';
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function openAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
            
            // Reset regular user form
            document.getElementById('newUserLogin').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('confirmUserPassword').value = '';
            
            // Reset client user form
            document.getElementById('newClientUserLogin').value = '';
            document.getElementById('newClientUserPassword').value = '';
            document.getElementById('confirmClientUserPassword').value = '';
            document.getElementById('newClientUserMB').value = '';
            document.getElementById('clientDataPreview').style.display = 'none';
            
            // Reset to regular user tab
            switchUserType('regular');
            
            document.getElementById('addUserError').style.display = 'none';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        function switchUserType(type) {
            // Update tab appearance
            document.getElementById('regularUserTab').classList.remove('active');
            document.getElementById('clientUserTab').classList.remove('active');
            document.getElementById(type + 'UserTab').classList.add('active');
            
            const addUserButton = document.getElementById('addUserButton');
            
            // Show/hide forms
            if (type === 'regular') {
                document.getElementById('regularUserForm').style.display = 'block';
                document.getElementById('clientUserForm').style.display = 'none';
                addUserButton.style.display = 'block';
                addUserButton.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            } else {
                document.getElementById('regularUserForm').style.display = 'none';
                document.getElementById('clientUserForm').style.display = 'block';
                addUserButton.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            document.getElementById('clientDataPreview').style.display = 'none';
        }

        function checkClientMB() {
            const mb = document.getElementById('newClientUserMB').value.trim();
            const previewDiv = document.getElementById('clientDataPreview');
            
            if (!mb) {
                previewDiv.style.display = 'none';
                return;
            }
            
            // Find client with matching MB
            const matchingClient = clients.find(client => client.mb === mb);
            
            if (matchingClient) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const login = document.getElementById('newClientUserLogin').value.trim();
                const password = document.getElementById('newClientUserPassword').value.trim();
                const confirmPassword = document.getElementById('confirmClientUserPassword').value.trim();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                if (!login || !password || !confirmPassword) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é, –µ—Å–ª–∏ –ø–æ–ª—è –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
                    document.getElementById('clientPreviewData').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                            <div><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${matchingClient.name}</div>
                            <div><strong>–ü–ò–ë:</strong> ${matchingClient.pib}</div>
                            <div><strong>–ê–¥—Ä–µ—Å:</strong> ${matchingClient.address}</div>
                            <div><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${matchingClient.contact || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 13px;">
                            üí° –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                if (password !== confirmPassword) {
                    showAlert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'danger');
                    return;
                }
                
                if (login.length < 3 || password.length < 3) {
                    showAlert('–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞', 'danger');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                if (users.some(user => user.login === login)) {
                    showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'danger');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                const newUser = {
                    login: login,
                    password: password,
                    username: login,
                    isAdmin: false,
                    userType: 'client',
                    clientMB: mb,
                    permissions: {
                        warehouse: true,
                        incomingDocuments: true,
                        sales: true,
                        clients: false,
                        products: true,
                        invoice: false,
                        delivery: false,
                        statistics: false,
                        logs: false,
                        editUsers: false
                    },
                    createdAt: new Date().toISOString()
                };
                
                users.push(newUser);
                localStorage.setItem('systemUsers', JSON.stringify(users));
                
                console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', newUser);
                addLog(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å: ${login} –¥–ª—è ${matchingClient.name}`);
                showAlert(`–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è "${matchingClient.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`, 'success');
                closeAddUserModal();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                if (document.getElementById('editUsersModal').style.display === 'block') {
                    loadUsersList();
                }
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function addNewUser() {
            const errorDiv = document.getElementById('addUserError');
            const isClientUser = document.getElementById('clientUserForm').style.display !== 'none';
            
            console.log('=== –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ===');
            console.log('isClientUser:', isClientUser);
            console.log('clientUserForm display:', document.getElementById('clientUserForm').style.display);
            console.log('regularUserForm display:', document.getElementById('regularUserForm').style.display);
            
            let login, password, confirmPassword, mb = null;
            let userFields = [];
            
            if (isClientUser) {
                login = document.getElementById('newClientUserLogin').value.trim();
                password = document.getElementById('newClientUserPassword').value.trim();
                confirmPassword = document.getElementById('confirmClientUserPassword').value.trim();
                mb = document.getElementById('newClientUserMB').value.trim();
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                userFields = [
                    { id: 'newClientUserLogin', name: '–õ–æ–≥–∏–Ω', type: 'required' },
                    { id: 'newClientUserPassword', name: '–ü–∞—Ä–æ–ª—å', type: 'required' },
                    { id: 'confirmClientUserPassword', name: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è', type: 'required' },
                    { id: 'newClientUserMB', name: '–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò', type: 'mb' }
                ];
            } else {
                login = document.getElementById('newUserLogin').value.trim();
                password = document.getElementById('newUserPassword').value.trim();
                confirmPassword = document.getElementById('confirmUserPassword').value.trim();
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                userFields = [
                    { id: 'newUserLogin', name: '–õ–æ–≥–∏–Ω', type: 'required' },
                    { id: 'newUserPassword', name: '–ü–∞—Ä–æ–ª—å', type: 'required' },
                    { id: 'confirmUserPassword', name: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è', type: 'required' }
                ];
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
            const validation = validateForm(userFields);
            if (!validation.valid) {
                errorDiv.textContent = validation.errors.join('; ');
                errorDiv.style.display = 'block';
                return;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (login.length < 3) {
                errorDiv.textContent = '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password.length < 3) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                errorDiv.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
                errorDiv.style.display = 'block';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏–Ω—ã
            if (login === '—Ç–µ—Å—Ç' || login === 'BrankoFND') {
                errorDiv.textContent = '–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω';
                errorDiv.style.display = 'block';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            if (users.some(user => user.login === login)) {
                errorDiv.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
                errorDiv.style.display = 'block';
                return;
            }
            
            // –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –ú–ë
            if (isClientUser) {
                const matchingClient = clients.find(client => client.mb === mb);
                if (!matchingClient) {
                    errorDiv.textContent = '–ö–ª–∏–µ–Ω—Ç —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò –Ω–µ –Ω–∞–π–¥–µ–Ω';
                    errorDiv.style.display = 'block';
                    return;
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const newUser = {
                login: login,
                password: password,
                username: login,
                isAdmin: false,
                userType: isClientUser ? 'client' : 'regular',
                clientMB: isClientUser ? mb : null,
                permissions: isClientUser ? {
                    // –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
                    warehouse: true,
                    incomingDocuments: true,
                    sales: true,
                    clients: false,
                    products: false,
                    invoice: false,
                    delivery: false,
                    statistics: false,
                    logs: false,
                    editUsers: false
                } : {
                    // –û–±—ã—á–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
                    clients: true,
                    products: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    warehouse: true,
                    logs: false,
                    editUsers: false
                },
                createdAt: new Date().toISOString()
            };
            
            console.log('–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', newUser);
            console.log('–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', newUser.userType);
            
            users.push(newUser);
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            console.log('–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', users);
            
            addLog(`–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π ${isClientUser ? '–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π' : '–æ–±—ã—á–Ω—ã–π'} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${login}`);
            showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
            closeAddUserModal();
        }

        function openEditUsersModal() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
            if (!window.currentUser || !window.currentUser.permissions.editUsers) {
                showAlert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'warning');
                return;
            }
            
            document.getElementById('editUsersModal').style.display = 'block';
            loadUsersList();
        }

        function closeEditUsersModal() {
            document.getElementById('editUsersModal').style.display = 'none';
        }

        function loadUsersList() {
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const container = document.getElementById('usersList');
            
            console.log('=== –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ===');
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–∑ localStorage:', users);
            
            let usersHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            usersHTML += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">BF</div>
                        <div class="user-details">
                            <h5>BrankoFND</h5>
                            <p>–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUserPermissions('BrankoFND', true)">–î–æ—Å—Ç—É–ø</button>
                        <button class="btn btn-danger" disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            usersHTML += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">–¢–£</div>
                        <div class="user-details">
                            <h5>—Ç–µ—Å—Ç</h5>
                            <p>–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–æ–±—ã—á–Ω—ã–π)</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUserPermissions('—Ç–µ—Å—Ç', false)">–î–æ—Å—Ç—É–ø</button>
                        <button class="btn btn-danger" disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å
            usersHTML += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-avatar">SV</div>
                        <div class="user-details">
                            <h5>SVDA DOO</h5>
                            <p>–¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å (–ú–ë: 22058282)</p>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="editUserPermissions('SVDA DOO', true)">–î–æ—Å—Ç—É–ø</button>
                        <button class="btn btn-danger" disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ localStorage
            users.forEach((user, index) => {
                console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${index}:`, user);
                console.log(`userType: "${user.userType}"`);
                
                const avatar = user.login.substring(0, 2).toUpperCase();
                const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const userTypeText = user.userType === 'client' ? '–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å' : '–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                const clientInfo = user.userType === 'client' && user.clientMB ? ` (–ú–ë: ${user.clientMB})` : '';
                
                console.log(`userTypeText: "${userTypeText}"`);
                console.log(`clientInfo: "${clientInfo}"`);
                
                usersHTML += `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-avatar">${avatar}</div>
                            <div class="user-details">
                                <h5>${user.login}</h5>
                                <p>${userTypeText}${clientInfo}</p>
                                <small>–°–æ–∑–¥–∞–Ω: ${createdDate}</small>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-primary" onclick="editUserPermissions('${user.login}', false, ${index})">–î–æ—Å—Ç—É–ø</button>
                            <button class="btn btn-danger" onclick="deleteUser(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            });
            
            if (users.length === 0) {
                usersHTML += '<p style="text-align: center; color: #666; padding: 20px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</p>';
            }
            
            container.innerHTML = usersHTML;
        }

        function deleteUser(userIndex) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const deletedUser = users[userIndex];
                
                users.splice(userIndex, 1);
                localStorage.setItem('systemUsers', JSON.stringify(users));
                
                addLog(`–£–¥–∞–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${deletedUser.login}`);
                showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!', 'success');
                loadUsersList();
            }
        }

        function editUserPermissions(username, isBuiltIn = false, userIndex = null) {
            window.currentEditingUser = { username, isBuiltIn, userIndex };
            
            document.getElementById('permissionsTitle').textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º - ${username}`;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let permissions = {};
            
            if (username === 'BrankoFND') {
                permissions = {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: true,
                    editUsers: true
                };
            } else if (username === '—Ç–µ—Å—Ç') {
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                permissions = builtInPermissions[username] || {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: true,
                    editUsers: false
                };
            } else if (username === 'SVDA DOO') {
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                permissions = builtInPermissions[username] || {
                    warehouse: true,
                    incomingDocuments: true,
                    sales: true,
                    clients: false,
                    products: false,
                    invoice: false,
                    delivery: false,
                    statistics: false,
                    logs: false,
                    editUsers: false
                };
            } else {
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                const user = users[userIndex];
                permissions = user.permissions || {
                    clients: true,
                    products: true,
                    warehouse: true,
                    invoice: true,
                    delivery: true,
                    statistics: true,
                    logs: false,
                    editUsers: false
                };
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
            document.getElementById('perm_clients').checked = permissions.clients || false;
            document.getElementById('perm_products').checked = permissions.products || false;
            document.getElementById('perm_warehouse').checked = permissions.warehouse || false;
            document.getElementById('perm_invoice').checked = permissions.invoice || false;
            document.getElementById('perm_delivery').checked = permissions.delivery || false;
            document.getElementById('perm_statistics').checked = permissions.statistics || false;
            document.getElementById('perm_logs').checked = permissions.logs || false;
            document.getElementById('perm_editUsers').checked = permissions.editUsers || false;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –≤—Å–µ—Ö –∫—Ä–æ–º–µ BrankoFND
            const editUserLabel = document.getElementById('editUserPermLabel');
            if (username !== 'BrankoFND') {
                document.getElementById('perm_editUsers').disabled = true;
                editUserLabel.style.opacity = '0.5';
                editUserLabel.title = '–¢–æ–ª—å–∫–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
            } else {
                document.getElementById('perm_editUsers').disabled = false;
                editUserLabel.style.opacity = '1';
                editUserLabel.title = '';
            }
            
            document.getElementById('userPermissionsModal').style.display = 'block';
        }

        function closeUserPermissionsModal() {
            document.getElementById('userPermissionsModal').style.display = 'none';
            window.currentEditingUser = null;
        }

        function saveUserPermissions() {
            if (!window.currentEditingUser) return;
            
            const { username, isBuiltIn, userIndex } = window.currentEditingUser;
            
            const permissions = {
                clients: document.getElementById('perm_clients').checked,
                products: document.getElementById('perm_products').checked,
                warehouse: document.getElementById('perm_warehouse').checked,
                invoice: document.getElementById('perm_invoice').checked,
                delivery: document.getElementById('perm_delivery').checked,
                statistics: document.getElementById('perm_statistics').checked,
                logs: document.getElementById('perm_logs').checked,
                editUsers: document.getElementById('perm_editUsers').checked
            };
            
            if (username === 'BrankoFND' || username === '—Ç–µ—Å—Ç' || username === 'SVDA DOO') {
                // –î–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
                const builtInPermissions = JSON.parse(localStorage.getItem('builtInPermissions') || '{}');
                builtInPermissions[username] = permissions;
                localStorage.setItem('builtInPermissions', JSON.stringify(builtInPermissions));
            } else {
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª—è–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–ø–∏—Å–∫–µ
                const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
                if (users[userIndex]) {
                    users[userIndex].permissions = permissions;
                    localStorage.setItem('systemUsers', JSON.stringify(users));
                }
            }
            
            addLog(`–û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${username}`);
            showAlert('–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            closeUserPermissionsModal();
        }

        function initializeUserInterface() {
            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!window.currentUser) return;
            
            const permissions = window.currentUser.permissions;
            const isClientUser = window.currentUser.userType === 'client';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (isClientUser) {
                updateHeaderForClient();
            } else {
                // –í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
                // –∏–Ω–∞—á–µ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
                restoreStandardHeader();
            }
            
            // –î–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
            if (isClientUser) {
                createClientTabs();
            } else {
                // –í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
                // –∏–Ω–∞—á–µ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
                restoreStandardTabs();
                // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const tabs = document.querySelectorAll('.nav-tab');
                tabs.forEach(tab => {
                    const tabName = tab.textContent.toLowerCase();
                    let hasAccess = true;
                    
                    if (tabName.includes('–∫–ª–∏–µ–Ω—Ç—ã')) hasAccess = permissions.clients;
                    else if (tabName.includes('—Ç–æ–≤–∞—Ä—ã')) hasAccess = permissions.products;
                    else if (tabName.includes('—Å–∫–ª–∞–¥')) hasAccess = permissions.warehouse;
                    else if (tabName.includes('–∏–Ω–≤–æ–π—Å')) hasAccess = permissions.invoice;
                    else if (tabName.includes('–æ—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞')) hasAccess = permissions.delivery;
                    else if (tabName.includes('–∑–∞–∫–∞–∑—ã')) hasAccess = true; // –ó–∞–∫–∞–∑—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                    else if (tabName.includes('—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞')) hasAccess = permissions.statistics;
                    
                    if (!hasAccess) {
                        tab.style.display = 'none';
                    } else {
                        tab.style.display = 'block';
                    }
                });
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
            const logsBtn = document.querySelector('[onclick="openLogsModal()"]');
            if (logsBtn) {
                if (permissions.logs) {
                    logsBtn.style.display = 'block';
                } else {
                    logsBtn.style.display = 'none';
                }
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const clientSelectionGroup = document.querySelector('#productClientSearch')?.closest('.form-group');
            if (clientSelectionGroup) {
                if (isClientUser) {
                    clientSelectionGroup.style.display = 'none';
                } else {
                    clientSelectionGroup.style.display = 'block';
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã" —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
            const showAllProductsBtn = document.getElementById('showAllProductsBtn');
            
            if (window.currentUser && (window.currentUser.isAdmin || window.currentUser.username === 'BrankoFND')) {
                if (showAllProductsBtn) showAllProductsBtn.style.display = 'inline-block';
            } else {
                if (showAllProductsBtn) showAllProductsBtn.style.display = 'none';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const editUsersBtn = document.querySelector('[onclick="openEditUsersModal()"]');
            if (editUsersBtn) {
                if (permissions.editUsers) {
                    editUsersBtn.style.display = 'block';
                } else {
                    editUsersBtn.style.display = 'none';
                }
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
            const addUserBtn = document.querySelector('[onclick="openAddUserModal()"]');
            if (addUserBtn) {
                if (isClientUser) {
                    addUserBtn.style.display = 'none';
                } else {
                    addUserBtn.style.display = 'block';
                }
            }
        }

        function updateHeaderForClient() {
            if (!window.currentUser || !window.currentUser.clientMB) return;
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –ú–ë
            const client = clients.find(c => c.mb === window.currentUser.clientMB);
            if (!client) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const headerTitle = document.querySelector('.header h1');
            const headerSubtitle = document.querySelector('.header p');
            
            if (headerTitle) {
                headerTitle.textContent = client.legalName || client.name;
            }
            
            if (headerSubtitle) {
                headerSubtitle.textContent = `–ú–ë: ${client.mb} | –ü–ò–ë: ${client.pib} | ${client.address}`;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        function restoreStandardHeader() {
            console.log('=== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–ù–î–ê–†–¢–ù–û–ì–û –ó–ê–ì–û–õ–û–í–ö–ê ===');
            
            const headerTitle = document.querySelector('.header h1');
            const headerSubtitles = document.querySelectorAll('.header p');
            
            if (headerTitle) {
                headerTitle.textContent = '–°—Ä–µƒß–∞ 2024 –î–û–û';
                console.log('‚úÖ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –°—Ä–µƒß–∞ 2024 –î–û–û');
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏
            if (headerSubtitles.length >= 1) {
                headerSubtitles[0].textContent = '–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–æ–π—Å–∞–º–∏ –∏ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞–º–∏';
                console.log('‚úÖ –ü–µ—Ä–≤—ã–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
            
            if (headerSubtitles.length >= 2) {
                headerSubtitles[1].textContent = '–ë–µ–æ–≥—Ä–∞–¥, –°—Ç–∞—Ä–∏ –ì—Ä–∞–¥, –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35 | –ú–ë: 22019309 | –ü–ò–ë: 114407658';
                headerSubtitles[1].style.fontSize = '14px';
                headerSubtitles[1].style.opacity = '0.8';
                console.log('‚úÖ –í—Ç–æ—Ä–æ–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            }
            
            console.log('‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        }

        function createClientTabs() {
            const navigation = document.querySelector('.nav-tabs');
            if (!navigation) return;
            
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            navigation.innerHTML = '';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ –±–ª–æ–∫–∏
            const standardTabContents = document.querySelectorAll('.tab-content');
            standardTabContents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≤–∫–ª–∞–¥–∫–∏
            const clientTabs = [
                { id: 'clientWarehouseTab', text: '–°–∫–ª–∞–¥', target: 'warehouse' },
                { id: 'clientMainProductsTab', text: '–¢–æ–≤–∞—Ä—ã', target: 'products' }
                // –£–±—Ä–∞–ª–∏ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –≤–∫–ª–∞–¥–∫–∏ - –æ–Ω–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ createClientTabContent()
            ];
            
            clientTabs.forEach((tabInfo, index) => {
                const tab = document.createElement('button');
                tab.id = tabInfo.id;
                tab.className = 'nav-tab';
                if (index === 0) tab.classList.add('active'); // –ü–µ—Ä–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                tab.textContent = tabInfo.text;
                tab.onclick = (e) => showTab(tabInfo.target, e);
                navigation.appendChild(tab);
            });
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –Ω–æ–≤—ã—Ö –≤–∫–ª–∞–¥–æ–∫
            createClientTabContent();
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
            const groupCreationForm = document.getElementById('groupCreationForm');
            if (groupCreationForm) {
                groupCreationForm.style.display = 'none';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            setTimeout(() => {
                showTab('warehouse');
            }, 100);
        }

        function restoreStandardTabs() {
            console.log('=== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–ù–î–ê–†–¢–ù–´–• –í–ö–õ–ê–î–û–ö ===');
            
            const navigation = document.querySelector('.nav-tabs');
            if (!navigation) return;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
            navigation.innerHTML = `
                <button class="nav-tab active" onclick="showTab('clients')">–ö–ª–∏–µ–Ω—Ç—ã</button>
                <button class="nav-tab" onclick="showTab('products')">–¢–æ–≤–∞—Ä—ã</button>
                <button class="nav-tab" onclick="showTab('warehouse')">–°–∫–ª–∞–¥</button>
                <button class="nav-tab" onclick="showTab('invoice')">–°–æ–∑–¥–∞—Ç—å –∏–Ω–≤–æ–π—Å</button>
                <button class="nav-tab" onclick="showTab('delivery')">–°–æ–∑–¥–∞—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É</button>
                <button class="nav-tab" onclick="showTab('orders')" id="ordersTabBtn">–ó–∞–∫–∞–∑—ã</button>
                <button class="nav-tab" onclick="showTab('statistics')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</button>
            `;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (—Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ)
            const standardTabContents = document.querySelectorAll('.tab-content');
            standardTabContents.forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ –±–ª–æ–∫–∏ (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º products)
            const clientTabs = ['incomingDocuments', 'clientSales'];
            clientTabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) tab.remove();
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const filterContainer = document.getElementById('productUserFilter')?.parentElement;
            if (filterContainer) {
                filterContainer.style.display = 'block';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
            const clientSelectionGroup = document.querySelector('#productClientSearch')?.closest('.form-group');
            if (clientSelectionGroup) {
                clientSelectionGroup.style.display = 'block';
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            restoreStandardHeader();
            
            // –î–µ–ª–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–π –ø–µ—Ä–≤—É—é —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            showTab('clients');
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–¥–º–∏–Ω–∞
            setTimeout(() => {
                if (window.currentUser && (window.currentUser.isAdmin || window.currentUser.username === 'BrankoFND')) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã"
                    const showAllProductsBtn = document.getElementById('showAllProductsBtn');
                    if (showAllProductsBtn) {
                        showAllProductsBtn.style.display = 'inline-block';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
                    if (document.getElementById('products')?.style.display !== 'none') {
                        renderProductsTable();
                    }
                }
            }, 100);
            
            console.log('‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
        }

        function createClientTabContent() {
            const container = document.querySelector('.container');
            if (!container) return;

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –≤–∫–ª–∞–¥–æ–∫
            const navTabs = document.querySelector('.nav-tabs');
            if (navTabs) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
                const incomingDocsBtn = document.createElement('button');
                incomingDocsBtn.className = 'nav-tab';
                incomingDocsBtn.textContent = '–í—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã';
                incomingDocsBtn.onclick = () => showTab('incomingDocuments');
                
                const salesBtn = document.createElement('button');
                salesBtn.className = 'nav-tab';
                salesBtn.textContent = '–ü—Ä–æ–¥–∞–∂–∏';
                salesBtn.onclick = () => {
                    showTab('clientSales');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø—Ä–æ–¥–∞–∂
                    setTimeout(() => loadSalesProducts(), 100);
                };
                
                const ordersBtn = document.createElement('button');
                ordersBtn.className = 'nav-tab';
                ordersBtn.textContent = '–ó–∞–∫–∞–∑—ã';
                ordersBtn.onclick = () => {
                    showTab('clientOrders');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∑–∞–∫–∞–∑–æ–≤
                    setTimeout(() => {
                        console.log('–û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –∑–∞–∫–∞–∑–æ–≤...');
                        
                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞
                        window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                        console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ç–æ–≤–∞—Ä—ã –∏–∑ localStorage:', window.clientProducts.length);
                        
                        loadOrdersProducts();
                        loadOrdersHistory();
                    }, 100);
                };
                
                navTabs.appendChild(incomingDocsBtn);
                navTabs.appendChild(salesBtn);
                navTabs.appendChild(ordersBtn);
            }

            // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–í—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã"
            const incomingDocsTab = document.createElement('div');
            incomingDocsTab.id = 'incomingDocuments';
            incomingDocsTab.className = 'tab-content';
            incomingDocsTab.innerHTML = `
                <h2>–í—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>
                <div class="section-card">
                    <h3>–ò–Ω–≤–æ–π—Å—ã</h3>
                    <div id="incomingInvoicesList" class="table-container">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            –ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤
                        </div>
                    </div>
                </div>
                <div class="section-card">
                    <h3>–û—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã</h3>
                    <div id="incomingDeliveriesList" class="table-container">
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            –ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü
                        </div>
                    </div>
                </div>
            `;
            
            // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–ü—Ä–æ–¥–∞–∂–∏"
            const salesTab = document.createElement('div');
            salesTab.id = 'clientSales';
            salesTab.className = 'tab-content';
            salesTab.innerHTML = `
                <h2>–ü—Ä–æ–¥–∞–∂–∏</h2>
                
                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="section-card">
                    <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ:</label>
                            <select id="salesAvailabilityFilter" onchange="applySalesFilters()">
                                <option value="available">–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ</option>
                                <option value="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                                <option value="unavailable">–¢–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é:</label>
                            <input type="text" id="salesSearchFilter" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." onkeyup="applySalesFilters()">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="applySalesFilters()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                        <button class="btn btn-secondary" onclick="clearSalesFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    </div>
                </div>
                
                <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ -->
                <div class="section-card">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</h3>
                    <div id="salesProductsList" class="table-container">
                        <table class="table" id="salesProductsTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">–í—ã–±—Ä–∞—Ç—å</th>
                                    <th>–ö–æ–¥</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–í–µ—Å (–≥)</th>
                                    <th style="width: 120px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th style="width: 100px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="salesProductsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #666;">–¢–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="processSale()">–£—á–µ—Å—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
                        <button class="btn btn-secondary" onclick="clearSalesForm()">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                        <button class="btn btn-info" onclick="debugSalesProducts()" style="margin-left: 10px;">–û—Ç–ª–∞–¥–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤</button>
                    </div>
                </div>

                <!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂ -->
                <div class="section-card" style="margin-top: 30px;">
                    <h3>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂</h3>
                    <div id="clientSalesHistory" class="table-container">
                        <table class="table" id="salesHistoryTable">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                                    <th>–¢–æ–≤–∞—Ä—ã</th>
                                    <th>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="salesHistoryTableBody">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #666;">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂ –ø—É—Å—Ç–∞</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–ó–∞–∫–∞–∑—ã"
            const ordersTab = document.createElement('div');
            ordersTab.id = 'clientOrders';
            ordersTab.className = 'tab-content';
            ordersTab.innerHTML = `
                <h2>–ó–∞–∫–∞–∑—ã</h2>
                
                <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ -->
                <div class="section-card">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–∫–∞–∑–∞</h3>
                    <div id="ordersProductsList" class="table-container">
                        <table class="table" id="ordersProductsTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">–í—ã–±—Ä–∞—Ç—å</th>
                                    <th>–ö–æ–¥</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–í–µ—Å (–≥)</th>
                                    <th>–¶–µ–Ω–∞ –±–µ–∑ –ù–î–°</th>
                                    <th>–¶–µ–Ω–∞ —Å –ù–î–° (+20%)</th>
                                    <th style="width: 120px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                </tr>
                            </thead>
                            <tbody id="ordersProductsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: #666;">–¢–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="createOrder()">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑</button>
                        <button class="btn btn-secondary" onclick="clearOrderForm()">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä</button>
                    </div>
                </div>

                <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ -->
                <div class="section-card" style="margin-top: 30px;">
                    <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
                    <div id="clientOrdersHistory" class="table-container">
                        <table class="table" id="ordersHistoryTable">
                            <thead>
                                <tr>
                                    <th>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–¢–æ–≤–∞—Ä—ã</th>
                                    <th>–°—É–º–º–∞ –±–µ–∑ –ù–î–°</th>
                                    <th>–°—É–º–º–∞ —Å –ù–î–°</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="ordersHistoryTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: #666;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –≤–∫–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            const existingTabs = container.querySelector('.tab-content');
            if (existingTabs && existingTabs.parentNode) {
                existingTabs.parentNode.appendChild(incomingDocsTab);
                existingTabs.parentNode.appendChild(salesTab);
                existingTabs.parentNode.appendChild(ordersTab);
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂
            loadIncomingDocuments();
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∫–ª–∞–¥–∫–∏...');
            loadSalesProducts();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–∫–∞–∑–æ–≤
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∫–ª–∞–¥–∫–∏...');
            loadOrdersProducts();
            loadOrdersHistory();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => {
                loadSalesProducts();
                loadOrdersProducts();
                loadOrdersHistory();
            }, 200);
        }



        function loadWarehouseProductsForBinding() {
            const select = document.getElementById('clientProductWarehouseLink');
            if (!select) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç clientProductWarehouseLink –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–ª–∞–¥–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏...');
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞...</option>';
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω matiƒçni broj –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –≥—Ä—É–ø–ø –Ω–∞ —Å–∫–ª–∞–¥–µ
            const warehouseProducts = [];
            if (window.clientProductGroups[clientMB] && window.clientProductGroups[clientMB].length > 0) {
                window.clientProductGroups[clientMB].forEach(group => {
                    if (group.products && group.products.length > 0) {
                        group.products.forEach(productInGroup => {
                            const product = productInGroup.product;
                            if (product && !warehouseProducts.find(p => p.internalCode === product.internalCode)) {
                                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –Ω–∞ —Å–∫–ª–∞–¥–µ
                                warehouseProducts.push({
                                    ...product,
                                    availableQuantity: group.currentQuantity,
                                    groupName: group.name
                                });
                            }
                        });
                    }
                });
            }
            
            if (warehouseProducts.length === 0) {
                const noProductsOption = document.createElement('option');
                noProductsOption.value = '';
                noProductsOption.textContent = '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ (—Å–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–∏—Ç–µ –∏–Ω–≤–æ–π—Å)';
                noProductsOption.disabled = true;
                select.appendChild(noProductsOption);
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–ª–∞–¥–∞ –≤ select
                warehouseProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.internalCode;
                    option.textContent = `${product.code} - ${product.name} (${product.weight}–≥) - –û—Å—Ç–∞—Ç–æ–∫: ${product.availableQuantity}–≥`;
                    select.appendChild(option);
                });
            }
            
            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–ª–∞–¥–∞:', warehouseProducts.length);
        }

        // ===== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–û–î–£–ö–¢–ê–ú–ò –ö–õ–ò–ï–ù–¢–ê =====
        // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ—Ç —Ñ—É–Ω–∫—Ü–∏–π –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

        function showAddClientProductForm() {
            console.log('=== –ü–û–ö–ê–ó–ê–¢–¨ –§–û–†–ú–£ –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ü–†–û–î–£–ö–¢–ê ===');
            const form = document.getElementById('clientProductAddForm');
            if (form) {
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
                if (form.style.display === 'block') {
                    loadWarehouseOptionsForNewProduct();
                }
            }
        }

        function loadWarehouseOptionsForNewProduct() {
            console.log('=== –ó–ê–ì–†–£–ó–ö–ê –û–ü–¶–ò–ô –°–ö–õ–ê–î–ê –î–õ–Ø –ù–û–í–û–ì–û –ü–†–û–î–£–ö–¢–ê ===');
            const select = document.getElementById('newClientProductWarehouseLink');
            if (!select) return;

            // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
            select.innerHTML = '<option value="">–ë–µ–∑ —Å–≤—è–∑–∏ —Å–æ —Å–∫–ª–∞–¥–æ–º</option>';

            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω matiƒçni broj –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –∏–∑ –≥—Ä—É–ø–ø —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ
            if (window.clientProductGroups[clientMB] && window.clientProductGroups[clientMB].length > 0) {
                window.clientProductGroups[clientMB].forEach(group => {
                    if (group.products && group.products.length > 0) {
                        group.products.forEach(productInGroup => {
                            const option = document.createElement('option');
                            option.value = productInGroup.product.code;
                            option.textContent = `${productInGroup.product.name} (${productInGroup.product.code}) - ${group.currentQuantity}–≥`;
                            select.appendChild(option);
                        });
                    }
                });
            }

            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ–ø—Ü–∏–π —Å–∫–ª–∞–¥–∞:', select.options.length - 1);
        }

        function saveNewClientProduct() {
            console.log('=== –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–û–í–û–ì–û –ü–†–û–î–£–ö–¢–ê –ö–õ–ò–ï–ù–¢–ê ===');
            
            const code = document.getElementById('newClientProductCode').value.trim();
            const name = document.getElementById('newClientProductName').value.trim();
            const weight = parseFloat(document.getElementById('newClientProductWeight').value);
            const warehouseLink = document.getElementById('newClientProductWarehouseLink').value;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!code) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞!', 'danger');
                return;
            }
            if (!name) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞!', 'danger');
                return;
            }
            if (!weight || weight <= 0) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å/–æ–±—ä–µ–º!', 'danger');
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProducts) {
                window.clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            }

            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                showAlert('–û—à–∏–±–∫–∞: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç!', 'danger');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞
            const existingProduct = window.clientProducts.find(p => 
                p.clientMB === clientMB && p.code === code
            );
            if (existingProduct) {
                showAlert('–ü—Ä–æ–¥—É–∫—Ç —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'danger');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç
            const newProduct = {
                code: code,
                name: name,
                weight: weight,
                warehouseLink: warehouseLink || null,
                warehouseProduct: null,
                createdAt: new Date().toISOString(),
                clientMB: clientMB,
                autoCreated: false,
                type: 'clientProduct'
            };

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å —Å–æ —Å–∫–ª–∞–¥–æ–º, –Ω–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä
            if (warehouseLink) {
                const warehouseProduct = findWarehouseProductByCode(warehouseLink);
                if (warehouseProduct) {
                    newProduct.warehouseProduct = warehouseProduct;
                    console.log('–ü—Ä–æ–¥—É–∫—Ç —Å–≤—è–∑–∞–Ω —Å–æ —Å–∫–ª–∞–¥–æ–º:', warehouseProduct);
                }
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–¥—É–∫—Ç
            window.clientProducts.push(newProduct);
            safeLocalStorage('set', 'clientProducts', window.clientProducts);

            console.log('–ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', newProduct);
            addLog(`–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–ª –ø—Ä–æ–¥—É–∫—Ç: ${name} (${code})`);
            showAlert('–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            clearNewClientProductForm();
            refreshClientProductsList();
            cancelAddClientProduct();
        }

        function clearNewClientProductForm() {
            document.getElementById('newClientProductCode').value = '';
            document.getElementById('newClientProductName').value = '';
            document.getElementById('newClientProductWeight').value = '';
            document.getElementById('newClientProductWarehouseLink').value = '';
        }

        function cancelAddClientProduct() {
            const form = document.getElementById('clientProductAddForm');
            if (form) {
                form.style.display = 'none';
            }
        }

        function refreshClientProductsList() {
            console.log('=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ü–†–û–î–£–ö–¢–û–í –ö–õ–ò–ï–ù–¢–ê ===');
            renderClientProductsTable();
        }

        function editClientProduct(code) {
            console.log('=== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–î–£–ö–¢–ê –ö–õ–ò–ï–ù–¢–ê ===', code);
            
            if (!window.clientProducts) {
                window.clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            }

            const clientMB = window.currentUser?.clientMB;
            const product = window.clientProducts.find(p => 
                p.clientMB === clientMB && p.code === code
            );

            if (!product) {
                showAlert('–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'danger');
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('editClientProductName').value = product.name;
            document.getElementById('editClientProductWeight').value = product.weight;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            window.editingProductCode = code;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.getElementById('editClientProductModal');
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function saveClientProductChangesForClient() {
            console.log('=== –°–û–•–†–ê–ù–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô –ü–†–û–î–£–ö–¢–ê (–î–õ–Ø –ö–õ–ò–ï–ù–¢–ê) ===');
            
            const code = window.editingProductCode;
            const name = document.getElementById('editClientProductName').value.trim();
            const weight = parseFloat(document.getElementById('editClientProductWeight').value);

            if (!name) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞!', 'danger');
                return;
            }
            if (!weight || weight <= 0) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–µ—Å/–æ–±—ä–µ–º!', 'danger');
                return;
            }

            const clientMB = window.currentUser?.clientMB;
            const productIndex = window.clientProducts.findIndex(p => 
                p.clientMB === clientMB && p.code === code
            );

            if (productIndex === -1) {
                showAlert('–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'danger');
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–¥—É–∫—Ç
            window.clientProducts[productIndex].name = name;
            window.clientProducts[productIndex].weight = weight;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            safeLocalStorage('set', 'clientProducts', window.clientProducts);

            console.log('–ü—Ä–æ–¥—É–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω:', window.clientProducts[productIndex]);
            addLog(`–ö–ª–∏–µ–Ω—Ç –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª –ø—Ä–æ–¥—É–∫—Ç: ${name} (${code})`);
            showAlert('–ü—Ä–æ–¥—É–∫—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            closeEditClientProductModal();
            refreshClientProductsList();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–¥–∞–∂ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
            if (document.getElementById('clientSales') && document.getElementById('clientSales').classList.contains('active')) {
                loadSalesProducts();
            }
        }

        function closeEditClientProductModal() {
            const modal = document.getElementById('editClientProductModal');
            if (modal) {
                modal.style.display = 'none';
            }
            window.editingProductCode = null;
        }

        function removeClientProduct(code) {
            console.log('=== –£–î–ê–õ–ï–ù–ò–ï –ü–†–û–î–£–ö–¢–ê –ö–õ–ò–ï–ù–¢–ê ===', code);
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç?')) return;

            if (!window.clientProducts) {
                window.clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            }

            const clientMB = window.currentUser?.clientMB;
            const initialLength = window.clientProducts.length;
            
            window.clientProducts = window.clientProducts.filter(p => 
                !(p.clientMB === clientMB && p.code === code)
            );

            if (window.clientProducts.length === initialLength) {
                showAlert('–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'danger');
                return;
            }

            safeLocalStorage('set', 'clientProducts', window.clientProducts);

            console.log('–ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª–µ–Ω:', code);
            addLog(`–ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–∏–ª –ø—Ä–æ–¥—É–∫—Ç: ${code}`);
            showAlert('–ü—Ä–æ–¥—É–∫—Ç —É–¥–∞–ª–µ–Ω!', 'success');

            refreshClientProductsList();
        }

        function debugClientProducts() {
            console.log('=== –û–¢–õ–ê–î–ö–ê –ü–†–û–î–£–ö–¢–û–í –ö–õ–ò–ï–ù–¢–ê ===');
            console.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', window.currentUser);
            console.log('–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤:', window.clientProducts);
            
            const clientMB = window.currentUser?.clientMB;
            if (clientMB) {
                const myProducts = window.clientProducts?.filter(p => p.clientMB === clientMB) || [];
                console.log(`–ü—Ä–æ–¥—É–∫—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞ ${clientMB}:`, myProducts);
                showAlert(`–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ${myProducts.length}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.`, 'info');
            } else {
                showAlert('–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω!', 'danger');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
        function calculateAvailableQuantityForSale(clientProduct) {
            console.log('–†–∞—Å—á–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è:', clientProduct);
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω matiƒçni broj –∫–ª–∏–µ–Ω—Ç–∞');
                return 0;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –≥—Ä—É–ø–ø—É –Ω–∞ —Å–∫–ª–∞–¥–µ, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –¥–∞–Ω–Ω—ã–º —Ç–æ–≤–∞—Ä–æ–º –∫–ª–∏–µ–Ω—Ç–∞
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–æ internalCode, –∏ –ø–æ code –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            const warehouseLink = clientProduct.warehouseLink || clientProduct.internalCode || clientProduct.code;
            const matchingGroup = window.clientProductGroups[clientMB].find(group => 
                group.products && group.products.some(p => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ internalCode —Ç–æ–≤–∞—Ä–∞ –≤ –≥—Ä—É–ø–ø–µ
                    if (p.product && p.product.internalCode === warehouseLink) return true;
                    // Fallback: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –∫–æ–¥—É —Ç–æ–≤–∞—Ä–∞
                    if (p.product && p.product.code === warehouseLink) return true;
                    // –î–ª—è —Å—Ç–∞—Ä—ã—Ö –≥—Ä—É–ø–ø: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ internalCode –Ω–∞–ø—Ä—è–º—É—é
                    if (p.internalCode === warehouseLink) return true;
                    return false;
                })
            );
            
            if (!matchingGroup) {
                console.log(`–ì—Ä—É–ø–ø–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞: ${clientProduct.code}, warehouseLink: ${warehouseLink}`);
                return 0;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ (–≤ –≥—Ä–∞–º–º–∞—Ö)
            const warehouseQuantity = matchingGroup.currentQuantity || 0;
            
            // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Å –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ (–≤ –≥—Ä–∞–º–º–∞—Ö)
            const productWeight = clientProduct.weight || 1;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ / –≤–µ—Å –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã
            const availableUnits = Math.floor(warehouseQuantity / productWeight);
            
            console.log(`–†–∞—Å—á–µ—Ç –¥–ª—è ${clientProduct.code}:`, {
                warehouseQuantity: warehouseQuantity,
                productWeight: productWeight,
                availableUnits: availableUnits
            });
            
            return Math.max(0, availableUnits);
        }
        
        function loadSalesProducts() {
            const tableBody = document.getElementById('salesProductsTableBody');
            if (!tableBody) return;
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</td></tr>';
                return;
            }
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û clientProducts, –ù–ï window.products
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ localStorage –¥–ª—è –ø—Ä–æ–¥–∞–∂:', window.clientProducts);
            }
            
            // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –±–µ–∑ internalCode
            migrateClientProductsInternalCodes();
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            // –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å internalCode
            let currentClientProducts = window.clientProducts.filter(product => 
                product.clientMB === currentClientMB && 
                product.availableForSale
            );
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            currentClientProducts = applySalesProductFilters(currentClientProducts);
            
            // –û–¢–õ–ê–î–ö–ê: –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –±–µ–∑ internalCode (–µ—Å–ª–∏ –µ—Å—Ç—å)
            const productsWithoutInternalCode = currentClientProducts.filter(p => !p.internalCode);
            if (productsWithoutInternalCode.length > 0) {
                console.warn('–ù–∞–π–¥–µ–Ω—ã —Ç–æ–≤–∞—Ä—ã –±–µ–∑ internalCode –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:', productsWithoutInternalCode);
            }
            
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂ (–¢–û–õ–¨–ö–û clientProducts):', currentClientProducts.length);
            console.log('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:', currentClientProducts);
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–ª–∞–¥—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            if (!window.clientProductGroups[currentClientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${currentClientMB}`);
                window.clientProductGroups[currentClientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            console.log('–°–∫–ª–∞–¥—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', window.clientProductGroups[currentClientMB]);
            
            if (currentClientProducts.length === 0) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ –≤–æ–æ–±—â–µ (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤)
                const allClientProducts = window.clientProducts.filter(product => 
                    product.clientMB === currentClientMB && product.availableForSale
                );
                
                if (allClientProducts.length > 0) {
                    const availabilityFilter = document.getElementById('salesAvailabilityFilter')?.value || 'available';
                    if (availabilityFilter === 'available') {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">–¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ. –°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä.</td></tr>';
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</td></tr>';
                    }
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">–¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∏–Ω–≤–æ–π—Å–æ–≤.</td></tr>';
                }
                return;
            }
            
            tableBody.innerHTML = currentClientProducts.map(product => {
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
                const availableQuantity = calculateAvailableQuantityForSale(product);
                const availabilityColor = availableQuantity > 0 ? '#28a745' : '#dc3545';
                const availabilityText = availableQuantity > 0 ? `–î–æ—Å—Ç—É–ø–Ω–æ: ${availableQuantity} —à—Ç.` : '–ù–µ –¥–æ—Å—Ç—É–ø–Ω–æ';
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" id="sale_${product.internalCode}" class="sale-checkbox" data-product-code="${product.internalCode}" ${availableQuantity <= 0 ? 'disabled' : ''}>
                        </td>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.weight}${typeof product.weight === 'number' ? '–≥' : ''}</td>
                        <td>
                            <input type="number" id="qty_${product.internalCode}" class="sale-quantity" min="1" max="${availableQuantity}" placeholder="–ö–æ–ª-–≤–æ" style="width: 100px;" ${availableQuantity <= 0 ? 'disabled' : ''}>
                            <br><small style="color: ${availabilityColor}; font-weight: bold;">${availabilityText}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditProductModal('${product.internalCode}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä">
                                ‚úèÔ∏è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function loadOrdersProducts() {
            const tableBody = document.getElementById('ordersProductsTableBody');
            if (!tableBody) return;
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc3545;">–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</td></tr>';
                return;
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ localStorage –¥–ª—è –∑–∞–∫–∞–∑–æ–≤:', window.clientProducts);
            }
            
            // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –±–µ–∑ internalCode
            migrateClientProductsInternalCodes();
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            const currentClientProducts = window.clientProducts.filter(product => {
                const matchesClient = product.clientMB === currentClientMB;
                const isAvailable = product.availableForSale === true;
                
                console.log(`–¢–æ–≤–∞—Ä ${product.code}: clientMB=${product.clientMB}, target=${currentClientMB}, matches=${matchesClient}, available=${product.availableForSale}, isAvailable=${isAvailable}`);
                
                return matchesClient && isAvailable;
            });
            
            // –û–¢–õ–ê–î–ö–ê: –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ - –≤—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤:', window.clientProducts.length);
            console.log('–¢–æ–≤–∞—Ä—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ (' + currentClientMB + '):', currentClientProducts.length);
            console.log('–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤:', currentClientProducts.map(p => ({
                code: p.code,
                name: p.name,
                clientMB: p.clientMB,
                availableForSale: p.availableForSale,
                internalCode: p.internalCode
            })));
            
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∑–∞–∫–∞–∑–æ–≤:', currentClientProducts.length);
            
            if (currentClientProducts.length === 0) {
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                const allClientProducts = window.clientProducts.filter(product => product.clientMB === currentClientMB);
                console.log('–í—Å–µ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ (–≤–∫–ª—é—á–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏):', allClientProducts.length);
                
                if (allClientProducts.length > 0) {
                    console.log('–ù–∞–π–¥–µ–Ω—ã —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞, –Ω–æ –æ–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:', allClientProducts.map(p => ({
                        code: p.code,
                        name: p.name,
                        availableForSale: p.availableForSale
                    })));
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc3545;">–ù–∞–π–¥–µ–Ω—ã —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞, –Ω–æ –æ–Ω–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∑–∞–∫–∞–∑–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤.</td></tr>';
                } else {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">–¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∏–Ω–≤–æ–π—Å–æ–≤.</td></tr>';
                }
                return;
            }
            
            tableBody.innerHTML = currentClientProducts.map(product => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É)
                // –ù–ï –∏—â–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const basePrice = product.price; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
                
                if (!basePrice) {
                    console.warn(`–í–Ω–∏–º–∞–Ω–∏–µ: —É —Ç–æ–≤–∞—Ä–∞ ${product.code} –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ü–µ–Ω–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä.`);
                }
                const productName = product.name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
                const productCode = product.code; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
                
                const priceWithoutVAT = (basePrice || 0).toFixed(2);
                const priceWithVAT = ((basePrice || 0) * 1.2).toFixed(2); // +20% –ù–î–°
                
                console.log(`–¢–æ–≤–∞—Ä –¥–ª—è –∑–∞–∫–∞–∑–∞ ${productCode}: –Ω–∞–∑–≤–∞–Ω–∏–µ="${productName}", —Ü–µ–Ω–∞ –±–µ–∑ –ù–î–°=${priceWithoutVAT} –†–°–î`);
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" id="order_${product.internalCode}" class="order-checkbox" data-product-code="${product.internalCode}">
                        </td>
                        <td>${productCode}</td>
                        <td>${productName}</td>
                        <td>${product.weight}${typeof product.weight === 'number' ? '–≥' : ''}</td>
                        <td>${priceWithoutVAT} –†–°–î</td>
                        <td>${priceWithVAT} –†–°–î</td>
                        <td>
                            <input type="number" id="order_qty_${product.internalCode}" class="order-quantity" min="1" placeholder="–ö–æ–ª-–≤–æ" style="width: 100px;">
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function migrateClientProductsInternalCodes() {
            console.log('=== –ú–ò–ì–†–ê–¶–ò–Ø –¢–û–í–ê–†–û–í –ö–õ–ò–ï–ù–¢–û–í ===');
            
            if (!window.clientProducts || window.clientProducts.length === 0) {
                console.log('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏');
                return;
            }
            
            let migrationNeeded = false;
            const productsToRemove = [];
            
            window.clientProducts.forEach((clientProduct, index) => {
                if (!clientProduct.internalCode) {
                    console.warn(`–¢–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ ${clientProduct.code} –Ω–µ –∏–º–µ–µ—Ç internalCode.`);
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä –ø–æ –∫–æ–¥—É
                    const mainProduct = window.products?.find(p => p.code === clientProduct.code);
                    if (mainProduct) {
                        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ —É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç internalCode, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–æ–¥ –∫–∞–∫ internalCode
                        const internalCode = mainProduct.internalCode || mainProduct.code;
                        console.log(`–ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä ${clientProduct.code}: –¥–æ–±–∞–≤–ª—è–µ–º internalCode = ${internalCode}`);
                        clientProduct.internalCode = internalCode;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º warehouseLink –µ—Å–ª–∏ –æ–Ω –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                        if (!clientProduct.warehouseLink) {
                            clientProduct.warehouseLink = internalCode;
                        }
                        
                        migrationNeeded = true;
                    } else {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä –¥–ª—è ${clientProduct.code}. –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∫–∞–∫ internalCode.`);
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∫–∞–∫ fallback –¥–ª—è internalCode
                        clientProduct.internalCode = clientProduct.code;
                        if (!clientProduct.warehouseLink) {
                            clientProduct.warehouseLink = clientProduct.code;
                        }
                        migrationNeeded = true;
                    }
                }
                
                // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–æ–≤–∞—Ä –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
                if (!clientProduct.availableForSale) {
                    clientProduct.availableForSale = true;
                    migrationNeeded = true;
                }
            });
            
            if (migrationNeeded) {
                console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏');
                console.log('–¢–æ–≤–∞—Ä—ã –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:', window.clientProducts.filter(p => p.clientMB === window.currentUser?.clientMB));
                safeLocalStorage('set', 'clientProducts', window.clientProducts);
                showAlert('–î–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–æ–¥–æ–≤.', 'info');
            } else {
                console.log('–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–º–µ—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–¥—ã');
            }
        }

        function loadSalesHistory() {
            console.log('=== –ó–ê–ì–†–£–ó–ö–ê –ò–°–¢–û–†–ò–ò –ü–†–û–î–ê–ñ ===');
            const tableBody = document.getElementById('salesHistoryTableBody');
            if (!tableBody) {
                console.log('–¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–¥–∞–∂
            const salesHistory = safeLocalStorage('get', 'clientSalesHistory') || [];
            const clientMB = window.currentUser?.clientMB;
            console.log('–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂:', salesHistory.length);
            console.log('–¢–µ–∫—É—â–∏–π –∫–ª–∏–µ–Ω—Ç –ú–ë:', clientMB);
            
            const clientSales = salesHistory.filter(sale => sale.clientMB === clientMB);
            console.log('–ü—Ä–æ–¥–∞–∂–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:', clientSales.length);
            
            if (clientSales.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂ –ø—É—Å—Ç–∞</td></tr>';
                return;
            }
            
            tableBody.innerHTML = clientSales.map((sale, index) => {
                const saleDate = new Date(sale.date).toLocaleString('ru-RU');
                const totalQuantity = sale.items.reduce((sum, item) => sum + item.quantity, 0);
                const itemsText = sale.items.map(item => `${item.name} (${item.quantity} —à—Ç.)`).join(', ');
                
                return `
                    <tr>
                        <td>${saleDate}</td>
                        <td>${itemsText}</td>
                        <td>${totalQuantity} —à—Ç.</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteSale(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function processSale() {
            console.log('=== –ù–ê–ß–ê–õ–û –û–ë–†–ê–ë–û–¢–ö–ò –ü–†–û–î–ê–ñ–ò ===');
            const checkboxes = document.querySelectorAll('.sale-checkbox:checked');
            console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã:', checkboxes.length);
            
            if (checkboxes.length === 0) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏!', 'danger');
                return;
            }
            
            const saleItems = [];
            let hasErrors = false;
            
            checkboxes.forEach(checkbox => {
                const productCode = checkbox.dataset.productCode;
                
                // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ productCode –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
                if (!productCode || productCode === 'undefined') {
                    console.error('–û—à–∏–±–∫–∞: productCode –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞:', checkbox);
                    showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'danger');
                    hasErrors = true;
                    return;
                }
                
                const quantityInput = document.getElementById(`qty_${productCode}`);
                if (!quantityInput) {
                    console.error(`–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω input –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ ${productCode}`);
                    showAlert(`–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${productCode}!`, 'danger');
                    hasErrors = true;
                    return;
                }
                
                const quantity = parseInt(quantityInput.value);
                
                console.log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–∞: ${productCode}, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${quantity}`);
                
                if (!quantity || quantity <= 0) {
                    console.log(`–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${productCode}`);
                    showAlert(`–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${productCode}!`, 'danger');
                    hasErrors = true;
                    return;
                }
                
                // –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ (—Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–æ–¥—É –ò –ø–æ clientMB)
                console.log('–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –≤ window.clientProducts:', window.clientProducts?.length || 0, '—Ç–æ–≤–∞—Ä–æ–≤');
                const currentClientMB = window.currentUser?.clientMB;
                const clientProduct = window.clientProducts.find(p => p.internalCode === productCode && p.clientMB === currentClientMB);
                if (!clientProduct) {
                    console.log(`–û—à–∏–±–∫–∞: —Ç–æ–≤–∞—Ä ${productCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ clientProducts`);
                    console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞:', window.clientProducts.filter(p => p.clientMB === currentClientMB));
                    showAlert(`–¢–æ–≤–∞—Ä ${productCode} –Ω–µ –Ω–∞–π–¥–µ–Ω!`, 'danger');
                    hasErrors = true;
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                const availableQuantity = calculateAvailableQuantityForSale(clientProduct);
                if (quantity > availableQuantity) {
                    console.log(`–û—à–∏–±–∫–∞: –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ${quantity} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ ${availableQuantity} –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${productCode}`);
                    showAlert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞ ${clientProduct.code}! –î–æ—Å—Ç—É–ø–Ω–æ: ${availableQuantity} —à—Ç., –∑–∞–ø—Ä–æ—à–µ–Ω–æ: ${quantity} —à—Ç.`, 'danger');
                    hasErrors = true;
                    return;
                }
                
                console.log(`–ù–∞–π–¥–µ–Ω —Ç–æ–≤–∞—Ä: ${clientProduct.name}`);
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–∞–µ–º –ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                
                const totalWeight = quantity * clientProduct.weight;
                
                saleItems.push({
                    code: productCode,
                    name: clientProduct.name,
                    quantity: quantity,
                    weight: clientProduct.weight,
                    totalWeight: totalWeight,
                    warehouseLink: clientProduct.warehouseLink
                });
            });
            
            if (hasErrors) {
                console.log('–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–¥–∞–∂–∏ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫');
                return;
            }
            
            console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø—Ä–æ–¥–∞–∂–µ, —Ç–æ–≤–∞—Ä–æ–≤:', saleItems.length);
            console.log('–¢–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:', saleItems);
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø—Ä–æ–¥–∞–∂–µ
            const sale = {
                id: Date.now(),
                date: new Date().toISOString(),
                clientMB: window.currentUser?.clientMB,
                items: saleItems
            };
            
            console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–¥–∞–∂, –∫–ª–∏–µ–Ω—Ç –ú–ë:', sale.clientMB);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–¥–∞–∂
            let salesHistory = safeLocalStorage('get', 'clientSalesHistory') || [];
            salesHistory.push(sale);
            safeLocalStorage('set', 'clientSalesHistory', salesHistory);
            
            console.log('–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, –≤—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:', salesHistory.length);
            
            // –£–º–µ–Ω—å—à–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤...');
            updateWarehouseStock(saleItems);
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            clearSalesForm();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
            loadSalesProducts(); // –ü–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            loadSalesHistory();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫–ª–∞–¥ –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
            if (document.getElementById('warehouse') && document.getElementById('warehouse').classList.contains('active')) {
                renderProductGroups();
            }
            
            addLog(`–£—á—Ç–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∞: ${saleItems.length} —Ç–æ–≤–∞—Ä–æ–≤`);
            showAlert('–ü—Ä–æ–¥–∞–∂–∞ —É—Å–ø–µ—à–Ω–æ —É—á—Ç–µ–Ω–∞!', 'success');
            console.log('=== –ü–†–û–î–ê–ñ–ê –£–°–ü–ï–®–ù–û –û–ë–†–ê–ë–û–¢–ê–ù–ê ===');
        }

        function updateWarehouseStock(saleItems) {
            console.log('=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ö–õ–ê–î–°–ö–ò–• –û–°–¢–ê–¢–ö–û–í ===');
            console.log('–¢–æ–≤–∞—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', saleItems);
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω matiƒçni broj –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è ${clientMB} –∏–∑ localStorage:`, window.clientProductGroups[clientMB].length);
            }
            
            console.log(`–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è ${clientMB}:`, window.clientProductGroups[clientMB].length);
            
            saleItems.forEach(item => {
                console.log(`–ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø—ã –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.code} (warehouse link: ${item.warehouseLink})`);
                
                // –ù–∞—Ö–æ–¥–∏–º –≥—Ä—É–ø–ø—É —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–æ–¥—É —Ç–æ–≤–∞—Ä–∞
                const group = window.clientProductGroups[clientMB].find(group => 
                    group.products && group.products.some(p => p.product.internalCode === item.warehouseLink)
                );
                
                if (group) {
                    const oldQuantity = group.currentQuantity;
                    // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –≥—Ä—É–ø–ø–µ
                    group.currentQuantity = Math.max(0, group.currentQuantity - item.totalWeight);
                    console.log(`‚úÖ –£–º–µ–Ω—å—à–µ–Ω –æ—Å—Ç–∞—Ç–æ–∫ –≥—Ä—É–ø–ø—ã "${group.name}": ${oldQuantity}–≥ -> ${group.currentQuantity}–≥ (-${item.totalWeight}–≥)`);
                } else {
                    console.log(`‚ùå –ì—Ä—É–ø–ø–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${item.code} (warehouse link: ${item.warehouseLink}) –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            localStorage.setItem(`clientProductGroups_${clientMB}`, JSON.stringify(window.clientProductGroups[clientMB]));
            console.log(`‚úÖ –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è ${clientMB} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∂
            updateClientProductsMaxQuantity();
        }

        function updateClientProductsMaxQuantity() {
            console.log('=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–û–í–ê–†–û–í –ö–õ–ò–ï–ù–¢–ê (–ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô –ö–û–õ–ò–ß–ï–°–¢–í–ê) ===');
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            // –¢–µ–ø–µ—Ä—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
            
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
            }
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) return;
            
            // –ü—Ä–æ—Å—Ç–æ —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
            safeLocalStorage('set', 'clientProducts', window.clientProducts);
            console.log('‚úÖ –¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)');
        }

        function clearSalesForm() {
            // –°–Ω–∏–º–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
            document.querySelectorAll('.sale-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            document.querySelectorAll('.sale-quantity').forEach(input => {
                input.value = '';
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø—Ä–æ–¥–∞–∂
        function applySalesProductFilters(products) {
            const availabilityFilter = document.getElementById('salesAvailabilityFilter')?.value || 'available';
            const searchFilter = document.getElementById('salesSearchFilter')?.value.toLowerCase() || '';
            
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–æ–¥–∞–∂:', { availabilityFilter, searchFilter });
            
            return products.filter(product => {
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ
                const availableQuantity = calculateAvailableQuantityForSale(product);
                let passesAvailabilityFilter = true;
                
                if (availabilityFilter === 'available') {
                    passesAvailabilityFilter = availableQuantity > 0;
                } else if (availabilityFilter === 'unavailable') {
                    passesAvailabilityFilter = availableQuantity <= 0;
                }
                // –ï—Å–ª–∏ 'all' - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É
                const passesSearchFilter = searchFilter === '' || 
                    product.name.toLowerCase().includes(searchFilter) ||
                    product.code.toLowerCase().includes(searchFilter);
                
                console.log(`–¢–æ–≤–∞—Ä ${product.code}: available=${availableQuantity}, passesAvailability=${passesAvailabilityFilter}, passesSearch=${passesSearchFilter}`);
                
                return passesAvailabilityFilter && passesSearchFilter;
            });
        }

        function applySalesFilters() {
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂');
            loadSalesProducts();
        }

        function clearSalesFilters() {
            document.getElementById('salesAvailabilityFilter').value = 'available';
            document.getElementById('salesSearchFilter').value = '';
            loadSalesProducts();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏
        function createOrder() {
            console.log('=== –°–û–ó–î–ê–ù–ò–ï –ó–ê–ö–ê–ó–ê ===');
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                showAlert('–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω', 'danger');
                return;
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
            const selectedOrders = [];
            document.querySelectorAll('.order-checkbox:checked').forEach(checkbox => {
                const productCode = checkbox.dataset.productCode;
                const quantityInput = document.getElementById(`order_qty_${productCode}`);
                const quantity = parseInt(quantityInput.value);
                
                if (!quantity || quantity <= 0) {
                    showAlert(`–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ —Å –∫–æ–¥–æ–º ${productCode}`, 'danger');
                    return;
                }
                
                // –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä –≤ clientProducts
                const product = window.clientProducts.find(p => p.internalCode === productCode);
                if (product) {
                    const basePrice = product.price || 0; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
                    selectedOrders.push({
                        code: product.code,
                        name: product.name,
                        weight: product.weight,
                        quantity: quantity,
                        priceWithoutVAT: basePrice,
                        priceWithVAT: basePrice * 1.2,
                        totalWithoutVAT: basePrice * quantity,
                        totalWithVAT: basePrice * 1.2 * quantity,
                        internalCode: product.internalCode
                    });
                }
            });
            
            if (selectedOrders.length === 0) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'danger');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (–¥–∞—Ç–∞ + –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä)
            const today = new Date();
            const dateString = today.toISOString().split('T')[0].replace(/-/g, '');
            const orderNumber = generateOrderNumber(dateString);
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞
            const order = {
                id: Date.now(),
                number: orderNumber,
                clientMB: currentClientMB,
                date: today.toISOString(),
                items: selectedOrders,
                totalWithoutVAT: selectedOrders.reduce((sum, item) => sum + item.totalWithoutVAT, 0),
                totalWithVAT: selectedOrders.reduce((sum, item) => sum + item.totalWithVAT, 0),
                status: 'pending' // pending –∏–ª–∏ accepted
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑
            let orders = safeLocalStorage('get', 'clientOrders') || [];
            orders.push(order);
            safeLocalStorage('set', 'clientOrders', orders);
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            clearOrderForm();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤
            loadOrdersHistory();
            
            addLog(`–°–æ–∑–¥–∞–Ω –∑–∞–∫–∞–∑ ${orderNumber}: ${selectedOrders.length} —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—É–º–º—É ${order.totalWithVAT.toFixed(2)} –†–°–î`);
            showAlert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω!', 'success');
            
            console.log('=== –ó–ê–ö–ê–ó –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù ===', order);
        }

        function generateOrderNumber(dateString) {
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è
            const orders = safeLocalStorage('get', 'clientOrders') || [];
            const todayOrders = orders.filter(order => order.number.startsWith(dateString));
            const nextNumber = todayOrders.length + 1;
            return `${dateString}-${nextNumber.toString().padStart(3, '0')}`;
        }

        function clearOrderForm() {
            // –°–Ω–∏–º–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
            document.querySelectorAll('.order-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            document.querySelectorAll('.order-quantity').forEach(input => {
                input.value = '';
            });
        }

        function loadOrdersHistory() {
            const tableBody = document.getElementById('ordersHistoryTableBody');
            if (!tableBody) return;
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc3545;">–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</td></tr>';
                return;
            }
            
            const orders = safeLocalStorage('get', 'clientOrders') || [];
            const clientOrders = orders.filter(order => order.clientMB === currentClientMB);
            
            if (clientOrders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞</td></tr>';
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            clientOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tableBody.innerHTML = clientOrders.map(order => {
                const statusBadge = order.status === 'accepted' 
                    ? '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">–ü—Ä–∏–Ω—è—Ç</span>'
                    : '<span style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 12px; font-size: 12px;">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>';
                
                const itemsText = order.items.map(item => `${item.name} (${item.quantity} —à—Ç.)`).join(', ');
                
                return `
                    <tr>
                        <td>${order.number}</td>
                        <td>${new Date(order.date).toLocaleDateString('ru-RU')}</td>
                        <td title="${itemsText}">${itemsText.length > 50 ? itemsText.substring(0, 50) + '...' : itemsText}</td>
                        <td>${order.totalWithoutVAT.toFixed(2)} –†–°–î</td>
                        <td>${order.totalWithVAT.toFixed(2)} –†–°–î</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="exportOrderToPDF('${order.id}')" title="–°–∫–∞—á–∞—Ç—å PDF">
                                üìÑ PDF
                            </button>
                            ${order.status === 'pending' ? 
                                `<button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.id}')" title="–û—Ç–æ–∑–≤–∞—Ç—å –∑–∞–∫–∞–∑" style="margin-left: 5px;">
                                    ‚ùå –û—Ç–æ–∑–≤–∞—Ç—å
                                </button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function cancelOrder(orderId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            
            console.log('=== –û–¢–ó–´–í –ó–ê–ö–ê–ó–ê ===', orderId);
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                showAlert('–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω', 'danger');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã
            let allOrders = safeLocalStorage('get', 'clientOrders') || [];
            const orderIndex = allOrders.findIndex(order => order.id == orderId);
            
            if (orderIndex === -1) {
                showAlert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
                return;
            }
            
            const order = allOrders[orderIndex];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –∫–ª–∏–µ–Ω—Ç—É
            if (order.clientMB !== currentClientMB) {
                showAlert('–û—à–∏–±–∫–∞: –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–∫–∞–∑—ã', 'danger');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–∫–∞–∑ –µ—â–µ –Ω–µ –ø—Ä–∏–Ω—è—Ç
            if (order.status === 'accepted') {
                showAlert('–ù–µ–ª—å–∑—è –æ—Ç–æ–∑–≤–∞—Ç—å —É–∂–µ –ø—Ä–∏–Ω—è—Ç—ã–π –∑–∞–∫–∞–∑', 'danger');
                return;
            }
            
            // –£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑ –∏–∑ –º–∞—Å—Å–∏–≤–∞
            allOrders.splice(orderIndex, 1);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤
            safeLocalStorage('set', 'clientOrders', allOrders);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            loadOrdersHistory();
            
            // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            addLog(`–ö–ª–∏–µ–Ω—Ç –æ—Ç–æ–∑–≤–∞–ª –∑–∞–∫–∞–∑ ${order.number}`);
            showAlert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω', 'success');
            
            console.log('=== –ó–ê–ö–ê–ó –£–°–ü–ï–®–ù–û –û–¢–û–ó–í–ê–ù ===');
        }

        function exportOrderToPDF(orderId) {
            console.log('=== –≠–ö–°–ü–û–†–¢ –ó–ê–ö–ê–ó–ê –í PDF ===', orderId);
            
            // –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑ –ø–æ ID
            const orders = safeLocalStorage('get', 'clientOrders') || [];
            const order = orders.find(o => o.id == orderId);
            
            if (!order) {
                showAlert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
            const clients = safeLocalStorage('get', 'clients') || [];
            const client = clients.find(c => c.mb === order.clientMB);
            
            if (!client) {
                showAlert('–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'danger');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞
            const orderContent = generateOrderHTML(order, client);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Porud≈æbenica ${order.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                            font-size: 12px;
                            line-height: 1.4;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 20px;
                        }
                        .company-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 30px;
                        }
                        .company-box {
                            width: 45%;
                            border: 1px solid #ccc;
                            padding: 15px;
                        }
                        .order-details {
                            margin-bottom: 30px;
                            text-align: right;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th, td {
                            border: 1px solid #333;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background-color: #f5f5f5;
                            font-weight: bold;
                        }
                        .totals {
                            margin-top: 20px;
                            border-top: 2px solid #333;
                            padding-top: 10px;
                        }
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            margin: 5px 0;
                        }
                        .final-total {
                            font-weight: bold;
                            font-size: 14px;
                            border-top: 1px solid #333;
                            padding-top: 10px;
                            margin-top: 10px;
                        }
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${orderContent}
                </body>
                </html>
            `;
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(fullHTML);
                printWindow.document.close();
                
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—á–∞—Ç—å
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 1000);
                    }, 500);
                };
            } else {
                // Fallback - —Å–∫–∞—á–∏–≤–∞–µ–º –∫–∞–∫ HTML —Ñ–∞–π–ª
                const blob = new Blob([fullHTML], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Porudzbenica_${order.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            showAlert('Porud≈æbenica –≥–æ—Ç–æ–≤–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'success');
        }

        function generateOrderHTML(order, client) {
            const formatDate = (dateStr) => {
                return new Date(dateStr).toLocaleDateString('sr-RS');
            };
            
            const itemsHTML = order.items.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.weight}–≥</td>
                    <td style="text-align: right;">${item.quantity}</td>
                    <td style="text-align: right;">${item.priceWithoutVAT.toFixed(2)} –†–°–î</td>
                    <td style="text-align: right;">${item.totalWithoutVAT.toFixed(2)} –†–°–î</td>
                </tr>
            `).join('');
            
            return `
                <div class="header">
                    <h1>PORUD≈ΩBENICA</h1>
                    <h2>–ë—Ä–æ—ò: ${order.number}</h2>
                </div>
                
                <div class="company-info">
                    <div class="company-box">
                        <h3>–ò–ó–î–ê–í–ê–õ–ê–¶:</h3>
                        <strong>–°—Ä–µƒß–∞ 2024 –î–û–û</strong><br>
                        –ë–µ–æ–≥—Ä–∞–¥, –°—Ç–∞—Ä–∏ –ì—Ä–∞–¥<br>
                        –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35<br>
                        –ú–ë: 22019309<br>
                        –ü–ò–ë: 114407658
                    </div>
                    
                    <div class="company-box">
                        <h3>–ö–£–ü–ê–¶:</h3>
                        <strong>${client.name}</strong><br>
                        ${client.legalName || ''}<br>
                        ${client.address || ''}<br>
                        –ú–ë: ${client.mb || ''}<br>
                        –ü–ò–ë: ${client.pib || ''}
                    </div>
                </div>
                
                <div class="order-details">
                    <strong>–î–∞—Ç—É–º –∏–∑–¥–∞–≤–∞—ö–∞: ${formatDate(order.date)}</strong><br>
                    <strong>–°—Ç–∞—Ç—É—Å: ${order.status === 'accepted' ? '–ü—Ä–∏—Ö–≤–∞—õ–µ–Ω' : '–ù–∞ —á–µ–∫–∞—ö—É'}</strong>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th style="width: 5%;">–ë—Ä.</th>
                            <th style="width: 15%;">–®–∏—Ñ—Ä–∞</th>
                            <th style="width: 35%;">–ù–∞–∑–∏–≤ —Ä–æ–±–µ</th>
                            <th style="width: 10%;">–¢–µ–∂–∏–Ω–∞</th>
                            <th style="width: 10%;">–ö–æ–ª–∏—á–∏–Ω–∞</th>
                            <th style="width: 12%;">–¶–µ–Ω–∞</th>
                            <th style="width: 13%;">–£–∫—É–ø–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHTML}
                    </tbody>
                </table>
                
                <div class="totals">
                    <div class="total-row">
                        <span>–£–∫—É–ø–Ω–æ –±–µ–∑ –ü–î–í:</span>
                        <span>${order.totalWithoutVAT.toFixed(2)} –†–°–î</span>
                    </div>
                    <div class="total-row">
                        <span>–ü–î–í (20%):</span>
                        <span>${(order.totalWithVAT - order.totalWithoutVAT).toFixed(2)} –†–°–î</span>
                    </div>
                    <div class="total-row final-total">
                        <span>–£–ö–£–ü–ù–û –ó–ê –ù–ê–ü–õ–ê–¢–£:</span>
                        <span>${order.totalWithVAT.toFixed(2)} –†–°–î</span>
                    </div>
                </div>
                
                <div style="margin-top: 40px; text-align: center; font-style: italic;">
                    <p>–û–≤–∞ –ø–æ—Ä—É—ü–±–µ–Ω–∏—Ü–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤—ô–∞ –∑–∞—Ö—Ç–µ–≤ –∑–∞ –∏—Å–ø–æ—Ä—É–∫—É –Ω–∞–≤–µ–¥–µ–Ω–µ —Ä–æ–±–µ.</p>
                    <p>–î–æ–∫—É–º–µ–Ω–∞—Ç —ò–µ –≥–µ–Ω–µ—Ä–∏—Å–∞–Ω –∞—É—Ç–æ–º–∞—Ç—Å–∫–∏ ${new Date().toLocaleDateString('sr-RS')} —É ${new Date().toLocaleTimeString('sr-RS')}.</p>
                </div>
            `;
        }

        function deleteSale(index) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –ø—Ä–æ–¥–∞–∂–µ?')) return;
            
            let salesHistory = JSON.parse(localStorage.getItem('clientSalesHistory') || '[]');
            const clientMB = window.currentUser?.clientMB;
            const clientSales = salesHistory.filter(sale => sale.clientMB === clientMB);
            
            if (index >= 0 && index < clientSales.length) {
                const saleToDelete = clientSales[index];
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ –æ–±—â–µ–≥–æ –º–∞—Å—Å–∏–≤–∞
                salesHistory = salesHistory.filter(sale => sale.id !== saleToDelete.id);
                localStorage.setItem('clientSalesHistory', JSON.stringify(salesHistory));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                loadSalesHistory();
                
                addLog(`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –æ –ø—Ä–æ–¥–∞–∂–µ –æ—Ç ${new Date(saleToDelete.date).toLocaleString('ru-RU')}`);
                showAlert('–ó–∞–ø–∏—Å—å –æ –ø—Ä–æ–¥–∞–∂–µ —É–¥–∞–ª–µ–Ω–∞!', 'success');
            }
        }



        function findWarehouseProductByCode(internalCode) {
            console.log('–ò—â–µ–º —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥–µ –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–æ–¥—É:', internalCode);
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω matiƒçni broj –∫–ª–∏–µ–Ω—Ç–∞');
                return null;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            
            // –ò—â–µ–º —Ç–æ–≤–∞—Ä –≤ –≥—Ä—É–ø–ø–∞—Ö –Ω–∞ —Å–∫–ª–∞–¥–µ
            if (window.clientProductGroups[clientMB] && window.clientProductGroups[clientMB].length > 0) {
                for (const group of window.clientProductGroups[clientMB]) {
                    if (group.products && group.products.length > 0) {
                        for (const productInGroup of group.products) {
                            if (productInGroup.product && productInGroup.product.internalCode === internalCode) {
                                const foundProduct = {
                                    ...productInGroup.product,
                                    availableQuantity: group.currentQuantity,
                                    groupName: group.name,
                                    groupId: group.id || group.name // –¥–ª—è —Å–≤—è–∑–∏ —Å –≥—Ä—É–ø–ø–æ–π
                                };
                                console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥–µ:', foundProduct);
                                return foundProduct;
                            }
                        }
                    }
                }
            }
            
            console.log('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ');
            return null;
        }



        function renderClientProductsTable() {
            console.log('=== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–í–ê–†–û–í –ö–õ–ò–ï–ù–¢–ê (–¢–û–õ–¨–ö–û clientProducts) ===');
            
            const tbody = document.getElementById('clientProductsTableBody');
            if (!tbody) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç clientProductsTableBody –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            const currentClientMB = window.currentUser?.clientMB;
            console.log('–¢–µ–∫—É—â–∏–π –∫–ª–∏–µ–Ω—Ç –ú–ë:', currentClientMB);
            
            if (!currentClientMB) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545; padding: 40px;">–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</td></tr>';
                return;
            }
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û clientProducts, –ù–ï window.products
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ localStorage:', window.clientProducts);
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            const currentClientProducts = window.clientProducts.filter(product => 
                product.clientMB === currentClientMB
            );
            
            console.log(`–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ${currentClientMB}:`, currentClientProducts.length);
            console.log('–¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞:', currentClientProducts);
            
            if (currentClientProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                            <div style="font-size: 16px; margin-bottom: 10px;">üì¶ –¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                            <div style="font-size: 14px;">–¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∏–Ω–≤–æ–π—Å–æ–≤</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¢–û–õ–¨–ö–û —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞
            tbody.innerHTML = currentClientProducts.map((product, index) => {
                const createdDate = product.createdAt ? 
                    new Date(product.createdAt).toLocaleDateString('ru-RU') : 
                    new Date().toLocaleDateString('ru-RU');
                
                const statusText = product.warehouseProduct ? '–ü—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–∫–ª–∞–¥—É' : '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
                const statusColor = product.warehouseProduct ? '#28a745' : '#ffc107';
                
                return `
                    <tr>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.weight}${typeof product.weight === 'number' ? '–≥' : ''}</td>
                        <td>
                            <span class="status-badge" style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${statusText}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editClientProduct('${product.code}', ${index})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                ‚úèÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–¢–û–õ–¨–ö–û clientProducts)');
        }
        
        function editClientProduct(productCode, productIndex) {
            console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞:', productCode);
            
            const currentClientMB = window.currentUser?.clientMB;
            if (!currentClientMB) {
                showAlert('–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω', 'danger');
                return;
            }
            
            // –ù–∞–π–¥–µ–º —Ç–æ–≤–∞—Ä —Å—Ä–µ–¥–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            const currentClientProducts = window.clientProducts.filter(p => p.clientMB === currentClientMB);
            const product = currentClientProducts[productIndex];
            
            if (!product) {
                showAlert('–¢–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
                return;
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            const modal = document.getElementById('editClientProductModal');
            if (modal) {
                modal.style.display = 'block';
                document.getElementById('editClientProductCode').value = product.code;
                document.getElementById('editClientProductName').value = product.name;
                document.getElementById('editClientProductWeight').value = product.weight;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                window.editingClientProduct = {
                    originalCode: product.code,
                    clientMB: currentClientMB,
                    productIndex: productIndex
                };
            } else {
                console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ editClientProductModal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                showAlert('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'danger');
            }
        }







        function loadIncomingDocuments() {
            if (!window.currentUser || window.currentUser.userType !== 'client') return;
            
            const clientMB = window.currentUser.clientMB;
            const client = clients.find(c => c.mb === clientMB);
            if (!client) return;
            
            console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', clientMB);
            console.log('–í—Å–µ–≥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤:', window.confirmedInvoices?.length || 0);
            console.log('–í—Å–µ–≥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü:', window.confirmedDeliveries?.length || 0);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
            const allInvoices = window.confirmedInvoices || JSON.parse(localStorage.getItem('confirmedInvoices') || '[]');
            const allDeliveries = window.confirmedDeliveries || JSON.parse(localStorage.getItem('confirmedDeliveries') || '[]');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            const clientInvoices = allInvoices.filter(invoice => 
                invoice.client && invoice.client.mb === clientMB && invoice.status === 'confirmed'
            );
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            const clientDeliveries = allDeliveries.filter(delivery => 
                delivery.client && delivery.client.mb === clientMB && delivery.status === 'confirmed'
            );
            
            console.log('–ò–Ω–≤–æ–π—Å—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', clientInvoices);
            console.log('–û—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', clientDeliveries);
            
            renderIncomingInvoices(clientInvoices);
            renderIncomingDeliveries(clientDeliveries);
        }

        function renderIncomingInvoices(invoices) {
            const container = document.getElementById('incomingInvoicesList');
            if (!container) return;
            
            if (invoices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        –ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∏–Ω–≤–æ–π—Å–æ–≤
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>–ù–æ–º–µ—Ä</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoices.map(invoice => `
                            <tr>
                                <td>${invoice.number}</td>
                                <td>${invoice.date}</td>
                                <td>${invoice.total} RSD</td>
                                <td>
                                    <span class="status-badge ${getDocumentStatusClass(invoice.clientStatus)}">
                                        ${getDocumentStatusText(invoice.clientStatus)}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        ${!invoice.clientStatus ? `
                                            <button class="btn btn-success btn-sm" onclick="acceptDocument('invoice', '${invoice.number}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                                            <button class="btn btn-danger btn-sm" onclick="rejectDocument('invoice', '${invoice.number}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                        ` : ''}
                                        <button class="btn btn-info btn-sm" onclick="exportDocumentPDF('invoice', '${invoice.number}')">PDF</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function renderIncomingDeliveries(deliveries) {
            const container = document.getElementById('incomingDeliveriesList');
            if (!container) return;
            
            if (deliveries.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        –ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>–ù–æ–º–µ—Ä</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–¢–æ–≤–∞—Ä—ã</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${deliveries.map(delivery => `
                            <tr>
                                <td>${delivery.number}</td>
                                <td>${delivery.date}</td>
                                <td>${delivery.items.length} —Ç–æ–≤–∞—Ä(–æ–≤)</td>
                                <td>
                                    <span class="status-badge ${getDocumentStatusClass(delivery.clientStatus)}">
                                        ${getDocumentStatusText(delivery.clientStatus)}
                                    </span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        ${!delivery.clientStatus ? `
                                            <button class="btn btn-success btn-sm" onclick="acceptDocument('delivery', '${delivery.number}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                                            <button class="btn btn-danger btn-sm" onclick="rejectDocument('delivery', '${delivery.number}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                        ` : ''}
                                        <button class="btn btn-info btn-sm" onclick="exportDocumentPDF('delivery', '${delivery.number}')">PDF</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        function getDocumentStatusClass(status) {
            switch(status) {
                case 'accepted': return 'status-accepted';
                case 'rejected': return 'status-rejected';
                default: return 'status-pending';
            }
        }

        function getDocumentStatusText(status) {
            switch(status) {
                case 'accepted': return '–ü—Ä–∏–Ω—è—Ç';
                case 'rejected': return '–û—Ç–∫–ª–æ–Ω–µ–Ω';
                default: return '–û–∂–∏–¥–∞–µ—Ç';
            }
        }

        function acceptDocument(type, number) {
            console.log('=== –ü–†–ò–ù–Ø–¢–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê ===');
            console.log('–¢–∏–ø:', type, '–ù–æ–º–µ—Ä:', number);
            console.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', window.currentUser);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
            const allInvoices = window.confirmedInvoices || JSON.parse(localStorage.getItem('confirmedInvoices') || '[]');
            const allDeliveries = window.confirmedDeliveries || JSON.parse(localStorage.getItem('confirmedDeliveries') || '[]');
            
            const documents = type === 'invoice' ? allInvoices : allDeliveries;
            const targetDocument = documents.find(doc => doc.number === number);
            
            console.log('–ù–∞–π–¥–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç:', targetDocument);
            
            if (!targetDocument) {
                console.error('–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                showAlert('–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç —É–∂–µ –ø—Ä–∏–Ω—è—Ç
            if (targetDocument.clientStatus === 'accepted') {
                console.log('–î–æ–∫—É–º–µ–Ω—Ç —É–∂–µ –ø—Ä–∏–Ω—è—Ç');
                showAlert('–î–æ–∫—É–º–µ–Ω—Ç —É–∂–µ –ø—Ä–∏–Ω—è—Ç!', 'info');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const acceptButton = document.querySelector(`button[onclick="acceptDocument('${type}', '${number}')"]`);
            if (acceptButton) {
                acceptButton.disabled = true;
                acceptButton.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞
            targetDocument.clientStatus = 'accepted';
            console.log('–°—Ç–∞—Ç—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ accepted');
            
            // –î–ª—è –∏–Ω–≤–æ–π—Å–æ–≤ —Å–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ –∫–ª–∏–µ–Ω—Ç–∞
            if (type === 'invoice') {
                console.log('–°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∏–Ω–≤–æ–π—Å–∞...');
                createWarehouseGroupsFromInvoice(targetDocument);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (type === 'invoice') {
                safeLocalStorage('set', 'confirmedInvoices', allInvoices);
                window.confirmedInvoices = allInvoices;
            } else {
                localStorage.setItem('confirmedDeliveries', JSON.stringify(allDeliveries));
                window.confirmedDeliveries = allDeliveries;
            }
            
            addLog(`–ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—è–ª ${type === 'invoice' ? '–∏–Ω–≤–æ–π—Å' : '–æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É'} ${number}`);
            showAlert('–î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏–Ω—è—Ç!', 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            loadIncomingDocuments();
            
            console.log('=== –ü–†–ò–ù–Ø–¢–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê –ó–ê–í–ï–†–®–ï–ù–û ===');
        }

        function rejectDocument(type, number) {
            const documents = type === 'invoice' ? confirmedInvoices : confirmedDeliveries;
            const document = documents.find(doc => doc.number === number);
            
            if (!document) {
                showAlert('–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞
            document.clientStatus = 'rejected';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            if (type === 'invoice') {
                safeLocalStorage('set', 'confirmedInvoices', confirmedInvoices);
            } else {
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
            }
            
            addLog(`–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–∏–ª ${type === 'invoice' ? '–∏–Ω–≤–æ–π—Å' : '–æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É'} ${number}`);
            showAlert('–î–æ–∫—É–º–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω!', 'info');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            loadIncomingDocuments();
        }

        function createWarehouseGroupsFromInvoice(invoice) {
            console.log('=== –°–û–ó–î–ê–ù–ò–ï –ì–†–£–ü–ü –¢–û–í–ê–†–û–í –ò–ó –ò–ù–í–û–ô–°–ê ===');
            console.log('–ò–Ω–≤–æ–π—Å:', invoice);
            console.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', window.currentUser);
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω matiƒçni broj –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[clientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è ${clientMB} –∏–∑ localStorage:`, window.clientProductGroups[clientMB]);
            } else {
                console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è ${clientMB}:`, window.clientProductGroups[clientMB]);
            }
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –∏–∑ –∏–Ω–≤–æ–π—Å–∞
            invoice.items.forEach(item => {
                const product = item.product;
                const productCode = product.code;
                
                // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≥—Ä—É–ø–ø—É —Å —Ç–∞–∫–∏–º –∂–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫–æ–¥–æ–º —Ç–æ–≤–∞—Ä–∞
                let existingGroup = window.clientProductGroups[clientMB].find(group => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ –≥—Ä—É–ø–ø–µ —Ç–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º –∂–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫–æ–¥–æ–º
                    return group.products && group.products.some(p => p.product.internalCode === product.internalCode);
                });
                
                const totalQuantity = item.quantity * (product.weight || 1);
                
                console.log(`üì¶ –†–ê–°–ß–ï–¢ –°–ö–õ–ê–î–ê: ${product.name}`);
                console.log(`   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity} —à—Ç.`);
                console.log(`   - –í–µ—Å –µ–¥–∏–Ω–∏—Ü—ã: ${product.weight || 1}–≥`);
                console.log(`   - –û–ë–©–ò–ô –í–ï–°: ${item.quantity} √ó ${product.weight || 1} = ${totalQuantity}–≥`);
                
                if (existingGroup) {
                    // –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å—É–º–º–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                    existingGroup.originalQuantity += totalQuantity;
                    existingGroup.currentQuantity += totalQuantity;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω—é—é
                    if (new Date(invoice.date) > new Date(existingGroup.shipmentDate)) {
                        existingGroup.shipmentDate = invoice.date;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å—Ç–∞–≤–∫–µ
                    const existingProduct = existingGroup.products.find(p => p.product.internalCode === product.internalCode);
                    if (existingProduct) {
                        existingProduct.quantity += item.quantity;
                    } else {
                        existingGroup.products.push({
                            product: product,
                            quantity: item.quantity
                        });
                    }
                    
                    console.log(`‚úÖ –¢–æ–≤–∞—Ä ${product.name} (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥: ${product.internalCode}) –¥–æ–±–∞–≤–ª–µ–Ω –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –≥—Ä—É–ø–ø–µ. –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${existingGroup.currentQuantity}–≥`);
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
                    const newGroup = {
                        name: `${product.name} (–∫–æ–¥: ${productCode})`,
                        quantityType: product.weight > 0 ? 'weight' : 'units',
                        originalQuantity: totalQuantity,
                        currentQuantity: totalQuantity,
                        shipmentDate: invoice.date,
                        reservationType: 'units',
                        reservationAmount: 0,
                        products: [{
                            product: product,
                            quantity: item.quantity
                        }]
                    };
                    
                    window.clientProductGroups[clientMB].push(newGroup);
                    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${product.name} (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥: ${product.internalCode}) —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º: ${totalQuantity}–≥`);
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            localStorage.setItem(`clientProductGroups_${clientMB}`, JSON.stringify(window.clientProductGroups[clientMB]));
            console.log(`–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è ${clientMB} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage`);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π
            console.log('–í—ã–∑—ã–≤–∞–µ–º autoCreateClientProducts...');
            autoCreateClientProducts(invoice);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
            if (document.getElementById('warehouse') && document.getElementById('warehouse').classList.contains('active')) {
                renderProductGroups();
            }
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–¥–∞–∂–∏ (—Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å)
            console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∂ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–∫–ª–∞–¥...');
            if (document.getElementById('clientSales')) {
                loadSalesProducts();
            }
            
            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è ${clientMB}:`, window.clientProductGroups[clientMB]);
        }

        function autoCreateClientProducts(invoice) {
            console.log('=== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–û–ó–î–ê–ù–ò–ï –¢–û–í–ê–†–û–í –ö–õ–ò–ï–ù–¢–ê ===');
            console.log('–ò–Ω–≤–æ–π—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:', invoice);
            
            const clientMB = window.currentUser?.clientMB;
            console.log('–ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò –∫–ª–∏–µ–Ω—Ç–∞:', clientMB);
            
            if (!clientMB) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω –º–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò –∫–ª–∏–µ–Ω—Ç–∞ - —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–≤–∞–Ω–∞ –Ω–µ –∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞');
                return;
            }
            
            // –í–ê–ñ–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ localStorage:', window.clientProducts);
            }
            
            console.log('–¢–µ–∫—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:', window.clientProducts);
            console.log('–¢–æ–≤–∞—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:', window.clientProducts.filter(p => p.clientMB === clientMB));
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –∏–∑ –∏–Ω–≤–æ–π—Å–∞
            invoice.items.forEach((item, index) => {
                console.log(`\n--- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä ${index + 1} ---`);
                const product = item.product;
                const productCode = product.code;
                const productInternalCode = product.internalCode;
                
                console.log(`–¢–æ–≤–∞—Ä –∏–∑ –∏–Ω–≤–æ–π—Å–∞: ${product.name}, –∫–æ–¥: ${productCode}, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥: ${productInternalCode}`);
                
                // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫–æ–¥–∞ –∏ –≤—ã–¥–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!productInternalCode) {
                    console.warn(`–í–ù–ò–ú–ê–ù–ò–ï: –£ —Ç–æ–≤–∞—Ä–∞ ${productCode} –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–≤–∞—Ä, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–æ–¥–æ–≤.`);
                    console.warn('–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Ç–æ–≤–∞—Ä, –¥–æ–±–∞–≤–∏–≤ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥.');
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–≤–∞—Ä—ã –±–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫–æ–¥–∞
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º
                const existingClientProduct = window.clientProducts.find(clientProduct => 
                    clientProduct.clientMB === clientMB && clientProduct.code === productCode
                );
                
                console.log('–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ —Å —Ç–∞–∫–∏–º warehouseLink:', existingClientProduct);
                
                if (!existingClientProduct) {
                    console.log('–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞...');
                    
                    // –®–ê–ì 1: –°–æ–∑–¥–∞–µ–º —Ç–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏–Ω–≤–æ–π—Å–∞
                    console.log('--- –®–ê–ì 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–≤–æ–π—Å–∞ ---');
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Å/–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    const isWeightBased = product.weight && product.weight > 0;
                    const defaultWeight = isWeightBased ? product.weight : 1; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–µ—Å —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ 1 –µ–¥–∏–Ω–∏—Ü–∞
                    
                    console.log(`–¢–æ–≤–∞—Ä –∏–∑ –∏–Ω–≤–æ–π—Å–∞ - –Ω–∞–∑–≤–∞–Ω–∏–µ: ${product.name}, –∫–æ–¥: ${productCode}, –≤–µ—Å: ${product.weight}`);
                    console.log(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–∏–ø: ${isWeightBased ? '–≤–µ—Å–æ–≤–æ–π' : '—à—Ç—É—á–Ω—ã–π'}, –≤–µ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${defaultWeight}`);
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
                    const clientProductName = product.name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–µ–∑ –¥–æ–±–∞–≤–æ–∫
                    console.log('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞:', clientProductName);
                    
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∏–Ω–≤–æ–π—Å–∞, –∫–∞–∫ –≤ –∏–Ω–≤–æ–π—Å–µ
                    console.log('–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞–∫ –≤ –∏–Ω–≤–æ–π—Å–µ):', productCode);
                    
                    // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π —Ç–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ–∫–∞ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å–∫–ª–∞–¥—É)
                    const newClientProduct = {
                        code: productCode, // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ –∏–Ω–≤–æ–π—Å–∞
                        internalCode: productInternalCode, // –î–æ–±–∞–≤–ª—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                        name: clientProductName,
                        weight: defaultWeight,
                        price: product.price || 100, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∏–Ω–≤–æ–π—Å–∞
                        warehouseLink: productInternalCode, // –°–≤—è–∑—å —Å —Ç–æ–≤–∞—Ä–æ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–æ–¥—É
                        warehouseProduct: null, // –ü–æ–∫–∞ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏
                        createdAt: new Date().toISOString(),
                        clientMB: clientMB,
                        autoCreated: true,
                        type: 'clientProduct', // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è –ø—Ä–æ–¥–∞–∂
                        availableForSale: true,
                        maxQuantity: 0 // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å–∫–ª–∞–¥—É
                    };
                    
                    console.log('–ë–∞–∑–æ–≤—ã–π —Ç–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω:', newClientProduct);
                    
                    // –®–ê–ì 2: –ò—â–µ–º –∏ —Å–≤—è–∑—ã–≤–∞–µ–º —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –≥—Ä—É–ø–ø–æ–π –Ω–∞ —Å–∫–ª–∞–¥–µ
                    console.log('--- –®–ê–ì 2: –ü–æ–∏—Å–∫ –∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ —Å –≥—Ä—É–ø–ø–æ–π –Ω–∞ —Å–∫–ª–∞–¥–µ ---');
                    console.log('–ò—â–µ–º –≥—Ä—É–ø–ø—É —Å —Ç–æ–≤–∞—Ä–æ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–¥:', productInternalCode);
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
                    if (!window.clientProductGroups) {
                        window.clientProductGroups = {};
                    }
                    
                    if (!window.clientProductGroups[clientMB]) {
                        const savedGroups = localStorage.getItem(`clientProductGroups_${clientMB}`);
                        window.clientProductGroups[clientMB] = savedGroups ? JSON.parse(savedGroups) : [];
                        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –¥–ª—è ${clientMB} –∏–∑ localStorage:`, window.clientProductGroups[clientMB]);
                    }
                    
                    console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã –∫–ª–∏–µ–Ω—Ç–∞:', window.clientProductGroups[clientMB]);
                    
                    if (window.clientProductGroups[clientMB] && window.clientProductGroups[clientMB].length > 0) {
                        const matchingGroup = window.clientProductGroups[clientMB].find(group => 
                            group.products && group.products.some(p => p.product.internalCode === productInternalCode)
                        );
                        
                        console.log('–ù–∞–π–¥–µ–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ:', matchingGroup);
                        
                        if (matchingGroup) {
                            const productInGroup = matchingGroup.products.find(p => p.product.internalCode === productInternalCode);
                            console.log('–¢–æ–≤–∞—Ä –≤ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ:', productInGroup);
                            
                            if (productInGroup) {
                                // –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–≤—è–∑–∫—É –∫ —Å–∫–ª–∞–¥—É
                                const warehouseProduct = {
                                    ...productInGroup.product,
                                    availableQuantity: matchingGroup.currentQuantity,
                                    groupName: matchingGroup.name,
                                    groupId: matchingGroup.id || matchingGroup.name
                                };
                                
                                // –°–≤—è–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ —Å –≥—Ä—É–ø–ø–æ–π –Ω–∞ —Å–∫–ª–∞–¥–µ
                                newClientProduct.warehouseProduct = warehouseProduct;
                                
                                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                                // –¢–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
                                
                                console.log('‚úÖ –¢–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–≤—è–∑–∞–Ω —Å –≥—Ä—É–ø–ø–æ–π –Ω–∞ —Å–∫–ª–∞–¥–µ:', warehouseProduct);
                                console.log('‚úÖ –¢–æ–≤–∞—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π');
                            } else {
                                console.log('‚ö†Ô∏è –¢–æ–≤–∞—Ä –Ω–∞–π–¥–µ–Ω –≤ –≥—Ä—É–ø–ø–µ, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ');
                            }
                        } else {
                            console.log('‚ö†Ô∏è –ì—Ä—É–ø–ø–∞ —Å —Ç–æ–≤–∞—Ä–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ –∫–ª–∏–µ–Ω—Ç–∞');
                        }
                    } else {
                        console.log('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–ø–ø –Ω–∞ —Å–∫–ª–∞–¥–µ –∫–ª–∏–µ–Ω—Ç–∞');
                    }
                    
                    // –®–ê–ì 3: –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
                    console.log('--- –®–ê–ì 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞ ---');
                    window.clientProducts.push(newClientProduct);
                    
                    const linkStatus = newClientProduct.warehouseProduct ? '—Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å–∫–ª–∞–¥—É' : '–±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å–∫–ª–∞–¥—É';
                    console.log(`‚úÖ –¢–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω ${linkStatus}: ${clientProductName} (–∫–æ–¥: ${newClientProduct.code})`);
                } else {
                    console.log(`‚ÑπÔ∏è –¢–æ–≤–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Å–∫–ª–∞–¥–∞ ${productCode} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${existingClientProduct.name}`);
                }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∫–ª—é—á–µ localStorage
            console.log('\n--- –§–ò–ù–ê–õ–¨–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï ---');
            console.log('–¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', window.clientProducts);
            safeLocalStorage('set', 'clientProducts', window.clientProducts);
            console.log('‚úÖ –¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage –ø–æ–¥ –∫–ª—é—á–æ–º "clientProducts"');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å
            const savedCheck = localStorage.getItem('clientProducts');
            const parsedCheck = JSON.parse(savedCheck || '[]');
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ localStorage:', parsedCheck.length);
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
            const currentClientProducts = window.clientProducts.filter(p => p.clientMB === clientMB);
            const linkedProducts = currentClientProducts.filter(p => p.warehouseProduct);
            const unlinkedProducts = currentClientProducts.filter(p => !p.warehouseProduct);
            
            console.log('\n--- –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê ---');
            console.log(`üìä –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ —É –∫–ª–∏–µ–Ω—Ç–∞ ${clientMB}: ${currentClientProducts.length}`);
            console.log(`üîó –¢–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å–∫–ª–∞–¥—É: ${linkedProducts.length}`);
            console.log(`‚ö†Ô∏è –¢–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å–∫–ª–∞–¥—É: ${unlinkedProducts.length}`);
            
            if (linkedProducts.length > 0) {
                console.log('‚úÖ –¢–æ–≤–∞—Ä—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π:', linkedProducts.map(p => `${p.name} ‚Üí ${p.warehouseProduct.groupName}`));
            }
            if (unlinkedProducts.length > 0) {
                console.log('‚ö†Ô∏è –¢–æ–≤–∞—Ä—ã –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏:', unlinkedProducts.map(p => p.name));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
            if (document.getElementById('clientProducts') && document.getElementById('clientProducts').classList.contains('active')) {
                console.log('\n--- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ---');
                console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞...');
                renderClientProductsTable();
            }
            
            console.log('\nüéâ === –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–û–ó–î–ê–ù–ò–ï –¢–û–í–ê–†–û–í –ö–õ–ò–ï–ù–¢–ê –ó–ê–í–ï–†–®–ï–ù–û ===');
        }

        function testAutoProductCreation() {
            console.log('=== –¢–ï–°–¢ –ê–í–¢–û–°–û–ó–î–ê–ù–ò–Ø –¢–û–í–ê–†–û–í ===');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            console.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', window.currentUser);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã
            if (!window.clientProductGroups) {
                window.clientProductGroups = JSON.parse(localStorage.getItem('clientProductGroups') || '[]');
            }
            console.log('–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã:', window.clientProductGroups);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞
            if (!window.clientProducts) {
                window.clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            }
            console.log('–¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞:', window.clientProducts);
            
            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∏–Ω–≤–æ–π—Å
            const testInvoice = {
                number: 'TEST-001',
                date: new Date().toISOString().split('T')[0],
                items: [
                    {
                        product: {
                            code: 'TEA001',
                            name: '–ó–µ–ª–µ–Ω—ã–π —á–∞–π –ø—Ä–µ–º–∏—É–º',
                            weight: 10
                        },
                        quantity: 5
                    }
                ]
            };
            
            console.log('–¢–µ—Å—Ç–æ–≤—ã–π –∏–Ω–≤–æ–π—Å:', testInvoice);
            
            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è
            autoCreateClientProducts(testInvoice);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            renderClientProductsTable();
            
            showAlert('–¢–µ—Å—Ç –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.', 'info');
        }

        function debugSalesProducts() {
            console.log('=== –û–¢–õ–ê–î–ö–ê –¢–û–í–ê–†–û–í –î–õ–Ø –ü–†–û–î–ê–ñ ===');
            
            const currentClientMB = window.currentUser?.clientMB;
            console.log('–¢–µ–∫—É—â–∏–π –∫–ª–∏–µ–Ω—Ç –ú–ë:', currentClientMB);
            
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
            }
            
            const allClientProducts = window.clientProducts.filter(p => p.clientMB === currentClientMB);
            console.log('–í—Å–µ —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞:', allClientProducts);
            
            const availableForSale = allClientProducts.filter(p => p.availableForSale);
            console.log('–¢–æ–≤–∞—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏:', availableForSale);
            
            const withInternalCode = availableForSale.filter(p => p.internalCode);
            console.log('–¢–æ–≤–∞—Ä—ã —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫–æ–¥–æ–º:', withInternalCode);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫–ª–∞–¥—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã
            if (!window.clientProductGroups) {
                window.clientProductGroups = {};
            }
            
            if (!window.clientProductGroups[currentClientMB]) {
                const savedGroups = localStorage.getItem(`clientProductGroups_${currentClientMB}`);
                window.clientProductGroups[currentClientMB] = savedGroups ? JSON.parse(savedGroups) : [];
            }
            
            console.log('–°–∫–ª–∞–¥—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã –∫–ª–∏–µ–Ω—Ç–∞:', window.clientProductGroups[currentClientMB]);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            withInternalCode.forEach(product => {
                const availableQuantity = calculateAvailableQuantityForSale(product);
                console.log(`${product.code} (${product.name}): ${availableQuantity} —à—Ç. –¥–æ—Å—Ç—É–ø–Ω–æ`);
            });
            
            showAlert('–û—Ç–ª–∞–¥–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.', 'info');
        }

        function checkLocalStorage() {
            console.log('=== –ü–†–û–í–ï–†–ö–ê LOCALSTORAGE ===');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–ª—é—á–∏ localStorage
            console.log('–í—Å–µ –∫–ª—é—á–∏ –≤ localStorage:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`${i + 1}. ${key}`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏–Ω–≤–æ–π—Å—ã
            const invoicesData = localStorage.getItem('confirmedInvoices');
            console.log('–î–∞–Ω–Ω—ã–µ confirmedInvoices –≤ localStorage:', invoicesData);
            
            if (invoicesData) {
                try {
                    const parsed = JSON.parse(invoicesData);
                    console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–≤–æ–π—Å–æ–≤ –≤ localStorage:', parsed.length);
                    console.log('–ò–Ω–≤–æ–π—Å—ã:', parsed);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö:', e);
                }
            } else {
                console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö confirmedInvoices –≤ localStorage');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            console.log('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è confirmedInvoices:', window.confirmedInvoices);
            console.log('–õ–æ–∫–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è confirmedInvoices:', confirmedInvoices);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä localStorage
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length;
                }
            }
            console.log('–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä localStorage:', totalSize, '—Å–∏–º–≤–æ–ª–æ–≤');
            
            showAlert('–ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.', 'info');
        }

        function fixUserTypes() {
            console.log('=== –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ò–ü–û–í –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ===');
            
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', users);
            
            let fixed = false;
            users.forEach((user, index) => {
                // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç userType, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 'regular'
                if (!user.userType) {
                    console.log(`–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.login}: –¥–æ–±–∞–≤–ª—è–µ–º userType = 'regular'`);
                    user.userType = 'regular';
                    fixed = true;
                }
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç clientMB, –Ω–æ userType –Ω–µ 'client'
                if (user.clientMB && user.userType !== 'client') {
                    console.log(`–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.login}: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º userType = 'client'`);
                    user.userType = 'client';
                    fixed = true;
                }
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç clientMB, –Ω–æ userType = 'client'
                if (!user.clientMB && user.userType === 'client') {
                    console.log(`–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.login}: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º userType = 'regular'`);
                    user.userType = 'regular';
                    fixed = true;
                }
            });
            
            if (fixed) {
                localStorage.setItem('systemUsers', JSON.stringify(users));
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:', users);
                showAlert('–¢–∏–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!', 'success');
                loadUsersList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                console.log('–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è');
                showAlert('–í—Å–µ —Ç–∏–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã', 'info');
            }
        }

        // –§–£–ù–ö–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        function checkProductSeparation() {
            console.log('=== –ü–†–û–í–ï–†–ö–ê –†–ê–ó–î–ï–õ–ï–ù–ò–Ø –°–ò–°–¢–ï–ú–´ –ü–†–û–î–£–ö–¢–û–í ===');
            
            const issues = [];
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (products)
            console.log('üîç –û–°–ù–û–í–ù–´–ï –¢–û–í–ê–†–´ (products):');
            console.log(`   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${products ? products.length : 0}`);
            console.log('   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤: –∏–Ω–≤–æ–π—Å–∞—Ö, –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö');
            console.log('   - –ù–ï –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–ª–∏–µ–Ω—Ç–∞–º–∏');
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã
            const clientProductsInStorage = safeLocalStorage('get', 'clientProducts') || [];
            console.log('üîç –ö–õ–ò–ï–ù–¢–°–ö–ò–ï –¢–û–í–ê–†–´ (clientProducts):');
            console.log(`   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ localStorage: ${clientProductsInStorage.length}`);
            console.log('   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤: –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö (–ø—Ä–æ–¥—É–∫—Ç—ã, –ø—Ä–æ–¥–∞–∂–∏)');
            console.log('   - –ù–ï –¥–æ–ª–∂–Ω—ã —Å–º–µ—à–∏–≤–∞—Ç—å—Å—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏');
            
            if (window.clientProducts) {
                console.log(`   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –ø–∞–º—è—Ç–∏: ${window.clientProducts.length}`);
            } else {
                console.log('   - –í –ø–∞–º—è—Ç–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
            }
            
            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            console.log('üîç –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø:');
            console.log('   - renderClientProductsTable() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç: clientProducts ‚úÖ');
            console.log('   - loadSalesProducts() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç: clientProducts ‚úÖ');
            console.log('   - renderProductsTable() –∏—Å–ø–æ–ª—å–∑—É–µ—Ç: products ‚úÖ');
            
            // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ
            console.log('üîç –ê–í–¢–û–°–û–ó–î–ê–ù–ò–ï –¢–û–í–ê–†–û–í:');
            console.log('   - autoCreateClientProducts() —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã –≤ clientProducts ‚úÖ');
            console.log('   - –¢–æ–≤–∞—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∏–Ω–≤–æ–π—Å–æ–≤');
            console.log('   - –ü—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ —Å–∫–ª–∞–¥—Å–∫–∏–º –≥—Ä—É–ø–ø–∞–º');
            
            // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (window.currentUser) {
                console.log('üîç –¢–ï–ö–£–©–ò–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨:');
                console.log(`   - –¢–∏–ø: ${window.currentUser.userType}`);
                if (window.currentUser.userType === 'client') {
                    console.log(`   - –ú–ë –∫–ª–∏–µ–Ω—Ç–∞: ${window.currentUser.clientMB}`);
                    const clientProducts = clientProductsInStorage.filter(p => p.clientMB === window.currentUser.clientMB);
                    console.log(`   - –¢–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞: ${clientProducts.length}`);
                }
            }
            
            // 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            console.log('üîç –ü–†–û–í–ï–†–ö–ê –ù–ê –°–ú–ï–®–ò–í–ê–ù–ò–ï:');
            let mixingDetected = false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ products –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
            if (typeof window.products !== 'undefined') {
                issues.push('–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: window.products –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–ª–∏–µ–Ω—Ç–∞–º–∏');
                mixingDetected = true;
            }
            
            if (!mixingDetected) {
                console.log('   ‚úÖ –°–º–µ—à–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ');
            }
            
            // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if (issues.length === 0) {
                console.log('üéâ –°–ò–°–¢–ï–ú–ê –ü–†–û–î–£–ö–¢–û–í –ü–†–ê–í–ò–õ–¨–ù–û –†–ê–ó–î–ï–õ–ï–ù–ê!');
                showAlert('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∞', 'success');
            } else {
                console.log('‚ö†Ô∏è  –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´:');
                issues.forEach((issue, index) => {
                    console.log(`   ${index + 1}. ${issue}`);
                });
                showAlert(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: ${issues.length}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.`, 'warning');
            }
            
            return issues;
        }

        // –§–£–ù–ö–¶–ò–Ø: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
        function checkMemoryLeaks() {
            console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –£–¢–ï–ß–ï–ö –ü–ê–ú–Ø–¢–ò ===');
            
            const stats = EventManager.getStats();
            console.log('üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô:');
            console.log(`   –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: ${stats.total}`);
            console.log('   –ü–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π:', stats.byEvent);
            console.log('   –ü–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º:', stats.byElement);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
            const issues = [];
            
            if (stats.total > 100) {
                issues.push(`–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (${stats.total})`);
            }
            
            if (stats.byEvent.click > 50) {
                issues.push(`–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ú–Ω–æ–≥–æ click –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (${stats.byEvent.click})`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—Ç–µ—á–∫–∏)
            const allElements = document.querySelectorAll('*');
            let elementsWithoutTrackedListeners = 0;
            
            allElements.forEach(element => {
                const hasTrackedListeners = EventManager.listeners.some(listener => listener.element === element);
                const hasInlineHandlers = element.onclick || element.onchange || element.oninput || element.onblur;
                
                if (hasInlineHandlers && !hasTrackedListeners) {
                    elementsWithoutTrackedListeners++;
                }
            });
            
            if (elementsWithoutTrackedListeners > 0) {
                issues.push(`–£–¢–ï–ß–ö–ê –ü–ê–ú–Ø–¢–ò: ${elementsWithoutTrackedListeners} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            const globalVars = Object.keys(window).filter(key => 
                key.startsWith('current') || key.startsWith('confirmed') || key.includes('Products')
            );
            console.log('üåê –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï:', globalVars.length, '–Ω–∞–π–¥–µ–Ω–æ');
            globalVars.forEach(varName => {
                const value = window[varName];
                if (Array.isArray(value)) {
                    console.log(`   ${varName}: –º–∞—Å—Å–∏–≤ [${value.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤]`);
                } else if (typeof value === 'object' && value !== null) {
                    console.log(`   ${varName}: –æ–±—ä–µ–∫—Ç`);
                } else {
                    console.log(`   ${varName}: ${typeof value}`);
                }
            });
            
            // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if (issues.length === 0) {
                console.log('üéâ –£–¢–ï–ß–ï–ö –ü–ê–ú–Ø–¢–ò –ù–ï –û–ë–ù–ê–†–£–ñ–ï–ù–û!');
                showAlert('‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'success');
            } else {
                console.log('‚ö†Ô∏è  –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –£–¢–ï–ß–ö–ò:');
                issues.forEach((issue, index) => {
                    console.log(`   ${index + 1}. ${issue}`);
                });
                showAlert(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Ç–µ—á–µ–∫: ${issues.length}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.`, 'warning');
            }
            
            return {
                stats: stats,
                issues: issues,
                elementsWithoutTrackedListeners: elementsWithoutTrackedListeners,
                globalVars: globalVars
            };
        }

        function debugProductCreation() {
            console.log('=== –û–¢–õ–ê–î–ö–ê –°–û–ó–î–ê–ù–ò–Ø –¢–û–í–ê–†–û–í –ö–õ–ò–ï–ù–¢–ê ===');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            console.log('1. –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', window.currentUser);
            console.log('   - –¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', window.currentUser?.userType);
            console.log('   - –ú–∞—Ç–∏—á–Ω–∏ –±—Ä–æ—ò:', window.currentUser?.clientMB);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã
            const confirmedInvoices = JSON.parse(localStorage.getItem('confirmedInvoices') || '[]');
            console.log('2. –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã:', confirmedInvoices);
            console.log('   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:', confirmedInvoices.length);
            
            if (confirmedInvoices.length > 0) {
                const lastInvoice = confirmedInvoices[confirmedInvoices.length - 1];
                console.log('   - –ü–æ—Å–ª–µ–¥–Ω–∏–π –∏–Ω–≤–æ–π—Å:', lastInvoice);
                console.log('   - –°—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞:', lastInvoice.clientStatus);
                console.log('   - –¢–æ–≤–∞—Ä—ã –≤ –∏–Ω–≤–æ–π—Å–µ:', lastInvoice.items);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
            const clientProductGroups = JSON.parse(localStorage.getItem('clientProductGroups') || '[]');
            console.log('3. –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞:', clientProductGroups);
            console.log('   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø:', clientProductGroups.length);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞
            const clientProducts = JSON.parse(localStorage.getItem('clientProducts') || '[]');
            console.log('4. –¢–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞:', clientProducts);
            console.log('   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤:', clientProducts.length);
            
            if (window.currentUser?.clientMB) {
                const myProducts = clientProducts.filter(p => p.clientMB === window.currentUser.clientMB);
                console.log('   - –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã:', myProducts);
                console.log('   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤:', myProducts.length);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Å–∏—Å—Ç–µ–º—ã
            const systemProducts = JSON.parse(localStorage.getItem('products') || '[]');
            console.log('5. –¢–æ–≤–∞—Ä—ã —Å–∏—Å—Ç–µ–º—ã:', systemProducts);
            console.log('   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å–∏—Å—Ç–µ–º—ã:', systemProducts.length);
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
            if (window.currentUser?.userType === 'client' && confirmedInvoices.length > 0) {
                console.log('6. –¢–ï–°–¢–ò–†–£–ï–ú –°–û–ó–î–ê–ù–ò–ï –¢–û–í–ê–†–ê...');
                const testInvoice = confirmedInvoices.find(inv => inv.clientStatus === 'accepted');
                if (testInvoice) {
                    console.log('   - –ù–∞–π–¥–µ–Ω –ø—Ä–∏–Ω—è—Ç—ã–π –∏–Ω–≤–æ–π—Å –¥–ª—è —Ç–µ—Å—Ç–∞:', testInvoice);
                    console.log('   - –í—ã–∑—ã–≤–∞–µ–º autoCreateClientProducts...');
                    autoCreateClientProducts(testInvoice);
                } else {
                    console.log('   - –ù–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞');
                }
            }
            
            showAlert('–û—Ç–ª–∞–¥–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.', 'info');
        }

        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
                EventManager.removeAll();
                console.log('üßπ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—á–∏—â–µ–Ω—ã –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
                
                // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                window.currentUser = null;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
                restoreStandardHeader();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('loginForm').style.display = 'flex';
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginError').style.display = 'none';
                
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            }
        }

        function exportDocumentPDF(type, number) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
            if (type === 'invoice') {
                const invoice = confirmedInvoices.find(inv => inv.number === number);
                if (invoice) {
                    window.currentInvoiceData = invoice;
                    exportInvoiceToPDF();
                }
            } else {
                const delivery = confirmedDeliveries.find(del => del.number === number);
                if (delivery) {
                    window.currentDeliveryData = delivery;
                    exportDeliveryToPDF();
                }
            }
        }

        function openLogsModal() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
            if (!window.currentUser || !window.currentUser.permissions.logs) {
                showAlert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤', 'warning');
                return;
            }
            
            document.getElementById('logsModal').style.display = 'block';
            updateLogsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ª–æ–≥–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        }

        function closeLogsModal() {
            document.getElementById('logsModal').style.display = 'none';
        }

        function showClientHistory(clientName) {
            const clientInvoices = confirmedInvoices.filter(invoice => 
                invoice.client.name === clientName
            );

            document.getElementById('clientHistoryTitle').textContent = `–ò—Å—Ç–æ—Ä–∏—è –∏–Ω–≤–æ–π—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞: ${clientName}`;
            
            if (clientInvoices.length === 0) {
                document.getElementById('clientHistoryContent').innerHTML = 
                    '<p style="text-align: center; color: #666;">–£ –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –∏–Ω–≤–æ–π—Å–æ–≤</p>';
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, —á—Ç–æ –∏ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
                const tempContainer = document.createElement('div');
                tempContainer.id = 'tempClientInvoicesList';
                
                let listHTML = '';
                clientInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => {
                    const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                    const originalIndex = confirmedInvoices.findIndex(inv => inv.number === invoice.number);
                    const isDelivered = invoice.delivered || false;
                    const isPaid = invoice.paid || false;
                    
                    listHTML += `
                        <div class="invoice-item">
                            <div class="invoice-info">
                                <div style="font-weight: bold; color: #212529;">–ò–Ω–≤–æ–π—Å #${invoice.number}</div>
                                <div style="font-size: 14px; color: #666; margin-top: 5px;">${invoice.client.name} ‚Ä¢ ${date} ‚Ä¢ ${invoice.total.toFixed(2)} RSD</div>
                                <div style="font-size: 12px; color: #888; margin-top: 3px;">–¢–æ–≤–∞—Ä–æ–≤: ${invoice.items.length} ‚Ä¢ –ù–î–°: ${invoice.vatRate}%</div>
                                <div style="margin-top: 10px; display: flex; gap: 15px;">
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" ${isDelivered ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'delivered', this.checked)" style="transform: scale(1.2);">
                                        <span style="color: ${isDelivered ? '#28a745' : '#6c757d'};">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'paid', this.checked)" style="transform: scale(1.2);">
                                        <span style="color: ${isPaid ? '#28a745' : '#6c757d'};">–û–ø–ª–∞—á–µ–Ω</span>
                                    </label>
                                </div>
                            </div>
                            <div class="invoice-actions">
                                <button class="btn btn-secondary" onclick="viewConfirmedInvoice(${originalIndex})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω–≤–æ–π—Å">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                                <button class="btn btn-success" onclick="copyInvoiceData(${originalIndex})" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—ã–π –∏–Ω–≤–æ–π—Å">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                                <span class="invoice-status">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('clientHistoryContent').innerHTML = listHTML;
            }
            
            document.getElementById('clientHistoryModal').style.display = 'block';
            addLog(`–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∏–Ω–≤–æ–π—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞: ${clientName}`);
        }

        function closeClientHistoryModal() {
            document.getElementById('clientHistoryModal').style.display = 'none';
        }

        function updateDeliveryClientFilter() {
            const filter = document.getElementById('deliveryClientFilter');
            if (!filter) return;
            
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–ø—Ü–∏–∏, –∫—Ä–æ–º–µ "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã"
            filter.innerHTML = '<option value="">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>';
            
            // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü
            const uniqueClients = [...new Set(confirmedDeliveries.map(delivery => delivery.client.name))];
            
            uniqueClients.forEach(clientName => {
                const option = document.createElement('option');
                option.value = clientName;
                option.textContent = clientName;
                filter.appendChild(option);
            });
        }

        function filterDeliveriesByClient() {
            const selectedClient = document.getElementById('deliveryClientFilter').value;
            
            if (!selectedClient) {
                updateDeliveriesList();
                return;
            }
            
            const filteredDeliveries = confirmedDeliveries.filter(delivery => 
                delivery.client.name === selectedClient
            );
            
            updateDeliveriesList(filteredDeliveries);
        }

        function updateDeliveriesList(deliveries = confirmedDeliveries) {
            const container = document.getElementById('confirmedDeliveriesList');
            if (!container) return;

            if (deliveries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">–ù–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü</p>';
                return;
            }

            let listHTML = '';
            deliveries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((delivery, index) => {
                const date = new Date(delivery.date).toLocaleDateString('sr-RS');
                const dueDate = new Date(delivery.dueDate).toLocaleDateString('sr-RS');
                const originalIndex = confirmedDeliveries.findIndex(del => del.number === delivery.number);
                const isSigned = delivery.signed || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ #${delivery.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${delivery.client.name} ‚Ä¢ ${date} ‚Ä¢ –°—Ä–æ–∫: ${dueDate}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">–¢–æ–≤–∞—Ä–æ–≤: ${delivery.items.length} ‚Ä¢ –°–ø–æ—Å–æ–±: ${delivery.method}</div>
                            <div style="margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isSigned ? 'checked' : ''} onchange="toggleDeliveryStatus('${delivery.number}', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isSigned ? '#28a745' : '#6c757d'};">–ü–æ–¥–ø–∏—Å–∞–Ω–∞</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewDelivery(${originalIndex})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                            <span class="invoice-status">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</span>
                            ${delivery.clientStatus ? `<span class="status-badge ${getDocumentStatusClass(delivery.clientStatus)}">${getDocumentStatusText(delivery.clientStatus)}</span>` : '<span class="status-badge status-pending">–û–∂–∏–¥–∞–µ—Ç</span>'}
                            <button class="btn btn-danger" onclick="removeDelivery('${delivery.number}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = listHTML;
        }

        function toggleDeliveryStatus(deliveryNumber, isChecked) {
            const delivery = confirmedDeliveries.find(del => del.number === deliveryNumber);
            if (delivery) {
                delivery.signed = isChecked;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                
                addLog(`–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ #${deliveryNumber} –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ ${isChecked ? '–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è' : '–Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–∞—è'}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
                filterDeliveriesByClient();
            }
        }

        function viewDelivery(deliveryIndex) {
            const delivery = confirmedDeliveries[deliveryIndex];
            if (!delivery) {
                showAlert('–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'danger');
                return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            document.getElementById('deliveryNumber').value = delivery.number;
            document.getElementById('deliveryDate').value = delivery.date;
            document.getElementById('deliveryDueDate').value = delivery.dueDate;
            document.getElementById('deliveryMethod').value = delivery.method;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
            const clientIndex = clients.findIndex(c => c.name === delivery.client.name);
            if (clientIndex !== -1) {
                document.getElementById('deliveryClient').value = clientIndex;
                document.getElementById('deliveryClientSearch').value = delivery.client.name;
            }
            
            showAlert('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'success');
        }

        function removeDelivery(deliveryNumber) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É #${deliveryNumber} –∏–∑ —Å–ø–∏—Å–∫–∞?`)) {
                confirmedDeliveries = confirmedDeliveries.filter(del => del.number !== deliveryNumber);
                localStorage.setItem('confirmedDeliveries', JSON.stringify(confirmedDeliveries));
                
                updateDeliveriesList();
                updateDeliveryClientFilter();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
                if (window.currentClientProfile && document.getElementById('clientHistorySection').style.display === 'block') {
                    loadClientHistory(window.currentClientProfile.name);
                }
                
                addLog(`–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ #${deliveryNumber} —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞`);
                showAlert('–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞!', 'success');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
        window.onclick = function(event) {
            const addUserModal = document.getElementById('addUserModal');
            const clientHistoryModal = document.getElementById('clientHistoryModal');
            
            if (event.target === addUserModal) {
                closeAddUserModal();
            }
            if (event.target === clientHistoryModal) {
                closeClientHistoryModal();
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }

        function addLog(action) {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            const now = new Date();
            logs.unshift({
                time: now.toLocaleString(),
                action
            });
            localStorage.setItem('actionLogs', JSON.stringify(logs));
        }

        function updateLogsList() {
            const logs = JSON.parse(localStorage.getItem('actionLogs') || '[]');
            const logsList = document.getElementById('logsList');
            if (!logsList) return;
            logsList.innerHTML = logs.length ? logs.map(log => `<li style='padding:10px 0; border-bottom:1px solid #dee2e6;'><b>${log.time}</b>: ${log.action}</li>`).join('') : '<li style="color:#888;">–ù–µ—Ç –ª–æ–≥–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π</li>';
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∫–ª–∏–∫–æ–≤
        document.addEventListener('click', function(event) {
            // –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–æ–≥–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
            let el = event.target;
            let inLogsModal = false;
            while (el) {
                if (el.id === 'logsModal') { inLogsModal = true; break; }
                el = el.parentElement;
            }
            if (inLogsModal) return;

            let desc = '';
            if (event.target.closest('button')) {
                const btn = event.target.closest('button');
                desc = `–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ: "${btn.textContent.trim()}"`;
            } else if (event.target.closest('a')) {
                const a = event.target.closest('a');
                desc = `–ö–ª–∏–∫ –ø–æ —Å—Å—ã–ª–∫–µ: "${a.textContent.trim()}" (${a.href})`;
            } else if (event.target.closest('input, select, textarea')) {
                const input = event.target.closest('input, select, textarea');
                desc = `–ö–ª–∏–∫ –ø–æ –ø–æ–ª—é: <${input.tagName.toLowerCase()}> (name/id: ${input.name || input.id})`;
            } else {
                desc = `–ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É: <${event.target.tagName.toLowerCase()}>`;
            }
            addLog(desc);
        }, true);

        // –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞
        window.currentClientProfile = null;

        function toggleClientForm() {
            const formSection = document.getElementById('clientFormSection');
            const toggleBtn = document.getElementById('toggleFormBtn');
            const toggleIcon = document.getElementById('toggleIcon');
            
            if (formSection.style.display === 'none' || formSection.style.display === '') {
                formSection.style.display = 'block';
                toggleIcon.textContent = '‚ûñ';
                toggleBtn.innerHTML = '<span id="toggleIcon">‚ûñ</span> –°–≤–µ—Ä–Ω—É—Ç—å —Ñ–æ—Ä–º—É';
            } else {
                formSection.style.display = 'none';
                toggleIcon.textContent = '‚ûï';
                toggleBtn.innerHTML = '<span id="toggleIcon">‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞';
            }
        }

        function openClientProfile(clientIndex) {
            const client = clients[clientIndex];
            if (!client) return;
            
            window.currentClientProfile = { ...client, index: clientIndex };
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ –ø–µ—Ä–≤—ã—Ö –±—É–∫–≤
            const avatar = client.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('clientAvatar').textContent = avatar;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('profileClientName').textContent = client.name || '-';
            document.getElementById('profileClientLegalName').textContent = client.legalName || '-';
            document.getElementById('profileClientMB').textContent = client.mb || '-';
            document.getElementById('profileClientPIB').textContent = client.pib || '-';
            document.getElementById('profileClientContactPerson').textContent = client.contactPerson || '-';
            document.getElementById('profileClientBank').textContent = client.bank || '-';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∞–¥—Ä–µ—Å
            document.getElementById('profileClientAddress').textContent = client.address || '-';
            const googleMapsBtn = document.getElementById('profileGoogleMapsBtn');
            if (client.googleMaps) {
                googleMapsBtn.style.display = 'block';
                googleMapsBtn.onclick = () => window.open(client.googleMaps, '_blank');
            } else {
                googleMapsBtn.style.display = 'none';
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const contactFields = [
                { id: 'contactPhone', valueId: 'profileClientPhone', value: client.phone },
                { id: 'contactEmail', valueId: 'profileClientEmail', value: client.email },
                { id: 'contactTelegram', valueId: 'profileClientTelegram', value: client.telegram },
                { id: 'contactInstagram', valueId: 'profileClientInstagram', value: client.instagram }
            ];
            
            contactFields.forEach(field => {
                const element = document.getElementById(field.id);
                const valueElement = document.getElementById(field.valueId);
                if (field.value) {
                    element.style.display = 'flex';
                    valueElement.textContent = field.value;
                } else {
                    element.style.display = 'none';
                }
            });
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —É—Å–ª–æ–≤–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞
            const collaborationTags = document.getElementById('collaborationTags');
            const notesElement = document.getElementById('profileClientNotes');
            
            let tagsHTML = '';
            if (client.installment) {
                const term = client.installmentTerm ? ` (${client.installmentTerm} –¥–Ω–µ–π)` : '';
                tagsHTML += `<span class="collab-tag installment">–†–∞—Å—Å—Ä–æ—á–∫–∞${term}</span>`;
            }
            if (client.showcase) {
                tagsHTML += `<span class="collab-tag showcase">–í–∏—Ç—Ä–∏–Ω–∞</span>`;
            }
            if (client.bar) {
                tagsHTML += `<span class="collab-tag bar">–ë–∞—Ä</span>`;
            }
            
            collaborationTags.innerHTML = tagsHTML || '<span style="color: #6c757d; font-style: italic;">–ù–µ—Ç –æ—Å–æ–±—ã—Ö —É—Å–ª–æ–≤–∏–π</span>';
            
            if (client.notes) {
                notesElement.style.display = 'block';
                notesElement.textContent = client.notes;
            } else {
                notesElement.style.display = 'none';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            document.getElementById('clientProfileTitle').textContent = client.name;
            document.getElementById('clientProfileSubtitle').textContent = `${client.legalName || client.name} ‚Ä¢ –ú–ë: ${client.mb}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('clientProfileModal').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateClientStatistics();
            
            addLog(`–û—Ç–∫—Ä—ã—Ç –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞: ${client.name}`);
        }

        function closeClientProfileModal() {
            document.getElementById('clientProfileModal').style.display = 'none';
            window.currentClientProfile = null;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–¥ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
            switchToClientProfile();
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            switchToViewMode();
        }

        function switchToClientHistory() {
            if (!window.currentClientProfile) return;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            document.getElementById('profile-sections').style.display = 'none';
            document.getElementById('viewModeFooter').style.display = 'none';
            document.getElementById('clientHistorySection').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏
            const client = window.currentClientProfile;
            const avatar = client.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('historyClientAvatar').textContent = avatar;
            document.getElementById('historyClientTitle').textContent = `–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤`;
            document.getElementById('historyClientSubtitle').textContent = `${client.name} ‚Ä¢ –ò–Ω–≤–æ–π—Å—ã –∏ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã`;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤
            loadClientHistory(client.name);
            
            addLog(`–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞: ${client.name}`);
        }

        function switchToClientProfile() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            document.getElementById('profile-sections').style.display = 'grid';
            document.getElementById('viewModeFooter').style.display = 'block';
            document.getElementById('clientHistorySection').style.display = 'none';
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            document.getElementById('edit-sections').style.display = 'none';
            document.getElementById('editModeFooter').style.display = 'none';
        }

        function switchToEditMode() {
            if (!window.currentClientProfile) return;
            
            const client = clients[window.currentClientProfile.index];
            if (!client) return;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞
            document.getElementById('editClientName').value = client.name || '';
            document.getElementById('editClientLegalName').value = client.legalName || '';
            document.getElementById('editClientMB').value = client.mb || '';
            document.getElementById('editClientPIB').value = client.pib || '';
            document.getElementById('editClientContactPerson').value = client.contactPerson || '';
            document.getElementById('editClientBank').value = client.bank || '';
            
            // –ê–¥—Ä–µ—Å
            const isManualAddress = client.isManualAddress || false;
            document.getElementById('editManualAddressInput').checked = isManualAddress;
            
            if (isManualAddress) {
                document.getElementById('editAutoAddressSection').style.display = 'none';
                document.getElementById('editManualAddressSection').style.display = 'block';
                document.getElementById('editClientManualAddress').value = client.address || '';
            } else {
                document.getElementById('editAutoAddressSection').style.display = 'block';
                document.getElementById('editManualAddressSection').style.display = 'none';
                document.getElementById('editClientCity').value = client.city || '';
                document.getElementById('editClientMunicipality').value = client.municipality || '';
                document.getElementById('editClientStreet').value = client.street || '';
                document.getElementById('editClientHouseNumber').value = client.houseNumber || '';
            }
            
            document.getElementById('editClientGoogleMaps').value = client.googleMaps || '';
            
            // –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            document.getElementById('editClientPhone').value = client.phone || '';
            document.getElementById('editClientEmail').value = client.email || '';
            document.getElementById('editClientTelegram').value = client.telegram || '';
            document.getElementById('editClientInstagram').value = client.instagram || '';
            
            // –£—Å–ª–æ–≤–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞
            document.getElementById('editClientInstallment').checked = client.installment || false;
            document.getElementById('editClientInstallmentTerm').value = client.installmentTerm || '';
            document.getElementById('editClientShowcase').checked = client.showcase || false;
            document.getElementById('editClientBar').checked = client.bar || false;
            document.getElementById('editClientNotes').value = client.notes || '';
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∏–ø–∞ –∞–¥—Ä–µ—Å–∞
            document.getElementById('editManualAddressInput').onchange = function() {
                if (this.checked) {
                    document.getElementById('editAutoAddressSection').style.display = 'none';
                    document.getElementById('editManualAddressSection').style.display = 'block';
                } else {
                    document.getElementById('editAutoAddressSection').style.display = 'block';
                    document.getElementById('editManualAddressSection').style.display = 'none';
                }
            };
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('profile-sections').style.display = 'none';
            document.getElementById('viewModeFooter').style.display = 'none';
            document.getElementById('edit-sections').style.display = 'block';
            document.getElementById('editModeFooter').style.display = 'block';
            
            addLog(`–û—Ç–∫—Ä—ã—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: ${client.name}`);
        }

        function switchToViewMode() {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –∫ —Ä–µ–∂–∏–º—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            document.getElementById('profile-sections').style.display = 'grid';
            document.getElementById('viewModeFooter').style.display = 'block';
            document.getElementById('edit-sections').style.display = 'none';
            document.getElementById('editModeFooter').style.display = 'none';
        }

        function loadClientHistory(clientName) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–µ–∏—Ö –≤–∫–ª–∞–¥–æ–∫
            loadClientInvoices(clientName);
            loadClientDeliveries(clientName);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ –≤–∫–ª–∞–¥–∫–∞—Ö
            updateHistoryTabCounts(clientName);
        }

        function loadClientInvoices(clientName) {
            const clientInvoices = confirmedInvoices.filter(invoice => invoice.client.name === clientName);
            const contentElement = document.getElementById('clientInvoicesContent');
            
            if (clientInvoices.length === 0) {
                contentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">–£ –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç –∏–Ω–≤–æ–π—Å–æ–≤</p>';
                return;
            }

            let listHTML = '';
            clientInvoices.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => {
                const date = new Date(invoice.date).toLocaleDateString('sr-RS');
                const originalIndex = confirmedInvoices.findIndex(inv => inv.number === invoice.number);
                const isDelivered = invoice.delivered || false;
                const isPaid = invoice.paid || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">–ò–Ω–≤–æ–π—Å #${invoice.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${invoice.client.name} ‚Ä¢ ${date} ‚Ä¢ ${invoice.total.toFixed(2)} RSD</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">–¢–æ–≤–∞—Ä–æ–≤: ${invoice.items.length} ‚Ä¢ –ù–î–°: ${invoice.vatRate}%</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isDelivered ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'delivered', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isDelivered ? '#333' : '#6c757d'};">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isPaid ? 'checked' : ''} onchange="toggleInvoiceStatus('${invoice.number}', 'paid', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isPaid ? '#333' : '#6c757d'};">–û–ø–ª–∞—á–µ–Ω</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewConfirmedInvoice(${originalIndex})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω–≤–æ–π—Å">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                            <button class="btn btn-success" onclick="copyInvoiceData(${originalIndex})" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –Ω–æ–≤—ã–π –∏–Ω–≤–æ–π—Å">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            <span class="invoice-status">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                        </div>
                    </div>
                `;
            });
            contentElement.innerHTML = listHTML;
        }

        function loadClientDeliveries(clientName) {
            const clientDeliveries = confirmedDeliveries.filter(delivery => delivery.client.name === clientName);
            const contentElement = document.getElementById('clientDeliveriesContent');
            
            if (clientDeliveries.length === 0) {
                contentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">–£ –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü</p>';
                return;
            }

            let listHTML = '';
            clientDeliveries.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((delivery, index) => {
                const date = new Date(delivery.date).toLocaleDateString('sr-RS');
                const dueDate = new Date(delivery.dueDate).toLocaleDateString('sr-RS');
                const originalIndex = confirmedDeliveries.findIndex(del => del.number === delivery.number);
                const isSigned = delivery.signed || false;
                
                listHTML += `
                    <div class="invoice-item">
                        <div class="invoice-info">
                            <div style="font-weight: bold; color: #212529;">–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ #${delivery.number}</div>
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">${delivery.client.name} ‚Ä¢ ${date} ‚Ä¢ –°—Ä–æ–∫: ${dueDate}</div>
                            <div style="font-size: 12px; color: #888; margin-top: 3px;">–¢–æ–≤–∞—Ä–æ–≤: ${delivery.items.length} ‚Ä¢ –°–ø–æ—Å–æ–±: ${delivery.method}</div>
                            <div style="margin-top: 10px; display: flex; gap: 15px;">
                                <label style="display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer;">
                                    <input type="checkbox" ${isSigned ? 'checked' : ''} onchange="toggleDeliveryStatus('${delivery.number}', this.checked)" style="transform: scale(1.2);">
                                    <span style="color: ${isSigned ? '#333' : '#6c757d'};">–ü–æ–¥–ø–∏—Å–∞–Ω–∞</span>
                                </label>
                            </div>
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-secondary" onclick="viewDeliveryFromHistory(${originalIndex})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—É">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                            <span class="invoice-status">–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</span>
                        </div>
                    </div>
                `;
            });
            contentElement.innerHTML = listHTML;
        }

        function updateHistoryTabCounts(clientName) {
            const invoicesCount = confirmedInvoices.filter(invoice => invoice.client.name === clientName).length;
            const deliveriesCount = confirmedDeliveries.filter(delivery => delivery.client.name === clientName).length;
            
            document.getElementById('invoicesCount').textContent = invoicesCount;
            document.getElementById('deliveriesCount').textContent = deliveriesCount;
        }

        function switchHistoryTab(tab) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.history-tab').forEach(tabEl => tabEl.classList.remove('active'));
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–Ω—Ç—ã
            document.getElementById('clientInvoicesContent').style.display = 'none';
            document.getElementById('clientDeliveriesContent').style.display = 'none';
            
            if (tab === 'invoices') {
                document.getElementById('invoicesTab').classList.add('active');
                document.getElementById('clientInvoicesContent').style.display = 'block';
            } else if (tab === 'deliveries') {
                document.getElementById('deliveriesTab').classList.add('active');
                document.getElementById('clientDeliveriesContent').style.display = 'block';
            }
        }



        function viewDeliveryFromHistory(deliveryIndex) {
            const delivery = confirmedDeliveries[deliveryIndex];
            if (!delivery) return;
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∏–Ω–≤–æ–π—Å–∞–º)
            showDeliveryModal(delivery, deliveryIndex);
        }

        function showDeliveryModal(delivery, deliveryIndex) {
            const modalHTML = `
                <div class="modal" id="deliveryViewModal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 class="modal-title">–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ #${delivery.number}</h2>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-primary" onclick="printDeliveryFromModal()">–≠–∫—Å–ø–æ—Ä—Ç PDF</button>
                                <button class="btn btn-danger" onclick="closeDeliveryViewModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                            </div>
                        </div>
                        <div id="modalDeliveryContent" style="padding: 20px;">
                            ${generateDeliveryHTMLForModal(delivery)}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            window.currentModalDelivery = delivery;
        }

        function generateDeliveryHTMLForModal(delivery) {
            let itemsHTML = '';
            delivery.items.forEach(item => {
                itemsHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; font-size: 10px;">${item.product.code}/${item.product.name}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.quantity}</td>
                        <td style="padding: 4px 6px; border-bottom: 1px solid #eee; text-align: center; font-size: 10px;">${item.product.unit || '–∫–æ–º'}</td>
                    </tr>
                `;
            });

            return `
                <div style="max-width: 210mm; margin: 0 auto; padding: 10mm; font-family: 'Segoe UI', Arial, sans-serif; background: white; line-height: 1.3; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="https://i.ibb.co/tMCT4jb7/srb-white-verical.png" alt="srb-white-verical" border="0" style="width: 70px; height: auto; border-radius: 10px; background: #000; padding: 8px;">
                            <div>
                                <h2 style="margin: 0; font-size: 15px; color: #333; line-height: 1.2;">–°—Ä–µƒß–∞ 2024 –î–û–û –ë–µ–æ–≥—Ä–∞–¥ (–°—Ç–∞—Ä–∏ –ì—Ä–∞–¥)</h2>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Matiƒçni broj: 22019309</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">PIB: 114407658</p>
                                <p style="margin: 1px 0; color: #666; font-size: 10px;">Sedi≈°te: Beograd, Stari Grad, –ú–∞—ò–∫–µ –à–µ–≤—Ä–æ—Å–∏–º–µ 35</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <h1 style="margin: 0; font-size: 32px; color: #666; font-weight: 300;">–û–¢–ü–†–ï–ú–ù–ò–¶–ê</h1>
                            <p style="margin: 3px 0 0 0; font-size: 13px; color: #666;"># ${delivery.number}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">–ü–æ—Ä—É—á–∏–ª–∞—Ü:</h4>
                            <div style="font-size: 10px; line-height: 1.3;">
                                <p style="margin: 0; font-weight: bold;">${delivery.client.legalName || delivery.client.name}</p>
                                <p style="margin: 0;">Matiƒçni broj: ${delivery.client.mb}</p>
                                <p style="margin: 0;">PIB: ${delivery.client.pib}</p>
                                <p style="margin: 0;">Sedi≈°te: ${delivery.client.address}</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #333; font-size: 11px;">–ò—Å–ø–æ—Ä—É–∫–∞ –Ω–∞ –∞–¥—Ä–µ—Å—É:</h4>
                            <p style="margin: 0; font-size: 10px;">${delivery.client.address}</p>
                            <p style="margin: 6px 0 0 0; font-size: 10px;"><strong>–ù–∞—á–∏–Ω:</strong> ${delivery.method}</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <p style="margin: 2px 0; font-size: 10px;"><strong>–î–∞—Ç–∞:</strong> ${new Date(delivery.date).toLocaleDateString('sr-RS')}</p>
                        <p style="margin: 2px 0; font-size: 10px;"><strong>–†–æ–∫ –∏—Å–ø–æ—Ä—É–∫–µ:</strong> ${new Date(delivery.dueDate).toLocaleDateString('sr-RS')}</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10px;">
                        <thead>
                            <tr style="background: #333; color: white;">
                                <th style="padding: 6px; text-align: left; font-size: 10px; font-weight: normal;">–ù–∞–∑–∏–≤ –∞—Ä—Ç–∏–∫–ª–∞</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">–ö–æ–ª–∏—á–∏–Ω–∞</th>
                                <th style="padding: 6px; text-align: center; font-size: 10px; font-weight: normal;">–à–µ–¥–∏–Ω–∏—Ü–∞ –º–µ—Ä–µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>–ò–∑–¥–∞–æ</strong></div>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; margin-bottom: 6px; height: 25px;"></div>
                            <div style="font-size: 10px;"><strong>–ü—Ä–∏–º–∏–æ</strong></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px; text-align: center; font-size: 9px; color: #666;">
                        –û–≤–∞—ò –¥–æ–∫—É–º–µ–Ω—Ç —ò–µ –≥–µ–Ω–µ—Ä–∏—Å–∞–Ω –µ–ª–µ–∫—Ç—Ä–æ–Ω—Å–∫–∏ –∏ –≤–∞–∂–∏ –±–µ–∑ –ø–µ—á–∞—Ç–∞ –∏ –ø–æ—Ç–ø–∏—Å–∞
                    </div>
                </div>
            `;
        }

        function closeDeliveryViewModal() {
            const modal = document.getElementById('deliveryViewModal');
            if (modal) {
                document.body.removeChild(modal);
                window.currentModalDelivery = null;
            }
        }

        function printDeliveryFromModal() {
            if (!window.currentModalDelivery) {
                showAlert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!', 'danger');
                return;
            }

            const delivery = window.currentModalDelivery;
            const deliveryContent = generateDeliveryHTMLForModal(delivery);
            
            const fullHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ ${delivery.number}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 10mm;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                            font-family: 'Segoe UI', Arial, sans-serif;
                        }
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${deliveryContent}
                </body>
                </html>
            `;

            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `–û—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞_${delivery.number.replace(/[^a-zA-Z0-9]/g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–ø—Ä–µ–º–Ω–∏—Ü–∞ #${delivery.number}`);
        }

        function exportClientHistoryToPDF() {
            if (!window.currentClientProfile) return;
            
            const client = window.currentClientProfile;
            showAlert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –≤ PDF –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö', 'info');
            addLog(`–≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –≤ PDF: ${client.name}`);
        }



        function saveClientChanges() {
            if (!window.currentClientProfile) return;
            
            const clientIndex = window.currentClientProfile.index;
            const client = clients[clientIndex];
            if (!client) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
            const name = document.getElementById('editClientName').value.trim();
            const legalName = document.getElementById('editClientLegalName').value.trim();
            const mb = document.getElementById('editClientMB').value.trim();
            const pib = document.getElementById('editClientPIB').value.trim();
            const contactPerson = document.getElementById('editClientContactPerson').value.trim();
            const bank = document.getElementById('editClientBank').value.trim();
            const isManualInput = document.getElementById('editManualAddressInput').checked;
            
            // –ù–æ–≤—ã–µ –ø–æ–ª—è
            const googleMaps = document.getElementById('editClientGoogleMaps').value.trim();
            const phone = document.getElementById('editClientPhone').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            const telegram = document.getElementById('editClientTelegram').value.trim();
            const instagram = document.getElementById('editClientInstagram').value.trim();
            const installment = document.getElementById('editClientInstallment').checked;
            const installmentTerm = document.getElementById('editClientInstallmentTerm').value.trim();
            const showcase = document.getElementById('editClientShowcase').checked;
            const bar = document.getElementById('editClientBar').checked;
            const notes = document.getElementById('editClientNotes').value.trim();
            
            let address, city, municipality, street, houseNumber;
            
            if (isManualInput) {
                address = document.getElementById('editClientManualAddress').value.trim();
                if (!name || !legalName || !mb || !pib || !address) {
                    showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'danger');
                    return;
                }
                // –ü–∞—Ä—Å–∏–º –∞–¥—Ä–µ—Å –¥–ª—è –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                const addressParts = address.split(',').map(part => part.trim());
                city = addressParts[0] || '';
                municipality = addressParts[1] || '';
                street = addressParts[2] || '';
                houseNumber = addressParts[3] || '';
            } else {
                city = document.getElementById('editClientCity').value.trim();
                municipality = document.getElementById('editClientMunicipality').value.trim();
                street = document.getElementById('editClientStreet').value.trim();
                houseNumber = document.getElementById('editClientHouseNumber').value.trim();
                
                if (!name || !legalName || !mb || !pib || !city || !municipality || !street) {
                    showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!', 'danger');
                    return;
                }
                
                address = `${city}, ${municipality}, ${street}`;
                if (houseNumber) {
                    address += ` ${houseNumber}`;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ú–ë –∏ –ü–ò–ë (–∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
            const existingClient = clients.find((c, index) => 
                index !== clientIndex && (c.mb === mb || c.pib === pib)
            );
            
            if (existingClient) {
                showAlert('–ö–ª–∏–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –ú–ë –∏–ª–∏ –ü–ò–ë —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'danger');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
            const oldName = client.name;
            clients[clientIndex] = {
                ...client,
                name,
                legalName,
                mb,
                pib,
                address,
                bank,
                city,
                municipality,
                street,
                houseNumber,
                isManualAddress: isManualInput,
                googleMaps,
                contactPerson,
                phone,
                email,
                telegram,
                instagram,
                installment,
                installmentTerm,
                showcase,
                bar,
                notes,
                contact: contactPerson || phone || email || ''
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('clients', JSON.stringify(clients));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderClientsTable();
            updateSelectOptions();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
            window.currentClientProfile = { ...clients[clientIndex], index: clientIndex };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
            if (document.getElementById('clientProfileModal').style.display === 'block') {
                openClientProfile(clientIndex);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Ä–µ–∂–∏–º—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                switchToViewMode();
            }
            
            addLog(`–û–±–Ω–æ–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç: ${oldName} ‚Üí ${name}`);
            showAlert('–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
        }

        function openGoogleMaps() {
            if (window.currentClientProfile && window.currentClientProfile.googleMaps) {
                window.open(window.currentClientProfile.googleMaps, '_blank');
            }
        }

        function updateClientStatistics() {
            if (!window.currentClientProfile) return;
            
            const clientName = window.currentClientProfile.name;
            const period = document.getElementById('statisticsPeriod').value;
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–≤–æ–π—Å—ã –∫–ª–∏–µ–Ω—Ç–∞
            const clientInvoices = confirmedInvoices.filter(invoice => invoice.client.name === clientName);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–µ—Ä–∏–æ–¥—É
            let filteredInvoices = clientInvoices;
            const now = new Date();
            
            if (period === 'year') {
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfYear);
            } else if (period === 'quarter') {
                const currentQuarter = Math.floor(now.getMonth() / 3);
                const startOfQuarter = new Date(now.getFullYear(), currentQuarter * 3, 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfQuarter);
            } else if (period === 'month') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfMonth);
            }
            
            // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const invoiceCount = filteredInvoices.length;
            const totalSum = filteredInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            const avgOrderValue = invoiceCount > 0 ? totalSum / invoiceCount : 0;
            
            // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç
            const productCounts = {};
            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    const productName = item.name || item.product?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
                    productCounts[productName] = (productCounts[productName] || 0) + item.quantity;
                });
            });
            
            let topProduct = '-';
            let maxCount = 0;
            for (const [product, count] of Object.entries(productCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    topProduct = product;
                }
            }
            
            // –ì–æ–¥–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (–≤—Å–µ–≥–¥–∞ –∑–∞ –≥–æ–¥)
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const yearlyInvoices = clientInvoices.filter(invoice => new Date(invoice.date) >= startOfYear);
            const yearlyConsumption = yearlyInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('clientAvgOrderValue').textContent = avgOrderValue.toFixed(2) + ' RSD';
            document.getElementById('clientInvoiceCount').textContent = invoiceCount;
            document.getElementById('clientTopProduct').textContent = topProduct;
            document.getElementById('clientYearlyConsumption').textContent = yearlyConsumption.toFixed(2) + ' RSD';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –≥—Ä—É–ø–ø–∞—Ö
        document.addEventListener('input', function(event) {
            if (event.target.classList.contains('group-product-search')) {
                const searchInput = event.target;
                const groupId = searchInput.id.replace('groupProductSearch-', '');
                const dropdown = document.getElementById(`groupProductDropdown-${groupId}`);
                const hiddenInput = document.getElementById(`groupProductCode-${groupId}`);
                const query = searchInput.value.toLowerCase().trim();
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    hiddenInput.value = '';
                    return;
                }
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã —Å –≤–µ—Å–æ–º –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–æ–¥—É, –∫–æ–¥—É —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é
                const filteredProducts = products.filter(product => 
                    product.weight > 0 && (
                        (product.internalCode && product.internalCode.toLowerCase().includes(query)) ||
                        (product.code && product.code.toLowerCase().includes(query)) || 
                        (product.name && product.name.toLowerCase().includes(query))
                    )
                ).slice(0, 10); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                
                if (filteredProducts.length === 0) {
                    dropdown.innerHTML = '<div class="dropdown-item disabled">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                } else {
                    dropdown.innerHTML = filteredProducts.map(product => 
                        `<div class="dropdown-item" data-internal-code="${product.internalCode}" data-code="${product.code}" data-name="${product.name}" data-weight="${product.weight}">
                            <strong>${product.code}</strong> - ${product.name} (${product.weight}–≥)
                        </div>`
                    ).join('');
                }
                
                dropdown.style.display = 'block';
            }
        });

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('dropdown-item') && event.target.closest('.group-product-dropdown')) {
                const item = event.target;
                const dropdown = item.closest('.group-product-dropdown');
                const groupId = dropdown.id.replace('groupProductDropdown-', '');
                const searchInput = document.getElementById(`groupProductSearch-${groupId}`);
                const hiddenInput = document.getElementById(`groupProductCode-${groupId}`);
                
                const internalCode = item.getAttribute('data-internal-code');
                const code = item.getAttribute('data-code');
                const name = item.getAttribute('data-name');
                const weight = item.getAttribute('data-weight');
                
                searchInput.value = `${code} - ${name} (${weight}–≥)`;
                hiddenInput.value = internalCode;
                dropdown.style.display = 'none';
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            if (!event.target.closest('.searchable-select')) {
                document.querySelectorAll('.group-product-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        function highlightRequiredFields() {
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø–æ –ª–µ–π–±–ª–∞–º —Å–æ –∑–≤–µ–∑–¥–æ—á–∫–æ–π
            const requiredLabels = document.querySelectorAll('label');
            
            requiredLabels.forEach(label => {
                if (label.textContent.includes('*')) {
                    // –ù–∞—Ö–æ–¥–∏–º —Å–≤—è–∑–∞–Ω–Ω–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    const fieldId = label.getAttribute('for') || label.nextElementSibling?.id;
                    let field = null;
                    
                    if (fieldId) {
                        field = document.getElementById(fieldId);
                    } else {
                        // –ò—â–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ —Ç–æ–º –∂–µ form-group
                        const formGroup = label.closest('.form-group');
                        if (formGroup) {
                            field = formGroup.querySelector('input, select, textarea');
                        }
                    }
                    
                    if (field) {
                        field.classList.add('required-field');
                        label.classList.add('required-label');
                    }
                }
            });
        }

        function validateRequiredFields(container = document) {
            let isValid = true;
            const requiredFields = container.querySelectorAll('.required-field');
            
            requiredFields.forEach(field => {
                const value = field.value.trim();
                
                if (!value) {
                    field.classList.add('required-field-error');
                    field.classList.remove('required-field');
                    isValid = false;
                    
                    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        field.classList.remove('required-field-error');
                        field.classList.add('required-field');
                    }, 3000);
                } else {
                    field.classList.remove('required-field-error');
                    field.classList.add('required-field');
                }
            });
            
            return isValid;
        }

        function resetFieldHighlighting(container = document) {
            const fields = container.querySelectorAll('.required-field, .required-field-error');
            fields.forEach(field => {
                field.classList.remove('required-field-error');
                field.classList.add('required-field');
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                highlightRequiredFields();
            }, 500);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
        document.addEventListener('input', function(event) {
            if (event.target.classList.contains('required-field-error')) {
                event.target.classList.remove('required-field-error');
                event.target.classList.add('required-field');
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏—Ö
        window.onclick = function(event) {
            const clientProfileModal = document.getElementById('clientProfileModal');
            const editProductModal = document.getElementById('editProductModal');
            const clientEditProductModal = document.getElementById('clientEditProductModal');
            
            if (event.target === clientProfileModal) {
                closeClientProfileModal();
            }
            
            if (event.target === editProductModal) {
                closeEditProductModal();
            }
            
            if (event.target === clientEditProductModal) {
                closeClientEditProductModal();
            }
        }
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤—è–∑–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–ª–∞–¥–æ–º
        function checkProductWarehouseConnection() {
            console.log('=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–í–Ø–ó–ò –¢–û–í–ê–†–û–í –°–û –°–ö–õ–ê–î–û–ú ===');
            
            const clientMB = window.currentUser?.clientMB;
            if (!clientMB) {
                console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–∫—É—â–µ–º –∫–ª–∏–µ–Ω—Ç–µ');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            if (!window.clientProducts) {
                window.clientProducts = safeLocalStorage('get', 'clientProducts') || [];
            }
            if (!window.clientProductGroups) {
                window.clientProductGroups = safeLocalStorage('get', 'clientProductGroups') || [];
            }
            
            console.log(`\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–≤–∞—Ä—ã –∫–ª–∏–µ–Ω—Ç–∞ ${clientMB}:`);
            const clientProducts = window.clientProducts.filter(p => p.clientMB === clientMB);
            console.log(`–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞: ${clientProducts.length}`);
            
            console.log(`\nüì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä—É–ø–ø—ã –Ω–∞ —Å–∫–ª–∞–¥–µ:`);
            console.log(`–í—Å–µ–≥–æ –≥—Ä—É–ø–ø –Ω–∞ —Å–∫–ª–∞–¥–µ: ${window.clientProductGroups.length}`);
            
            clientProducts.forEach((clientProduct, index) => {
                console.log(`\n--- –¢–û–í–ê–† ${index + 1} ---`);
                console.log(`–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞: ${clientProduct.code}`);
                console.log(`–ù–∞–∑–≤–∞–Ω–∏–µ: ${clientProduct.name}`);
                console.log(`–í–µ—Å: ${clientProduct.weight}–≥`);
                console.log(`–ú–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${clientProduct.maxQuantity}`);
                console.log(`Warehouse Link: ${clientProduct.warehouseLink}`);
                
                // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –≥—Ä—É–ø–ø—É
                const matchingGroup = window.clientProductGroups.find(group => 
                    group.products && group.products.some(p => p.product.internalCode === clientProduct.warehouseLink)
                );
                
                if (matchingGroup) {
                    console.log(`‚úÖ –ù–ê–ô–î–ï–ù–ê –ì–†–£–ü–ü–ê: ${matchingGroup.name}`);
                    console.log(`   –î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ: ${matchingGroup.currentQuantity}–≥`);
                    console.log(`   –†–∞—Å—á–µ—Ç–Ω–æ–µ –º–∞–∫—Å. –∫–æ–ª-–≤–æ: ${Math.floor(matchingGroup.currentQuantity / clientProduct.weight)} —à—Ç.`);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
                    const expectedMaxQty = Math.floor(matchingGroup.currentQuantity / clientProduct.weight);
                    if (clientProduct.maxQuantity !== expectedMaxQty) {
                        console.log(`‚ö†Ô∏è  –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ï! –û–∂–∏–¥–∞–µ—Ç—Å—è: ${expectedMaxQty}, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏: ${clientProduct.maxQuantity}`);
                    } else {
                        console.log(`‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ`);
                    }
                } else {
                    console.log(`‚ùå –ì–†–£–ü–ü–ê –ù–ï –ù–ê–ô–î–ï–ù–ê –¥–ª—è warehouseLink: ${clientProduct.warehouseLink}`);
                    console.log(`   –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–ø–ø—ã:`);
                    window.clientProductGroups.forEach(group => {
                        const productCodes = group.products ? group.products.map(p => p.product.code).join(', ') : '–Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤';
                        console.log(`   - ${group.name}: –∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤ [${productCodes}]`);
                    });
                }
            });
            
            console.log('\n=== –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===');
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
        window.checkProductWarehouseConnection = checkProductWarehouseConnection;

        // ===== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê–ú–ò –î–õ–Ø –ê–î–ú–ò–ù–û–í =====

        function loadOrdersForAdmin() {
            console.log('=== –ó–ê–ì–†–£–ó–ö–ê –ó–ê–ö–ê–ó–û–í –î–õ–Ø –ê–î–ú–ò–ù–ê ===');
            
            const tableBody = document.getElementById('ordersTableBody');
            if (!tableBody) return;
            
            const allOrders = safeLocalStorage('get', 'clientOrders') || [];
            const allClients = safeLocalStorage('get', 'clients') || [];
            
            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤:', allOrders.length);
            
            if (allOrders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                updateOrdersStats([]);
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tableBody.innerHTML = allOrders.map(order => {
                const client = allClients.find(c => c.mb === order.clientMB);
                const clientName = client ? client.name : `–ö–ª–∏–µ–Ω—Ç ${order.clientMB}`;
                
                const statusBadge = order.status === 'accepted' 
                    ? '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">–ü—Ä–∏–Ω—è—Ç</span>'
                    : '<span style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 12px; font-size: 12px;">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>';
                
                const itemsText = order.items.map(item => `${item.name} (${item.quantity}—à—Ç)`).join(', ');
                const shortItemsText = itemsText.length > 40 ? itemsText.substring(0, 40) + '...' : itemsText;
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="order-checkbox-admin" data-order-id="${order.id}" ${order.status === 'accepted' ? 'disabled' : ''}>
                        </td>
                        <td>${order.number}</td>
                        <td>${new Date(order.date).toLocaleDateString('ru-RU')}</td>
                        <td>${clientName}</td>
                        <td title="${itemsText}">${shortItemsText}</td>
                        <td>${order.totalWithVAT.toFixed(2)} –†–°–î</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewOrderDetails('${order.id}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                üëÅÔ∏è
                            </button>
                            <button class="btn btn-sm btn-success" onclick="exportOrderToPDF('${order.id}')" title="PDF">
                                üìÑ
                            </button>
                            ${order.status === 'pending' ? 
                                `<button class="btn btn-sm btn-warning" onclick="acceptOrder('${order.id}')" title="–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑">‚úÖ</button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')" title="–£–¥–∞–ª–∏—Ç—å">‚ùå</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateOrdersStats(allOrders);
        }

        function updateOrdersStats(orders) {
            const totalCount = orders.length;
            const pendingCount = orders.filter(o => o.status === 'pending').length;
            const acceptedCount = orders.filter(o => o.status === 'accepted').length;
            const totalValue = orders.reduce((sum, o) => sum + o.totalWithVAT, 0);
            
            const elements = {
                totalOrdersCount: document.getElementById('totalOrdersCount'),
                pendingOrdersCount: document.getElementById('pendingOrdersCount'),
                acceptedOrdersCount: document.getElementById('acceptedOrdersCount'),
                totalOrdersValue: document.getElementById('totalOrdersValue'),
                ordersCount: document.getElementById('ordersCount')
            };
            
            if (elements.totalOrdersCount) elements.totalOrdersCount.textContent = totalCount;
            if (elements.pendingOrdersCount) elements.pendingOrdersCount.textContent = pendingCount;
            if (elements.acceptedOrdersCount) elements.acceptedOrdersCount.textContent = acceptedCount;
            if (elements.totalOrdersValue) elements.totalOrdersValue.textContent = `${totalValue.toFixed(2)} –†–°–î`;
            if (elements.ordersCount) elements.ordersCount.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${totalCount} –∑–∞–∫–∞–∑–æ–≤`;
        }

        function acceptOrder(orderId) {
            console.log('=== –ü–†–ò–ù–Ø–¢–ò–ï –ó–ê–ö–ê–ó–ê ===', orderId);
            
            const orders = safeLocalStorage('get', 'clientOrders') || [];
            const orderIndex = orders.findIndex(o => o.id == orderId);
            
            if (orderIndex === -1) {
                showAlert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
                return;
            }
            
            orders[orderIndex].status = 'accepted';
            orders[orderIndex].acceptedDate = new Date().toISOString();
            
            safeLocalStorage('set', 'clientOrders', orders);
            loadOrdersForAdmin();
            
            addLog(`–ü—Ä–∏–Ω—è—Ç –∑–∞–∫–∞–∑ ${orders[orderIndex].number}`);
            showAlert('–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!', 'success');
        }

        function acceptAllPendingOrders() {
            if (!confirm('–ü—Ä–∏–Ω—è—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã –≤ –æ–∂–∏–¥–∞–Ω–∏–∏?')) return;
            
            const orders = safeLocalStorage('get', 'clientOrders') || [];
            const pendingOrders = orders.filter(o => o.status === 'pending');
            
            if (pendingOrders.length === 0) {
                showAlert('–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏', 'warning');
                return;
            }
            
            pendingOrders.forEach(order => {
                order.status = 'accepted';
                order.acceptedDate = new Date().toISOString();
            });
            
            safeLocalStorage('set', 'clientOrders', orders);
            loadOrdersForAdmin();
            
            addLog(`–ü—Ä–∏–Ω—è—Ç–æ ${pendingOrders.length} –∑–∞–∫–∞–∑–æ–≤`);
            showAlert(`–ü—Ä–∏–Ω—è—Ç–æ ${pendingOrders.length} –∑–∞–∫–∞–∑–æ–≤!`, 'success');
        }

        function deleteOrder(orderId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
            
            let orders = safeLocalStorage('get', 'clientOrders') || [];
            const orderIndex = orders.findIndex(o => o.id == orderId);
            
            if (orderIndex === -1) {
                showAlert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
                return;
            }
            
            const deletedOrder = orders[orderIndex];
            orders.splice(orderIndex, 1);
            
            safeLocalStorage('set', 'clientOrders', orders);
            loadOrdersForAdmin();
            
            addLog(`–£–¥–∞–ª–µ–Ω –∑–∞–∫–∞–∑ ${deletedOrder.number}`);
            showAlert('–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω!', 'success');
        }

        function viewOrderDetails(orderId) {
            const orders = safeLocalStorage('get', 'clientOrders') || [];
            const order = orders.find(o => o.id == orderId);
            
            if (!order) {
                showAlert('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
                return;
            }
            
            const clients = safeLocalStorage('get', 'clients') || [];
            const client = clients.find(c => c.mb === order.clientMB);
            const clientName = client ? client.name : `–ö–ª–∏–µ–Ω—Ç ${order.clientMB}`;
            
            const itemsHTML = order.items.map((item, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.weight}–≥</td>
                    <td>${item.quantity}</td>
                    <td>${item.priceWithoutVAT.toFixed(2)} –†–°–î</td>
                    <td>${item.totalWithVAT.toFixed(2)} –†–°–î</td>
                </tr>
            `).join('');
            
            const detailsWindow = window.open('', '_blank', 'width=800,height=600');
            detailsWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ ${order.number}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .info { margin: 20px 0; padding: 15px; background-color: #f8f9fa; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ ${order.number}</h1>
                    </div>
                    
                    <div class="info">
                        <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${clientName}</p>
                        <p><strong>–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:</strong> ${new Date(order.date).toLocaleString('ru-RU')}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${order.status === 'accepted' ? '–ü—Ä–∏–Ω—è—Ç' : '–í –æ–∂–∏–¥–∞–Ω–∏–∏'}</p>
                        ${order.acceptedDate ? `<p><strong>–î–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∏—è:</strong> ${new Date(order.acceptedDate).toLocaleString('ru-RU')}</p>` : ''}
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>‚Ññ</th>
                                <th>–ö–æ–¥</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–í–µ—Å</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th>–¶–µ–Ω–∞ –±–µ–∑ –ù–î–°</th>
                                <th>–°—É–º–º–∞ —Å –ù–î–°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHTML}
                        </tbody>
                    </table>
                    
                    <div class="info">
                        <p><strong>–û–±—â–∞—è —Å—É–º–º–∞ –±–µ–∑ –ù–î–°:</strong> ${order.totalWithoutVAT.toFixed(2)} –†–°–î</p>
                        <p><strong>–ù–î–° (20%):</strong> ${(order.totalWithVAT - order.totalWithoutVAT).toFixed(2)} –†–°–î</p>
                        <p><strong>–ò–¢–û–ì–û —Å –ù–î–°:</strong> ${order.totalWithVAT.toFixed(2)} –†–°–î</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; font-size: 14px;">–ü–µ—á–∞—Ç—å</button>
                        <button onclick="window.close()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </body>
                </html>
            `);
            detailsWindow.document.close();
        }

        function filterOrders() {
            // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–ø–æ–∫–∞ –±–∞–∑–æ–≤–∞—è)
            loadOrdersForAdmin();
        }

        function clearOrderFilters() {
            document.getElementById('orderStatusFilter').value = '';
            document.getElementById('orderClientFilter').value = '';
            document.getElementById('orderFromDate').value = '';
            document.getElementById('orderToDate').value = '';
            loadOrdersForAdmin();
        }

        function refreshOrders() {
            loadOrdersForAdmin();
            showAlert('–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        }

        function toggleAllOrders(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.order-checkbox-admin:not([disabled])');
            checkboxes.forEach(checkbox => {
                checkbox.checked = masterCheckbox.checked;
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        function initOrdersTab() {
            if (document.getElementById('orders')) {
                loadOrdersForAdmin();
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        const originalShowTab = window.showTab;
        window.showTab = function(tabName, event) {
            originalShowTab(tabName, event);
            if (tabName === 'orders') {
                setTimeout(() => {
                    loadOrdersForAdmin();
                }, 100);
            }
        };
    </script>
</body>
</html>